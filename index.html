<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Shively's GearLog</title>

<!-- PWA Manifest (inline via data URI so this stays a single deployable HTML file) -->
<link rel="manifest" href="#">

<!-- iOS PWA support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GearLog">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%230a0e0a'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle'%3E‚öôÔ∏è%3C/text%3E%3C/svg%3E">

<!-- Android / theme -->
<meta name="theme-color" content="#0a0e0a">
<meta name="mobile-web-app-capable" content="yes">
<link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;500;600;700;800&family=Share+Tech+Mono&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e0a;
    --surface: #0f1510;
    --surface2: #141c14;
    --surface3: #1a2419;
    --border: #1f2e1f;
    --border-bright: #2d4a2d;
    --green: #4ade80;
    --green-dim: #22c55e;
    --green-dark: #16a34a;
    --green-glow: rgba(74,222,128,0.15);
    --green-pale: rgba(74,222,128,0.07);
    --amber: #fbbf24;
    --amber-pale: rgba(251,191,36,0.08);
    --red: #f87171;
    --red-pale: rgba(248,113,113,0.08);
    --text: #e2ffe2;
    --text-muted: #6b9e6b;
    --text-light: #3d6b3d;
    --shadow: 0 4px 32px rgba(0,0,0,0.6);
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.4);
    --radius: 4px;
    --font-head: 'Oxanium', sans-serif;
    --font-mono: 'Share Tech Mono', monospace;
    --font-body: 'Inter', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 0;
    /* Subtle grid texture */
    background-image:
      linear-gradient(rgba(74,222,128,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(74,222,128,0.03) 1px, transparent 1px);
    background-size: 32px 32px;
  }

  /* Scanline overlay */
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.03) 2px,
      rgba(0,0,0,0.03) 4px
    );
    pointer-events: none;
    z-index: 9999;
  }

  /* Header */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border-bright);
    padding: 20px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
    position: relative;
    overflow: hidden;
  }
  header::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--green), transparent);
  }
  .brand h1 {
    font-family: var(--font-head);
    font-size: 1.8rem;
    font-weight: 800;
    letter-spacing: 0.05em;
    color: var(--green);
    text-shadow: 0 0 20px rgba(74,222,128,0.4);
    text-transform: uppercase;
  }
  .brand p {
    font-family: var(--font-mono);
    font-size: 0.68rem;
    color: var(--text-muted);
    margin-top: 3px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }
  /* PWA install button */
  #pwaInstallBtn {
    display: none;
    background: transparent;
    color: var(--amber);
    border: 1px solid var(--amber);
    border-radius: var(--radius);
    padding: 9px 18px;
    font-family: var(--font-head);
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    animation: pulse-amber 2s infinite;
  }
  #pwaInstallBtn:hover {
    background: var(--amber-pale);
    box-shadow: 0 0 16px rgba(251,191,36,0.25);
  }
  @keyframes pulse-amber {
    0%, 100% { box-shadow: 0 0 0 0 rgba(251,191,36,0.3); }
    50% { box-shadow: 0 0 0 6px rgba(251,191,36,0); }
  }

  .btn-add-equipment {
    background: transparent;
    color: var(--green);
    border: 1px solid var(--green-dim);
    border-radius: var(--radius);
    padding: 9px 18px;
    font-family: var(--font-head);
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-add-equipment:hover {
    background: var(--green-glow);
    box-shadow: 0 0 16px rgba(74,222,128,0.2);
    border-color: var(--green);
  }

  /* Nav */
  .top-nav {
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    display: flex;
    padding: 0 24px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .top-nav::-webkit-scrollbar { display: none; }
  .top-nav-btn {
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    padding: 14px 20px;
    flex-shrink: 0;
    font-family: var(--font-head);
    font-size: 0.78rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    cursor: pointer;
    transition: color 0.15s, border-color 0.15s;
    white-space: nowrap;
  }
  .top-nav-btn.active { color: var(--green); border-bottom-color: var(--green); }
  .top-nav-btn:hover:not(.active) { color: var(--text); }

  /* Main layout */
  main { max-width: 1200px; margin: 0 auto; padding: 28px 24px; }

  /* Page views */
  .page-view { display: none; }
  .page-view.active { display: block; }

  /* Tables */
  .summary-table, .garage-table, .log-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }
  .summary-table th, .garage-table th, .log-table th {
    text-align: left;
    padding: 10px 14px;
    font-family: var(--font-mono);
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-light);
    background: var(--surface2);
    border-bottom: 1px solid var(--border-bright);
    white-space: nowrap;
  }
  .summary-table td, .garage-table td, .log-table td {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
    color: var(--text);
  }
  .summary-table tr:last-child td,
  .garage-table tr:last-child td,
  .log-table tr:last-child td { border-bottom: none; }
  .summary-table tbody tr, .garage-table tbody tr {
    cursor: pointer;
    transition: background 0.1s;
  }
  .summary-table tbody tr:hover td,
  .garage-table tbody tr:hover td { background: var(--green-pale); }
  .summary-table tr.active-row td,
  .garage-table tr.active td {
    background: rgba(74,222,128,0.06);
    border-left: 2px solid var(--green);
  }

  .equip-icon {
    font-size: 1.3rem;
    width: 34px; height: 34px;
    display: flex; align-items: center; justify-content: center;
    background: var(--surface3);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    flex-shrink: 0;
  }
  .card-name { font-family: var(--font-head); font-size: 0.9rem; font-weight: 600; letter-spacing: 0.03em; color: var(--text); }
  .card-sub { font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
  .stat-value { font-family: var(--font-mono); font-size: 0.9rem; color: var(--green); }
  .stat-label { font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.06em; }

  .card-btn {
    padding: 5px 10px;
    background: transparent;
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    cursor: pointer;
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--text-muted);
    transition: all 0.15s;
    white-space: nowrap;
    letter-spacing: 0.05em;
  }
  .card-btn:hover { background: var(--green-glow); color: var(--green); border-color: var(--green-dim); }

  /* Buttons */
  .btn {
    border: 1px solid transparent;
    border-radius: var(--radius);
    padding: 8px 16px;
    font-family: var(--font-head);
    font-weight: 600;
    font-size: 0.78rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn:hover { transform: translateY(-1px); }
  .btn-primary { background: var(--green-dark); color: #fff; border-color: var(--green-dim); }
  .btn-primary:hover { background: var(--green-dim); box-shadow: 0 0 16px rgba(74,222,128,0.25); }
  .btn-secondary { background: transparent; color: var(--text-muted); border: 1px solid var(--border-bright); }
  .btn-secondary:hover { color: var(--text); border-color: var(--text-muted); }
  .btn-danger { background: transparent; color: var(--red); border: 1px solid rgba(248,113,113,0.3); }
  .btn-danger:hover { background: var(--red-pale); }

  /* Detail panel */
  .detail-panel {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 28px;
    display: none;
    position: relative;
  }
  .detail-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--green-dim), transparent);
  }
  .detail-panel.visible { display: block; animation: slideIn 0.2s ease; }
  @keyframes slideIn { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }

  .detail-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 24px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 12px;
  }
  .detail-title { display: flex; align-items: center; gap: 14px; }
  .detail-title h2 {
    font-family: var(--font-head);
    font-size: 1.4rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--green);
  }
  .detail-title .sub { font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-muted); }
  .detail-actions { display: flex; gap: 8px; flex-wrap: wrap; }

  .modal-close {
    background: transparent;
    border: 1px solid var(--border-bright);
    color: var(--text-muted);
    width: 30px; height: 30px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.9rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .modal-close:hover { color: var(--red); border-color: var(--red); }

  /* Tabs */
  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    background: var(--surface2);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab {
    padding: 12px 18px;
    font-family: var(--font-mono);
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-light);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: color 0.15s, border-color 0.15s;
    white-space: nowrap;
  }
  .tab.active { color: var(--green); border-bottom-color: var(--green); }
  .tab:hover { color: var(--text-muted); }
  .tab-content { padding: 24px; display: none; }
  .tab-content.active { display: block; }

  /* Stats row */
  .stats-row { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
  .stat-card {
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    padding: 14px 20px;
    min-width: 100px;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: var(--green-dim);
    opacity: 0.4;
  }
  .stat-card .val { font-family: var(--font-mono); font-size: 1.4rem; color: var(--green); }
  .stat-card .lbl { font-family: var(--font-mono); font-size: 0.62rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.1em; margin-top: 3px; }

  /* Badges */
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 2px;
    font-family: var(--font-mono);
    font-size: 0.68rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  .badge-maintenance { background: rgba(74,222,128,0.1); color: var(--green-dim); border: 1px solid rgba(74,222,128,0.2); }
  .badge-parts { background: rgba(251,191,36,0.1); color: var(--amber); border: 1px solid rgba(251,191,36,0.2); }
  .badge-hours { background: rgba(148,163,184,0.1); color: #94a3b8; border: 1px solid rgba(148,163,184,0.2); }

  .section-label {
    font-family: var(--font-mono);
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-light);
    margin-bottom: 12px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }

  /* Service flags */
  .service-flag {
    display: inline-block;
    font-family: var(--font-mono);
    font-size: 0.68rem;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 2px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
  .flag-due { background: var(--red-pale); color: var(--red); border: 1px solid rgba(248,113,113,0.3); }
  .flag-soon { background: var(--amber-pale); color: var(--amber); border: 1px solid rgba(251,191,36,0.3); }

  /* Status dots */
  .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }
  .dot-ok { background: var(--green); box-shadow: 0 0 6px rgba(74,222,128,0.6); }
  .dot-warn { background: var(--amber); box-shadow: 0 0 6px rgba(251,191,36,0.5); }
  .dot-due { background: var(--red); box-shadow: 0 0 6px rgba(248,113,113,0.5); }

  /* Modals */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.visible { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow), 0 0 40px rgba(74,222,128,0.08);
    position: relative;
  }
  .modal::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--green-dim), transparent);
  }
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }
  .modal-header h3 {
    font-family: var(--font-head);
    font-size: 0.95rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--green);
  }
  .modal-body { padding: 20px; }
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 16px 20px;
    border-top: 1px solid var(--border);
  }

  .form-group { margin-bottom: 16px; }
  .form-group label {
    display: block;
    font-family: var(--font-mono);
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 6px;
  }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    padding: 9px 12px;
    font-family: var(--font-body);
    font-size: 0.88rem;
    color: var(--text);
    transition: border-color 0.15s, box-shadow 0.15s;
    outline: none;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    border-color: var(--green-dim);
    box-shadow: 0 0 0 2px rgba(74,222,128,0.1);
  }
  .form-group select option { background: var(--surface2); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

  /* Log table */
  .log-table tbody tr:hover td { background: var(--green-pale); }
  .no-logs {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-light);
    font-family: var(--font-mono);
    font-size: 0.8rem;
    letter-spacing: 0.05em;
  }
  .no-logs .icon { font-size: 2rem; margin-bottom: 8px; opacity: 0.4; }

  /* Shopping list */
  .shop-filters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 20px;
    align-items: center;
  }
  .shop-filter-btn {
    background: transparent;
    border: 1px solid var(--border-bright);
    border-radius: 2px;
    padding: 5px 12px;
    font-family: var(--font-mono);
    font-size: 0.7rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s;
    color: var(--text-muted);
  }
  .shop-filter-btn.active { background: var(--green-dark); border-color: var(--green-dim); color: #fff; }
  .shop-filter-btn:hover:not(.active) { border-color: var(--green-dim); color: var(--green); }

  .shop-section { margin-bottom: 20px; }
  .shop-section-title {
    font-family: var(--font-mono);
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-light);
    padding: 0 0 8px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .shop-item {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .shop-item:last-child { border-bottom: none; }
  .shop-check {
    width: 18px; height: 18px;
    border: 1px solid var(--border-bright);
    border-radius: 2px;
    flex-shrink: 0;
    margin-top: 2px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem;
    color: var(--bg);
  }
  .shop-check.checked { background: var(--green-dark); border-color: var(--green); color: var(--bg); }
  .shop-item-body { flex: 1; }
  .shop-item-name { font-family: var(--font-body); font-weight: 600; font-size: 0.88rem; margin-bottom: 2px; }
  .shop-item-meta { font-size: 0.76rem; color: var(--text-muted); }
  .shop-item-oem { font-family: var(--font-mono); font-size: 0.72rem; color: var(--amber); background: rgba(251,191,36,0.08); border: 1px solid rgba(251,191,36,0.2); border-radius: 2px; padding: 1px 6px; display: inline-block; margin-top: 4px; }
  .shop-item-where { font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-light); margin-top: 3px; }

  /* To-Do */
  .todo-equip-group {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    margin-bottom: 14px;
    overflow: hidden;
  }
  .todo-equip-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 18px;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
    transition: background 0.1s;
  }
  .todo-equip-header:hover { background: var(--surface3); }
  .todo-equip-title { font-family: var(--font-head); font-weight: 700; font-size: 0.88rem; letter-spacing: 0.06em; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
  .todo-equip-count { font-family: var(--font-mono); font-size: 0.65rem; background: var(--red); color: white; border-radius: 2px; padding: 2px 7px; letter-spacing: 0.05em; }
  .todo-equip-count.all-done { background: var(--green-dark); color: #fff; }
  .todo-equip-collapse { color: var(--text-light); font-size: 0.8rem; transition: transform 0.2s; }
  .todo-tasks { padding: 0 18px; }
  .todo-task { padding: 12px 0; border-bottom: 1px solid var(--border); }
  .todo-task:last-child { border-bottom: none; }
  .todo-task-header { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
  .todo-task-icon { font-size: 1rem; flex-shrink: 0; }
  .todo-task-name { font-family: var(--font-head); font-weight: 600; font-size: 0.85rem; letter-spacing: 0.03em; flex: 1; }
  .todo-task-badge { font-family: var(--font-mono); font-size: 0.62rem; padding: 2px 7px; border-radius: 2px; text-transform: uppercase; letter-spacing: 0.06em; }
  .badge-due { background: var(--red-pale); color: var(--red); border: 1px solid rgba(248,113,113,0.3); }
  .badge-soon { background: var(--amber-pale); color: var(--amber); border: 1px solid rgba(251,191,36,0.3); }
  .todo-task-detail { font-family: var(--font-mono); font-size: 0.72rem; color: var(--text-muted); margin-bottom: 8px; padding-left: 30px; }
  .todo-subtasks { display: flex; flex-direction: column; gap: 6px; padding-left: 30px; }
  .todo-subtask {
    display: flex; align-items: center; gap: 10px; cursor: pointer;
    padding: 6px 10px; border-radius: var(--radius); border: 1px solid var(--border);
    background: var(--surface2); transition: all 0.12s; user-select: none;
  }
  .todo-subtask:hover { border-color: var(--green-dim); background: var(--green-pale); }
  .todo-subtask.done { background: rgba(74,222,128,0.04); border-color: rgba(74,222,128,0.15); }
  .todo-subtask.done .todo-subtask-label { text-decoration: line-through; color: var(--text-light); }
  .todo-subtask-check {
    width: 16px; height: 16px; border: 1px solid var(--border-bright); border-radius: 2px;
    flex-shrink: 0; display: flex; align-items: center; justify-content: center;
    font-size: 0.65rem; transition: all 0.12s;
  }
  .todo-subtask.done .todo-subtask-check { background: var(--green-dark); border-color: var(--green); color: #fff; }
  .todo-subtask-label { font-family: var(--font-mono); font-size: 0.78rem; letter-spacing: 0.04em; }
  .todo-progress {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 18px; background: rgba(74,222,128,0.03); border-top: 1px solid var(--border);
    font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted); letter-spacing: 0.06em;
  }
  .todo-progress-bar-wrap { flex: 1; height: 3px; background: var(--border-bright); border-radius: 0; overflow: hidden; }
  .todo-progress-bar { height: 100%; background: var(--green-dim); transition: width 0.3s; box-shadow: 0 0 8px rgba(74,222,128,0.4); }

  /* Page headers */
  .section-heading {
    font-family: var(--font-head);
    font-size: 1.2rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--green);
    margin-bottom: 4px;
  }
  .section-sub {
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--text-muted);
    letter-spacing: 0.05em;
    margin-bottom: 20px;
  }
  .page-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 20px;
  }

  /* Empty state */
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
  .empty-state .big-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.3; }
  .empty-state h3 { font-family: var(--font-head); font-size: 1.2rem; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
  .empty-state p { font-family: var(--font-mono); font-size: 0.78rem; color: var(--text-light); margin-bottom: 20px; }

  /* Reminder cards */
  .reminders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .reminder-card {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    padding: 14px 16px;
    display: flex;
    gap: 12px;
    align-items: flex-start;
  }
  .reminder-card.status-due { border-color: rgba(248,113,113,0.4); background: var(--red-pale); }
  .reminder-card.status-soon { border-color: rgba(251,191,36,0.3); background: var(--amber-pale); }
  .reminder-card.status-ok { border-color: rgba(74,222,128,0.2); background: var(--green-pale); }
  .reminder-icon { font-size: 1.2rem; flex-shrink: 0; margin-top: 2px; }
  .reminder-equip { font-family: var(--font-mono); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-light); margin-bottom: 3px; }
  .reminder-task { font-family: var(--font-head); font-weight: 600; font-size: 0.88rem; letter-spacing: 0.03em; margin-bottom: 3px; }
  .reminder-detail { font-family: var(--font-mono); font-size: 0.72rem; color: var(--text-muted); }
  .reminder-status { display: inline-block; margin-top: 5px; font-family: var(--font-mono); font-size: 0.62rem; font-weight: 700; padding: 2px 7px; border-radius: 2px; text-transform: uppercase; letter-spacing: 0.06em; }
  .status-due .reminder-status { background: var(--red); color: #fff; }
  .status-soon .reminder-status { background: var(--amber); color: var(--bg); }
  .status-ok .reminder-status { background: var(--green-dark); color: #fff; }

  @media (max-width: 600px) {
    header { padding: 16px 20px; }
    .brand h1 { font-size: 1.4rem; }
    main { padding: 16px; }
    .form-row { grid-template-columns: 1fr; }
    .detail-header { padding: 14px 16px; }
    .tab-content { padding: 16px; }
    .tabs { padding: 0 4px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .tab { flex-shrink: 0; }
    .top-nav { padding: 0 4px; }
    .top-nav-btn { padding: 10px 14px; font-size: 0.72rem; flex-shrink: 0; white-space: nowrap; }
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <h1>‚õΩ Shively's GearLog</h1>
    <p>Gas-Powered Lawn Equipment Tracker</p>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <button id="pwaInstallBtn" onclick="installPWA()">‚¨á Install App</button>
    <button class="btn-add-equipment" onclick="openAddEquipment()">+ Add Equipment</button>
  </div>
</header>

<nav class="top-nav">
  <button class="top-nav-btn active" id="nav-garage" onclick="switchPage('garage')">üè† Garage</button>
  <button class="top-nav-btn" id="nav-reminders" onclick="switchPage('reminders')">‚úÖ To-Do <span id="reminderBadge" style="display:none;background:#e04e4e;color:white;border-radius:10px;padding:1px 7px;font-size:0.72rem;margin-left:4px;"></span></button>
  <button class="top-nav-btn" id="nav-shopping" onclick="switchPage('shopping')">üõí Shopping List</button>
</nav>

<main>

  <!-- ===== GARAGE PAGE ===== -->
  <div class="page-view active" id="page-garage">
    <div style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-sm);margin-bottom:24px">
      <table class="summary-table" id="equipmentGrid">
        <thead><tr>
          <th>Equipment</th>
          <th>Status</th>
          <th>Hours</th>
          <th>Last Service</th>
          <th>Actions</th>
        </tr></thead>
        <tbody id="equipmentGridBody"></tbody>
      </table>
    </div>

    <!-- Detail Panel -->
    <div class="detail-panel" id="detailPanel">
      <div class="detail-header">
        <div class="detail-title">
          <span id="detailIcon" style="font-size:2rem"></span>
          <div>
            <h2 id="detailName"></h2>
            <div class="sub" id="detailSub"></div>
          </div>
        </div>
        <div class="detail-actions">
          <button class="btn btn-primary" onclick="openLogMaintenance()">+ Maintenance</button>
          <button class="btn btn-primary" onclick="openLogHours()">+ Hours</button>
          <button class="btn btn-primary" onclick="openLogPart()">+ Parts/Cost</button>
          <button class="btn btn-danger" onclick="deleteCurrentEquipment()">Delete</button>
          <button class="modal-close" onclick="closeDetailPanel()" title="Close" style="margin-left:8px">‚úï</button>
        </div>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="switchTab('overview')">Overview</div>
        <div class="tab" onclick="switchTab('maintenance')">Maintenance</div>
        <div class="tab" onclick="switchTab('hours')">Runtime Hours</div>
        <div class="tab" onclick="switchTab('parts')">Parts & Costs</div>
      </div>

      <!-- Overview -->
      <div class="tab-content active" id="tab-overview">
        <div class="stats-row" id="overviewStats"></div>
        <div id="equipNotes" style="display:none; background:var(--amber-pale); border:1.5px solid var(--border); border-radius:10px; padding:14px 18px; margin-bottom:20px; font-size:0.86rem; line-height:1.6; color:var(--text-muted);">
          <div style="font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.07em; color:var(--amber); margin-bottom:6px;">üìã Part Numbers &amp; Notes</div>
          <span id="equipNotesText"></span>
        </div>
        <div class="section-label">Recent Activity</div>
        <table class="log-table" id="recentActivity">
          <thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Cost</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Maintenance -->
      <div class="tab-content" id="tab-maintenance">
        <table class="log-table" id="maintenanceTable">
          <thead><tr><th>Date</th><th>Type</th><th>Notes</th><th>Next Due</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Hours -->
      <div class="tab-content" id="tab-hours">
        <table class="log-table" id="hoursTable">
          <thead><tr><th>Date</th><th>Hours Added</th><th>Total Hours</th><th>Notes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Parts -->
      <div class="tab-content" id="tab-parts">
        <div id="partsContent"></div>
      </div>
    </div>
  </div><!-- /page-garage -->



  <!-- ===== REMINDERS PAGE ===== -->
  <div class="page-view" id="page-reminders">
    <div class="page-header">
      <div>
        <div class="section-heading">Maintenance To-Do</div>
        <div class="section-sub">Everything that needs attention ‚Äî check off sub-tasks as you order and install each part.</div>
      </div>
      <div style="display:flex;gap:8px;flex-shrink:0">
        <button class="btn btn-secondary" onclick="collapseAllTodo()">Collapse All</button>
        <button class="btn btn-secondary" onclick="clearTodo()">Clear Completed</button>
      </div>
    </div>
    <div id="remindersContent"></div>
  </div><!-- /page-reminders -->

  <!-- ===== SHOPPING LIST PAGE ===== -->
  <div class="page-view" id="page-shopping">
    <div class="page-header">
      <div>
        <div class="section-heading">Shopping List</div>
        <div class="section-sub">OEM parts reference for all your equipment. Check items off as you buy them.</div>
      </div>
      <div style="display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap">
        <button class="btn btn-secondary" onclick="collapseAllShop()">Collapse All</button>
        <button class="btn btn-secondary" onclick="clearChecked()">Clear Checked</button>
        <button class="btn btn-primary" onclick="openAmazonExport()">üì¶ Export Shopping List</button>
      </div>
    </div>
    <div class="shop-filters">
      <span style="font-size:0.8rem;color:var(--text-muted);font-weight:600;">Filter:</span>
      <button class="shop-filter-btn active" onclick="setShopFilter('all', this)">All Equipment</button>
      <button class="shop-filter-btn" onclick="setShopFilter('filter', this)">üî¥ Filters</button>
      <button class="shop-filter-btn" onclick="setShopFilter('plug', this)">‚ö° Spark Plugs</button>
      <button class="shop-filter-btn" onclick="setShopFilter('oil', this)">üõ¢ Oil &amp; Fluids</button>
      <button class="shop-filter-btn" onclick="setShopFilter('belt', this)">‚öôÔ∏è Belts &amp; Blades</button>
    </div>
    <div id="shoppingContent"></div>
  </div><!-- /page-shopping -->

</main>

<!-- Add Equipment Modal -->
<div class="modal-overlay" id="modalAddEquipment">
  <div class="modal">
    <div class="modal-header">
      <h3>Add Equipment</h3>
      <button class="modal-close" onclick="closeModal('modalAddEquipment')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Equipment Name</label>
        <input type="text" id="newEquipName" placeholder="e.g. Honda Mower, Husqvarna 450X">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Type</label>
          <select id="newEquipType">
            <option value="üåø Lawn Mower">üåø Lawn Mower</option>
            <option value="‚úÇÔ∏è String Trimmer">‚úÇÔ∏è String Trimmer</option>
            <option value="üçÇ Leaf Blower">üçÇ Leaf Blower</option>
            <option value="ü™ö Chainsaw">ü™ö Chainsaw</option>
            <option value="üå± Tiller">üå± Tiller</option>
            <option value="üöú Riding Mower">üöú Riding Mower</option>
            <option value="‚öôÔ∏è Generator">‚öôÔ∏è Generator</option>
            <option value="üîß Other">üîß Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Year</label>
          <input type="number" id="newEquipYear" placeholder="2022" min="1970" max="2030">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Engine (cc or HP)</label>
          <input type="text" id="newEquipEngine" placeholder="e.g. 160cc, 6HP">
        </div>
        <div class="form-group">
          <label>Serial / Model #</label>
          <input type="text" id="newEquipSerial" placeholder="Optional">
        </div>
      </div>
      <div class="form-group">
        <label>Purchase Date</label>
        <input type="date" id="newEquipDate">
      </div>
      <div class="form-group">
        <label>Oil Change Interval (hours)</label>
        <input type="number" id="newEquipOilInterval" placeholder="50" value="50">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalAddEquipment')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEquipment()">Add Equipment</button>
    </div>
  </div>
</div>

<!-- Log Maintenance Modal -->
<div class="modal-overlay" id="modalMaintenance">
  <div class="modal">
    <div class="modal-header">
      <h3>Log Maintenance</h3>
      <button class="modal-close" onclick="closeModal('modalMaintenance')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="mDate">
      </div>
      <div class="form-group">
        <label>Maintenance Type</label>
        <select id="mType">
          <option>Oil Change</option>
          <option>Air Filter</option>
          <option>Spark Plug</option>
          <option>Blade Sharpen</option>
          <option>Blade Replace</option>
          <option>Carburetor Clean</option>
          <option>Fuel Filter</option>
          <option>Tune-Up</option>
          <option>Belt Replace</option>
          <option>Cable Adjust</option>
          <option>Chain Sharpen</option>
          <option>Chain Lubrication</option>
          <option>Storage Prep</option>
          <option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="mNotes" rows="2" placeholder="Any details..."></textarea>
      </div>
      <div class="form-group">
        <label>Next Service Due (date or hours)</label>
        <input type="text" id="mNextDue" placeholder="e.g. 2025-09-01 or 100hrs">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalMaintenance')">Cancel</button>
      <button class="btn btn-primary" onclick="saveMaintenance()">Save</button>
    </div>
  </div>
</div>

<!-- Log Hours Modal -->
<div class="modal-overlay" id="modalHours">
  <div class="modal">
    <div class="modal-header">
      <h3>Log Runtime Hours</h3>
      <button class="modal-close" onclick="closeModal('modalHours')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="hDate">
        </div>
        <div class="form-group">
          <label>Hours Added</label>
          <input type="number" id="hHours" step="0.5" min="0" placeholder="2.5">
        </div>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="hNotes" rows="2" placeholder="What did you do?"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalHours')">Cancel</button>
      <button class="btn btn-primary" onclick="saveHours()">Save</button>
    </div>
  </div>
</div>

<!-- Log Part Modal -->
<div class="modal-overlay" id="modalPart">
  <div class="modal">
    <div class="modal-header">
      <h3>Log Part / Cost</h3>
      <button class="modal-close" onclick="closeModal('modalPart')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="pDate">
      </div>
      <div class="form-group">
        <label>Part / Item</label>
        <input type="text" id="pPart" placeholder="e.g. Air filter, Oregon blade, oil...">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Cost ($)</label>
          <input type="number" id="pCost" step="0.01" min="0" placeholder="12.99">
        </div>
        <div class="form-group">
          <label>Where Purchased</label>
          <input type="text" id="pWhere" placeholder="Home Depot, Amazon...">
        </div>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="pNotes" rows="2" placeholder="Part numbers, details..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalPart')">Cancel</button>
      <button class="btn btn-primary" onclick="savePart()">Save</button>
    </div>
  </div>
</div>

<!-- Amazon Export Modal -->
<div class="modal-overlay" id="modalAmazonExport">
  <div class="modal" style="max-width:560px;width:100%">
    <div class="modal-header">
      <h3>üì¶ Shopping List Export</h3>
      <button class="modal-close" onclick="closeModal('modalAmazonExport')">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="font-size:0.84rem;color:var(--text-muted);margin-bottom:16px">Your checked items ‚Äî ready to shop. Use the Amazon buttons in the list to search directly, or copy this list as a reference.</p>
      <textarea id="amazonExportText" readonly style="width:100%;height:320px;font-family:'DM Mono',monospace;font-size:0.78rem;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:12px;resize:none;line-height:1.7;color:var(--text)"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalAmazonExport')">Close</button>
      <button class="btn btn-primary" id="copyExportBtn" onclick="copyAmazonExport()">üìã Copy to Clipboard</button>
    </div>
  </div>
</div>

<script>
// ---------- Data ----------
function load() {
  return JSON.parse(localStorage.getItem('gearlog') || '{"equipment":[]}');
}
function save(data) {
  localStorage.setItem('gearlog', JSON.stringify(data));
}

let currentEquipId = null;
let currentTab = 'overview';

// ---------- Seed demo data if empty ----------
function seedDemo() {
  const data = load();
  // Re-seed if data exists but has no maintenance records (stale data from earlier version)
  const hasMaintenance = data.equipment && data.equipment.some(e => e.maintenance && e.maintenance.length > 0);
  if (data.equipment.length > 0 && hasMaintenance) return;
  // Clear stale data and re-seed
  localStorage.removeItem('gearlog');
  const demo = {
    equipment: [
      {
        id: 'e1',
        name: 'Stihl MS 171 Chainsaw',
        type: 'ü™ö Chainsaw',
        year: '',
        engine: '31.8cc 2-stroke',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        notes: 'Fuel: 50:1 mix. Parts: Air Filter #1139-120-1602, Fuel Filter #0000-350-3503, Spark Plug CMR6H #0000-400-7015. Gap: 0.020". Service Kit available. Chain: sharpen every fill-up on dirty wood.',
        maintenance: [
          { id: 'm1a', date: '2024-02-10', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm1b', date: '2024-02-10', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm1c', date: '2024-02-10', type: 'Fuel Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm1d', date: '2023-10-01', type: 'Spark Plug', notes: 'From prior log', nextDue: '' },
          { id: 'm1e', date: '2023-10-01', type: 'Air Filter', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h1a', date: '2024-02-10', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h1b', date: '2024-06-20', hours: 8, notes: 'Spring brush clearing', total: 13 },
          { id: 'h1c', date: '2024-10-18', hours: 7, notes: 'Fall firewood', total: 20 },
        ],
        parts: [
          { id: 'p1a', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #1139-120-1602 ‚Äî fleece type, fits MS171/MS181/MS211' },
          { id: 'p1b', date: '2025-01-01', part: 'Fuel Filter (Pickup Body)', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #0000-350-3503 ‚Äî replace annually or if rough running' },
          { id: 'p1c', date: '2025-01-01', part: 'Spark Plug NGK CMR6H', cost: 0, where: 'Stihl Dealer / Amazon / AutoZone', notes: 'OEM #0000-400-7015 ‚Äî NGK CMR6H (part# 3365). Gap: 0.020". Replace annually.' },
          { id: 'p1d', date: '2025-01-01', part: 'Service Kit (all 3 parts)', cost: 0, where: 'Stihl Dealer', notes: 'OEM Kit #1139-007-1800 ‚Äî bundles air filter, fuel filter, spark plug' }
        ],
        totalHours: 20
      },
      {
        id: 'e2',
        name: 'Stihl MS 251 Chainsaw',
        type: 'ü™ö Chainsaw',
        year: '',
        engine: '45.6cc 2-stroke',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        notes: 'Fuel: 50:1 mix. Parts: Air Filter #1141-120-1600, Fuel Filter #0000-350-3518, Spark Plug NGK BPMR7A #0000-400-7000. Same filter family as MS271 ‚Äî buy in bulk.',
        maintenance: [
          { id: 'm2a', date: '2024-02-10', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm2b', date: '2024-02-10', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm2c', date: '2024-02-10', type: 'Fuel Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm2d', date: '2023-10-01', type: 'Spark Plug', notes: 'From prior log', nextDue: '' },
          { id: 'm2e', date: '2023-10-01', type: 'Air Filter', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h2a', date: '2024-02-10', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h2b', date: '2024-07-10', hours: 10, notes: 'Summer storm cleanup', total: 15 },
          { id: 'h2c', date: '2024-11-05', hours: 8, notes: 'Firewood season', total: 23 },
        ],
        parts: [
          { id: 'p2a', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #1141-120-1600 ‚Äî same as MS271. Fits MS231/251/261/271/291/311/391.' },
          { id: 'p2b', date: '2025-01-01', part: 'Fuel Filter (Pickup Body)', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #0000-350-3518 ‚Äî orange/red filter body. Same as MS271.' },
          { id: 'p2c', date: '2025-01-01', part: 'Spark Plug NGK BPMR7A', cost: 0, where: 'Stihl Dealer / NGK / Amazon', notes: 'OEM #0000-400-7000 ‚Äî NGK BPMR7A. Same as MS271. Replace annually.' }
        ],
        totalHours: 23
      },
      {
        id: 'e3',
        name: 'Stihl MS 271 Chainsaw',
        type: 'ü™ö Chainsaw',
        year: '',
        engine: '50.2cc 2-stroke',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        notes: 'Fuel: 50:1 mix. Parts: Air Filter #1141-120-1600, Fuel Filter #0000-350-3518, Spark Plug NGK BPMR7A #0000-400-7000. Same filter family as MS251 ‚Äî buy in bulk.',
        maintenance: [
          { id: 'm3a', date: '2024-02-10', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm3b', date: '2024-02-10', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm3c', date: '2024-02-10', type: 'Fuel Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm3d', date: '2023-09-01', type: 'Spark Plug', notes: 'New ‚Äî from prior log', nextDue: '' },
          { id: 'm3e', date: '2023-09-01', type: 'Air Filter', notes: 'New ‚Äî from prior log', nextDue: '' },
          { id: 'm3f', date: '2023-10-01', type: 'Fuel Filter', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h3a', date: '2024-02-10', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h3b', date: '2024-07-15', hours: 12, notes: 'Tree work', total: 17 },
          { id: 'h3c', date: '2024-11-20', hours: 9, notes: 'Winter wood prep', total: 26 },
        ],
        parts: [
          { id: 'p3a', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #1141-120-1600 ‚Äî same as MS251. Fits MS231/251/261/271/291/311/391.' },
          { id: 'p3b', date: '2025-01-01', part: 'Fuel Filter (Pickup Body)', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #0000-350-3518 ‚Äî orange/red filter body. Same as MS251.' },
          { id: 'p3c', date: '2025-01-01', part: 'Spark Plug NGK BPMR7A', cost: 0, where: 'Stihl Dealer / NGK / Amazon', notes: 'OEM #0000-400-7000 ‚Äî NGK BPMR7A. Same as MS251. Replace annually.' },
          { id: 'p3d', date: '2025-01-01', part: 'Service Kit (all 3 parts)', cost: 0, where: 'Stihl Dealer', notes: 'OEM Kit #1141-007-1800 ‚Äî bundles air filter, fuel filter, spark plug for MS261/271/291/311/391.' }
        ],
        totalHours: 26
      },
      {
        id: 'e10',
        name: 'Tow-Behind Leaf Vac',
        type: 'üçÇ Leaf Blower',
        year: '2015',
        engine: 'Vanguard 6.5HP 205cc OHV',
        serial: '15 0406 88 06338',
        purchaseDate: '',
        oilInterval: 'annual',
        trackHours: true,
        notes: 'Engine: B&S Vanguard 200 Series, 205cc single-cylinder OHV (mfg April 2015). Oil: Vanguard 15W-50 Full Synthetic (~18-20oz). Spark Plug: B&S #597383. Air Filter: #596760. Official Maintenance Kit #84006008 includes all parts + Sta-Bil. Change oil at first 5hrs break-in, then every 50hrs or annually.',
        maintenance: [
          { id: 'm10a', date: '2024-03-15', type: 'Oil Change', notes: 'Break-in oil change ‚Äî Vanguard 15W-50 Full Synthetic', nextDue: '' },
          { id: 'm10b', date: '2024-03-15', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm10c', date: '2024-03-15', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm10d', date: '2023-03-10', type: 'Oil Change', notes: 'From prior log (Cyclone)', nextDue: '' },
          { id: 'm10e', date: '2023-03-10', type: 'Spark Plug', notes: 'From prior log (Cyclone)', nextDue: '' },
          { id: 'm10f', date: '2023-03-10', type: 'Air Filter', notes: 'From prior log (Cyclone)', nextDue: '' },
        ],
        hours: [
          { id: 'h10a', date: '2024-03-15', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h10b', date: '2024-10-25', hours: 8, notes: 'Fall leaf cleanup', total: 13 },
          { id: 'h10c', date: '2024-11-10', hours: 7, notes: 'Late fall cleanup', total: 22.5 },
        ],
        parts: [
          { id: 'p10a', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Briggs & Stratton / Amazon', notes: 'OEM #596760 ‚Äî cartridge-style, fits all Vanguard 200 Series single-cylinder engines (12V332/336/337/352/367).' },
          { id: 'p10b', date: '2025-01-01', part: 'Spark Plug', cost: 0, where: 'Briggs & Stratton / Amazon', notes: 'OEM #597383 ‚Äî fits Vanguard 200 Series (10V/12V/19V/25V series). Replace annually.' },
          { id: 'p10c', date: '2025-01-01', part: 'Engine Oil ‚Äî Vanguard 15W-50 Full Synthetic', cost: 0, where: 'Briggs & Stratton / Amazon', notes: 'OEM #100169 ‚Äî 1 qt bottle. MUST use Vanguard 15W-50, NOT standard SAE 30. ~18-20oz capacity.' },
          { id: 'p10d', date: '2025-01-01', part: 'Maintenance Kit (air filter + plug + oil + Sta-Bil)', cost: 0, where: 'Briggs & Stratton / Amazon', notes: 'OEM Kit #84006008 ‚Äî Vanguard 200 Series single-cylinder. Includes #596760 air filter, #597383 spark plug, 15W-50 oil, Sta-Bil.' }
        ],
        totalHours: 22.5
      },
      {
        id: 'e4',
        name: 'Echo ES-250 Shred-N-Vac',
        type: 'üçÇ Leaf Blower',
        year: '',
        engine: '25.4cc 2-stroke',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        notes: 'Fuel: 50:1 mix. Parts: Air Filter #A226-001410, Fuel Filter #A369-000480, Spark Plug NGK BPM8Y #15901019830. Echo Tune-Up Kit #90152Y includes all three. Replace spark plug & filters annually.',
        maintenance: [
          { id: 'm4a', date: '2024-02-10', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm4b', date: '2024-02-10', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm4c', date: '2024-02-10', type: 'Fuel Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm4d', date: '2023-10-01', type: 'Spark Plug', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h4a', date: '2024-02-10', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h4b', date: '2024-10-22', hours: 6, notes: 'Fall leaf cleanup', total: 11 },
          { id: 'h4c', date: '2024-11-08', hours: 5, notes: 'Late fall cleanup', total: 16 },
        ],
        parts: [
          { id: 'p4a', date: '2025-01-01', part: 'Air Filter (Double Layer)', cost: 0, where: 'Echo Dealer / Amazon / Home Depot', notes: 'OEM #A226001410 ‚Äî double-layer filter. Fits ES-250/ES-252, PB-250/PB-250LN, SRM-225, GT-225 and similar.' },
          { id: 'p4b', date: '2025-01-01', part: 'Fuel Filter', cost: 0, where: 'Echo Dealer / Amazon', notes: 'OEM #A369000480 ‚Äî fits inside fuel tank. Replace annually.' },
          { id: 'p4c', date: '2025-01-01', part: 'Spark Plug NGK BPM8Y', cost: 0, where: 'Echo Dealer / NGK / Amazon', notes: 'OEM #15901019830 ‚Äî NGK BPM8Y. Replace annually. Do not substitute with BPM7E (wrong heat range for ES-250).' },
          { id: 'p4d', date: '2025-01-01', part: 'Tune-Up Kit (all 3 parts)', cost: 0, where: 'Echo Dealer / Home Depot', notes: 'OEM Kit #90152Y ‚Äî includes air filter, fuel filter, spark plug. Fits ES-250, PB-250LN, SRM-225 and compatible models.' }
        ],
        totalHours: 16
      },
      {
        id: 'e5',
        name: 'Pressure Washer 2800 PSI',
        type: '‚öôÔ∏è Generator',
        year: '',
        engine: 'B&S 190cc OHV 8.5HP',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        notes: 'Engine oil: SAE 30 or 10W-30, ~20oz capacity. Spark Plug: NGK BPR6ES #796112, gap 0.030". Air Filter #591334. ALSO: Check pump oil (non-detergent SAE 30, 4-6oz) seasonally. Flush pump with clean water after every use. Winterize: drain ALL water from pump to prevent freeze damage.',
        maintenance: [
          { id: 'm5a', date: '2024-03-01', type: 'Oil Change', notes: 'Break-in oil change ‚Äî SAE 30', nextDue: '' },
          { id: 'm5b', date: '2024-03-01', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm5c', date: '2024-03-01', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm5d', date: '2023-05-27', type: 'Oil Change', notes: 'From prior log', nextDue: '' },
          { id: 'm5e', date: '2023-05-27', type: 'Air Filter', notes: 'From prior log', nextDue: '' },
          { id: 'm5f', date: '2023-06-02', type: 'Grease / Lube', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h5a', date: '2024-03-01', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h5b', date: '2024-05-12', hours: 4, notes: 'Deck and driveway wash', total: 9 },
          { id: 'h5c', date: '2024-08-20', hours: 6, notes: 'House exterior wash', total: 15 },
        ],
        parts: [
          { id: 'p5a', date: '2025-01-01', part: 'Spark Plug NGK BPR6ES', cost: 0, where: 'Briggs & Stratton / NGK / Amazon', notes: 'OEM #796112 (B&S) ‚Äî NGK BPR6ES. Gap: 0.030". Fits B&S 190cc pressure washer engines.' },
          { id: 'p5b', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Briggs & Stratton / Amazon', notes: 'OEM #591334 ‚Äî fits B&S 190cc OHV pressure washer engine. Replace annually.' },
          { id: 'p5c', date: '2025-01-01', part: 'Pump Oil (non-detergent SAE 30)', cost: 0, where: 'Hardware store / Amazon', notes: 'Non-detergent SAE 30 pump oil, ~4-6oz capacity. Check seasonally. Do NOT use motor oil with detergents.' }
        ],
        totalHours: 15
      },
      {
        id: 'e6',
        name: 'Lawn Mower (B&S EXi625)',
        type: 'üåø Lawn Mower',
        year: '',
        engine: 'B&S EXi625 150cc OHV',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        notes: 'NO OIL CHANGES NEEDED ‚Äî EXi series is check & add only. Use SAE 30 or 5W-30 synthetic. Parts: Spark Plug #692051 / 496018S (NGK BKR5E), Air Filter #593260. Maintenance Kit #84002441 includes both plus oil. Replace air filter & spark plug annually.',
        maintenance: [
          { id: 'm6a', date: '2024-04-01', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm6c', date: '2022-05-01', type: 'Spark Plug', notes: 'New ‚Äî from prior log', nextDue: '' },
          { id: 'm6b', date: '2024-04-01', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
        ],
        hours: [
          { id: 'h6a', date: '2024-04-01', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h6b', date: '2024-05-10', hours: 4, notes: 'Spring mowing', total: 9 },
          { id: 'h6c', date: '2024-07-14', hours: 4, notes: 'Summer mowing', total: 13 },
          { id: 'h6d', date: '2024-09-22', hours: 4, notes: 'Fall mowing', total: 17 },
        ],
        parts: [
          { id: 'p6a', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Briggs & Stratton / Home Depot / Amazon', notes: 'OEM #593260 ‚Äî fits B&S EX/EXi 500E/550E/625EX/675EX/725EXi series. Replace annually.' },
          { id: 'p6b', date: '2025-01-01', part: 'Spark Plug', cost: 0, where: 'Briggs & Stratton / Home Depot / Amazon', notes: 'OEM #692051 (also sold as #496018S) ‚Äî NGK BKR5E equivalent. Replace annually. NOTE: EXi625 does NOT require oil changes ‚Äî check & add only.' },
          { id: 'p6c', date: '2025-01-01', part: 'Maintenance Kit (filter + plug + oil)', cost: 0, where: 'Briggs & Stratton / Tractor Supply', notes: 'OEM Kit #84002441 ‚Äî for EX/EXi Series engines. Includes #593260 air filter, #496018S spark plug, 18oz SAE 30 oil.' }
        ],
        totalHours: 17
      },
      {
        id: 'e7',
        name: 'Champion 27-Ton Log Splitter',
        type: '‚öôÔ∏è Generator',
        year: '',
        engine: 'Champion 224cc OHV',
        serial: '',
        purchaseDate: '',
        oilInterval: 'annual',
        trackHours: true,
        notes: 'Engine oil: 10W-30, ~0.6qt. Spark Plug: F6RTC #100009378, gap 0.028-0.031". Air Filter: foam/washable ‚Äî clean with soap & water, re-oil. HYDRAULIC SYSTEM: AW46 fluid, ~4.5 gal tank. Change hydraulic filter at first 50hrs then annually. Retract ram fully before storage to protect rod.',
        maintenance: [
          { id: 'm7a', date: '2024-01-20', type: 'Oil Change', notes: 'Break-in oil change ‚Äî 10W-30', nextDue: '' },
          { id: 'm7b', date: '2024-01-20', type: 'Air Filter', notes: 'Break-in service ‚Äî foam cleaned', nextDue: '' },
          { id: 'm7c', date: '2024-01-20', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm7d', date: '2021-11-22', type: 'Oil Change', notes: 'From prior log', nextDue: '' },
          { id: 'm7e', date: '2021-11-22', type: 'Spark Plug', notes: 'From prior log', nextDue: '' },
          { id: 'm7f', date: '2021-11-22', type: 'Air Filter', notes: 'From prior log', nextDue: '' },
          { id: 'm7g', date: '2022-09-02', type: 'Hydraulic Oil', notes: 'From prior log', nextDue: '' },
          { id: 'm7h', date: '2022-09-03', type: 'Hydraulic Filter', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h7a', date: '2024-01-20', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h7b', date: '2024-02-15', hours: 8, notes: 'Firewood splitting', total: 13 },
          { id: 'h7c', date: '2024-11-10', hours: 10, notes: 'Winter wood prep', total: 23 },
          { id: 'h7d', date: '2025-01-05', hours: 8, notes: 'Winter splitting run', total: 59.6 },
        ],
        parts: [
          { id: 'p7a', date: '2025-01-01', part: 'Spark Plug F6RTC', cost: 0, where: 'Champion Power Equipment / Amazon', notes: 'OEM #100009378 ‚Äî F6RTC (NHSP). Alt: NGK BPR6ES. Gap: 0.028-0.031". Replace annually.' },
          { id: 'p7b', date: '2025-01-01', part: 'Air Filter (foam)', cost: 0, where: 'Champion Power Equipment / Amazon', notes: 'Foam/pre-cleaner style ‚Äî washable. Clean with soap & water, re-oil lightly, let dry before reinstalling. Do not use compressed air.' },
          { id: 'p7c', date: '2025-01-01', part: 'Hydraulic Oil Filter', cost: 0, where: 'Auto parts store / Amazon', notes: 'OEM cross-refs: Fram PH9342, Wix 51361, K&N HP-2008. All 3/4"-16 thread. Change at first 50hrs, then annually.' },
          { id: 'p7d', date: '2025-01-01', part: 'Hydraulic Fluid AW46', cost: 0, where: 'Tractor Supply / Amazon / Fleet Farm', notes: 'AW46 (ISO 46) hydraulic oil ‚Äî 4.5 gallon tank capacity. Change when contaminated or discolored.' },
          { id: 'p7e', date: '2025-01-01', part: 'Engine Oil 10W-30', cost: 0, where: 'Any auto/hardware store', notes: 'SAE 10W-30 motor oil ‚Äî ~0.6qt / 0.5L capacity. Change every 25hrs or annually.' }
        ],
        totalHours: 59.6
      },
      {
        id: 'e9',
        name: 'Stihl FS 70R Trimmer',
        type: '‚úÇÔ∏è String Trimmer',
        year: '',
        engine: '27.2cc 2-stroke',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        notes: 'Fuel: 50:1 mix. Parts: Air Filter #4144-124-2800, Fuel Filter (replace annually), Spark Plug CMR6H (same as MS171). Replace spark plug every 100hrs or annually. Replace fuel pickup body every year. Clean air filter every 5hrs of use. Trimmer line: round .095" line recommended.',
        maintenance: [
          { id: 'm9a', date: '2024-04-01', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm9b', date: '2024-04-01', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm9c', date: '2024-04-01', type: 'Fuel Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm9d', date: '2023-10-01', type: 'Spark Plug', notes: 'From prior log', nextDue: '' },
          { id: 'm9e', date: '2023-10-01', type: 'Air Filter', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h9a', date: '2024-04-01', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h9b', date: '2024-05-18', hours: 4, notes: 'Trimming season start', total: 9 },
          { id: 'h9c', date: '2024-07-20', hours: 5, notes: 'Summer trimming', total: 14 },
          { id: 'h9d', date: '2024-09-15', hours: 4, notes: 'Fall edging', total: 18 },
        ],
        parts: [
          { id: 'p9a', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #4144-124-2800 ‚Äî fits FS40/50/56/70, FC56/70, KM56, HT56C. Clean every 5hrs, replace annually.' },
          { id: 'p9b', date: '2025-01-01', part: 'Fuel Filter / Pickup Body', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'Fuel pickup body inside tank ‚Äî replace annually. Same small-bore filter style as other Stihl trimmers.' },
          { id: 'p9c', date: '2025-01-01', part: 'Spark Plug NGK CMR6H', cost: 0, where: 'Stihl Dealer / NGK / Amazon', notes: 'OEM #0000-400-7015 ‚Äî NGK CMR6H (same as Stihl MS171). Replace every 100hrs or annually.' }
        ],
        totalHours: 18
      },
      {
        id: 'e8',
        name: 'Husqvarna YTH2348',
        type: 'üöú Riding Mower',
        year: '',
        engine: 'B&S Intek 23HP 724cc V-Twin',
        serial: '',
        purchaseDate: '',
        oilInterval: 'annual',
        trackHours: true,
        notes: 'Oil: SAE 30 or 10W-30 synthetic, ~48oz with filter. TWO spark plugs needed: #491055S (Champion RC12YC). Air Filter #273658S + Pre-Cleaner #272403S (do NOT oil pre-cleaner). Oil Filter: B&S #492056 / Wix 51056. Deck Belt #532144959, Drive Belt #532139776, Blades #532138971. Change oil BEFORE storage (not after season).',
        maintenance: [
          { id: 'm8a', date: '2024-04-05', type: 'Oil Change', notes: 'Break-in oil change ‚Äî 10W-30 synthetic, oil filter replaced', nextDue: '' },
          { id: 'm8b', date: '2024-04-05', type: 'Air Filter', notes: 'Break-in service ‚Äî primary and pre-cleaner', nextDue: '' },
          { id: 'm8c', date: '2024-04-05', type: 'Spark Plug', notes: 'Break-in service ‚Äî both plugs replaced', nextDue: '' },
          { id: 'm8d', date: '2024-04-05', type: 'Blade Sharpen', notes: 'Start of season sharpening', nextDue: '' },
          { id: 'm8i', date: '2021-11-21', type: 'Oil Change', notes: '610 hrs ‚Äî from prior log', nextDue: '' },
          { id: 'm8e', date: '2023-03-05', type: 'Oil Change', notes: '678 hrs ‚Äî from prior log', nextDue: '' },
          { id: 'm8f', date: '2023-03-05', type: 'Oil Filter', notes: '678 hrs ‚Äî from prior log', nextDue: '' },
          { id: 'm8g', date: '2023-03-05', type: 'Spark Plug', notes: '678 hrs ‚Äî from prior log', nextDue: '' },
          { id: 'm8h', date: '2023-03-05', type: 'Air Filter', notes: '678 hrs ‚Äî from prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h8z', date: '2023-03-05', hours: 993.2, notes: 'Actual hours on meter as of latest reading', total: 993.2 },

        ],
        parts: [
          { id: 'p8a', date: '2025-01-01', part: 'Spark Plug (x2 needed)', cost: 0, where: 'Briggs & Stratton / AutoZone / Amazon', notes: 'OEM #491055S ‚Äî Champion RC12YC equivalent. V-Twin engine needs TWO plugs. Pre-gapped. Replace annually.' },
          { id: 'p8b', date: '2025-01-01', part: 'Air Filter (primary cartridge)', cost: 0, where: 'Husqvarna / Briggs & Stratton / Amazon', notes: 'OEM #273658S ‚Äî pleated paper cartridge for B&S Intek V-Twin. Replace annually or when dirty.' },
          { id: 'p8c', date: '2025-01-01', part: 'Pre-Cleaner (foam wrap)', cost: 0, where: 'Husqvarna / Briggs & Stratton / Amazon', notes: 'OEM #272403S ‚Äî foam pre-cleaner. Do NOT oil it (causes air restriction). Clean/replace separately from main filter.' },
          { id: 'p8d', date: '2025-01-01', part: 'Oil Filter', cost: 0, where: 'Briggs & Stratton / AutoZone / Amazon', notes: 'OEM B&S #492056 ‚Äî also Wix 51056. Change every 25hrs with oil. ~48oz total oil capacity with filter.' },
          { id: 'p8e', date: '2025-01-01', part: 'Deck Belt', cost: 0, where: 'Husqvarna / Amazon / Jack\'s Small Engines', notes: 'OEM Husqvarna #532144959 ‚Äî 48" deck drive belt. Inspect annually for cracking/fraying.' },
          { id: 'p8f', date: '2025-01-01', part: 'Drive Belt (ground drive)', cost: 0, where: 'Husqvarna / Amazon / Jack\'s Small Engines', notes: 'OEM Husqvarna #532139776 ‚Äî ground drive / transmission belt. Inspect annually.' },
          { id: 'p8g', date: '2025-01-01', part: 'Mower Blades (set)', cost: 0, where: 'Husqvarna / Amazon / Oregon', notes: 'OEM Husqvarna #532138971 ‚Äî 48" deck blades. Sharpen each season, replace when worn/bent.' }
        ],
        totalHours: 993.2
      }
    ]
  };
  save(demo);
}

// ---------- Render ----------
function renderAll() {
  seedDemo();
  const data = load();
  renderEquipmentGrid(data);
  if (currentEquipId) renderDetail();
}

function getIcon(type) {
  return type ? type.split(' ')[0] : 'üîß';
}

function renderEquipmentGrid(data) {
  const tbody = document.getElementById('equipmentGridBody');
  if (!data.equipment.length) {
    if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="no-logs"><div class="icon">üåø</div>No equipment yet ‚Äî add your first piece of gear above.</td></tr>`;
    return;
  }
  const allIssues = getMaintenanceIssues(data);
  if (!tbody) return;

  tbody.innerHTML = data.equipment.map(eq => {
    const isActive = eq.id === currentEquipId;
    const equipIssues = allIssues.filter(i => i.equipId === eq.id);
    const hasDue = equipIssues.some(i => i.status === 'due');
    const hasSoon = equipIssues.some(i => i.status === 'soon');
    const serviceFlag = hasDue
      ? `<span class="service-flag flag-due">‚ö†Ô∏è Service Needed</span>`
      : hasSoon
      ? `<span class="service-flag flag-soon">üîî Service Soon</span>`
      : `<span style="font-size:0.75rem;color:var(--green-light)">‚úì Good</span>`;

    const maintSorted = [...eq.maintenance].sort((a,b) => b.date.localeCompare(a.date));
    const lastMaint = maintSorted[0];
    const lastOil = eq.maintenance.filter(m => m.type === 'Oil Change').sort((a,b) => b.date.localeCompare(a.date))[0];
    const totalCost = eq.parts.reduce((s,p) => s + (parseFloat(p.cost)||0), 0);

    const intervalText = eq.oilInterval === 'annual'
      ? '<span style="font-size:0.75rem;color:var(--text-muted);font-style:italic">Annual</span>'
      : eq.oilInterval >= 999
      ? '<span style="font-size:0.75rem;color:var(--text-muted);font-style:italic">Two-Stroke</span>'
      : eq.oilInterval + ' hrs';

    return `<tr class="${isActive ? 'active-row' : ''}" onclick="selectEquipment('${eq.id}')" style="cursor:pointer">
      <td>
        <div style="display:flex;align-items:center;gap:10px">
          <span style="font-size:1.4rem">${getIcon(eq.type)}</span>
          <div>
            <div style="font-weight:600;font-size:0.95rem">${eq.name}</div>
            <div style="font-size:0.74rem;color:var(--text-muted)">${eq.engine || ''}</div>
          </div>
        </div>
      </td>
      <td>${serviceFlag}</td>
      <td style="font-family:'DM Mono',monospace;font-size:0.88rem">${eq.trackHours ? (eq.totalHours || 0) : '<span style="color:var(--text-light)">‚Äî</span>'}</td>
      <td style="font-size:0.82rem">${lastMaint ? fmtDate(lastMaint.date) + '<br><span style="font-size:0.73rem;color:var(--text-muted)">' + lastMaint.type + '</span>' : '‚Äî'}</td>
      <td onclick="event.stopPropagation()">
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="card-btn" onclick="selectEquipment('${eq.id}'); openLogMaintenance()">+ Maint.</button>
          ${eq.trackHours ? `<button class="card-btn" onclick="selectEquipment('${eq.id}'); openLogHours()">+ Hrs</button>` : ''}
          <button class="card-btn" onclick="selectEquipment('${eq.id}'); openLogPart()">+ Parts</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

// ---------- Page navigation ----------
let currentPage = 'garage';
let shopFilter = 'all';
let checkedParts = JSON.parse(localStorage.getItem('gearlog_checked') || '{}');

function switchPage(page) {
  currentPage = page;
  document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.top-nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.getElementById('nav-' + page).classList.add('active');
  if (page === 'reminders') renderReminders();
  if (page === 'shopping') renderShopping();
}

function renderAlerts(data) {
  const issues = getMaintenanceIssues(data);
  const dueCount = issues.filter(i => i.status === 'due').length;

  // Badge on reminders nav
  const badge = document.getElementById('reminderBadge');
  if (dueCount > 0) {
    badge.textContent = dueCount;
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }

  // Compact alert banners in garage view (only overdue)
  const overdue = issues.filter(i => i.status === 'due');
  const area = document.getElementById('alertsArea');
  area.innerHTML = overdue.map(a =>
    `<div class="alert-banner">‚ö†Ô∏è <span><strong>${a.equip}</strong>: ${a.task} ‚Äî ${a.detail}</span></div>`
  ).join('');
}

// ---- Maintenance issue detection ----
function getMaintenanceIssues(data) {
  const issues = [];
  const today = new Date();

  data.equipment.forEach(eq => {
    // 1. Oil change detection
    if (eq.oilInterval === 'annual') {
      // Annual oil change ‚Äî check by date
      const oilChanges = eq.maintenance.filter(m => m.type === 'Oil Change').sort((a,b)=>b.date.localeCompare(a.date));
      if (oilChanges.length) {
        const daysSince = Math.round((new Date() - new Date(oilChanges[0].date)) / 86400000);
        if (daysSince >= 365) {
          issues.push({ equip: eq.name, equipId: eq.id, task: 'Oil Change', icon: 'üõ¢',
            detail: `Last changed ${daysSince} days ago ‚Äî annual change due`,
            status: 'due' });
        } else if (daysSince >= 300) {
          issues.push({ equip: eq.name, equipId: eq.id, task: 'Oil Change', icon: 'üõ¢',
            detail: `Last changed ${daysSince} days ago ‚Äî annual change coming up`,
            status: 'soon' });
        }
      } else {
        issues.push({ equip: eq.name, equipId: eq.id, task: 'Oil Change', icon: 'üõ¢',
          detail: 'No oil change logged ‚Äî annual change required',
          status: 'due' });
      }
    } else if (eq.oilInterval && eq.oilInterval < 999) {
      const hoursSince = getHoursSinceLastOilChange(eq);
      if (hoursSince !== null) {
        const pct = hoursSince / eq.oilInterval;
        if (pct >= 1) {
          issues.push({ equip: eq.name, equipId: eq.id, task: 'Oil Change', icon: 'üõ¢',
            detail: `${Math.round(hoursSince)}hrs since last change (interval: ${eq.oilInterval}hrs)`,
            status: 'due' });
        } else if (pct >= 0.8) {
          issues.push({ equip: eq.name, equipId: eq.id, task: 'Oil Change', icon: 'üõ¢',
            detail: `${Math.round(hoursSince)}hrs since last change (interval: ${eq.oilInterval}hrs)`,
            status: 'soon' });
        }
      } else if (eq.totalHours > 0) {
        issues.push({ equip: eq.name, equipId: eq.id, task: 'Oil Change', icon: 'üõ¢',
          detail: `No oil change logged yet (${eq.totalHours}hrs on equipment)`,
          status: 'due' });
      }
    }

    // 2. Next due date reminders from maintenance log
    eq.maintenance.forEach(m => {
      if (!m.nextDue) return;
      // Try to parse as date
      const d = new Date(m.nextDue);
      if (!isNaN(d)) {
        const diffDays = Math.round((d - today) / 86400000);
        if (diffDays < 0) {
          issues.push({ equip: eq.name, equipId: eq.id, task: m.type, icon: 'üîß',
            detail: `Was due ${Math.abs(diffDays)} days ago (${fmtDate(m.nextDue)})`,
            status: 'due' });
        } else if (diffDays <= 14) {
          issues.push({ equip: eq.name, equipId: eq.id, task: m.type, icon: 'üîß',
            detail: `Due in ${diffDays} day${diffDays === 1 ? '' : 's'} (${fmtDate(m.nextDue)})`,
            status: 'soon' });
        }
      }
    });

    // 3. Annual service reminder ‚Äî if any maintenance type hasn't been done in 365+ days
    const annualChecks = ['Air Filter', 'Spark Plug', 'Fuel Filter', 'Fuel Filter (Pickup Body)', 'Tune-Up', 'Oil Filter', 'Hydraulic Oil', 'Hydraulic Filter', 'Blade Sharpen', 'Grease / Lube'];
    annualChecks.forEach(checkType => {
      const matches = eq.maintenance.filter(m => m.type === checkType);
      if (!matches.length) return;
      const lastDone = matches.sort((a, b) => b.date.localeCompare(a.date))[0];
      const daysSince = Math.round((today - new Date(lastDone.date)) / 86400000);
      if (daysSince >= 365) {
        issues.push({ equip: eq.name, equipId: eq.id, task: checkType, icon: 'üìÖ',
          detail: `Last done ${daysSince} days ago ‚Äî annual replacement recommended`,
          status: daysSince >= 400 ? 'due' : 'soon' });
      }
    });
  });

  return issues;
}

// ---- Summary View ----
// ---- To-Do List View ----
let todoChecked = JSON.parse(localStorage.getItem('gearlog_todo') || '{}');
let customShopItems = JSON.parse(localStorage.getItem('gearlog_custom_shop') || '[]');

function saveCustomShop() {
  localStorage.setItem('gearlog_custom_shop', JSON.stringify(customShopItems));
}

function addToShoppingList(key, taskName, equipName, equipId) {
  if (customShopItems.some(i => i.key === key)) return;
  customShopItems.push({ key, taskName, equipName, equipId, checked: false, addedAt: new Date().toISOString() });
  saveCustomShop();
  renderReminders(); // re-render todo so button flips to "‚úì On shopping list"
  // Flash feedback
  const btn = event.target;
  btn.textContent = '‚úì Added!';
  btn.style.color = 'var(--green)';
  btn.style.borderColor = 'var(--green)';
}

function toggleCustomShopCheck(key) {
  const item = customShopItems.find(i => i.key === key);
  if (item) { item.checked = !item.checked; saveCustomShop(); renderShopping(); }
}

function removeCustomShopItem(key) {
  customShopItems = customShopItems.filter(i => i.key !== key);
  saveCustomShop();
  renderShopping();
  renderReminders(); // flip button back
}

function saveTodo() {
  localStorage.setItem('gearlog_todo', JSON.stringify(todoChecked));
}

function toggleTodo(key) {
  todoChecked[key] = !todoChecked[key];
  saveTodo();
  renderReminders();
}

function clearTodo() {
  todoChecked = {};
  saveTodo();
  renderReminders();
}

function renderReminders() {
  const data = load();
  const issues = getMaintenanceIssues(data);
  const el = document.getElementById('remindersContent');

  if (!issues.length) {
    el.innerHTML = `<div class="reminder-card status-ok" style="max-width:480px">
      <div class="reminder-icon">‚úÖ</div>
      <div class="reminder-body">
        <div class="reminder-task">All Clear!</div>
        <div class="reminder-detail">No overdue or upcoming maintenance detected. Keep logging your hours and service records to get accurate reminders.</div>
      </div>
    </div>`;
    return;
  }

  // Group issues by equipment
  const byEquip = {};
  issues.forEach(issue => {
    if (!byEquip[issue.equipId]) byEquip[issue.equipId] = { name: issue.equip, issues: [] };
    byEquip[issue.equipId].issues.push(issue);
  });

  // Total subtask progress
  const totalSubtasks = issues.length;
  const doneSubtasks = Object.keys(todoChecked).filter(k => k.endsWith('_install') && todoChecked[k]).length;
  const pct = totalSubtasks > 0 ? Math.round((doneSubtasks / totalSubtasks) * 100) : 0;

  let html = '';

  // Overall progress bar
  html += `<div style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:16px 20px;margin-bottom:22px;display:flex;align-items:center;gap:16px;box-shadow:var(--shadow-sm)">
    <div style="font-size:1.4rem">üõ†</div>
    <div style="flex:1">
      <div style="font-weight:700;font-size:0.92rem;margin-bottom:6px">${doneSubtasks} of ${totalSubtasks} sub-tasks complete</div>
      <div style="height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;border:1px solid var(--border)">
        <div style="width:${pct}%;height:100%;background:${pct===100?'var(--green-light)':'var(--amber)'};border-radius:4px;transition:width 0.3s"></div>
      </div>
    </div>
    <div style="font-family:'DM Mono',monospace;font-size:1.1rem;font-weight:700;color:${pct===100?'var(--green)':'var(--amber)'}">${pct}%</div>
  </div>`;

  Object.entries(byEquip).forEach(([equipId, group]) => {
    const groupSubtasks = group.issues.length;
    const groupDone = group.issues.reduce((sum, issue) => {
      const k2 = equipId + '_' + issue.task + '_install';
      return sum + (todoChecked[k2] ? 1 : 0);
    }, 0);
    const allDone = groupDone === groupSubtasks;

    const tasksHtml = group.issues.map(issue => {
      const orderKey = equipId + '_' + issue.task + '_order';
      const installKey = equipId + '_' + issue.task + '_install';
      const orderDone = !!todoChecked[orderKey];
      const installDone = !!todoChecked[installKey];
      const shopKey = equipId + '|' + issue.task;
      const alreadyOnList = customShopItems.some(i => i.key === shopKey);
      return `<div class="todo-task">
        <div class="todo-task-header">
          <span class="todo-task-icon">${issue.icon}</span>
          <span class="todo-task-name">${issue.task}</span>
          <span class="todo-task-badge badge-${issue.status}">${issue.status === 'due' ? 'Overdue' : 'Due Soon'}</span>
        </div>
        <div class="todo-task-detail">${issue.detail}</div>
        <div class="todo-subtasks">
          <div class="todo-subtask ${installDone ? 'done' : ''}" onclick="toggleTodo('${installKey}')">
            <div class="todo-subtask-check">${installDone ? '‚úì' : ''}</div>
            <span class="todo-subtask-label">\u{1F527} Install part</span>
          </div>
        </div>
        <div style="padding-left:30px;margin-top:8px">
          ${alreadyOnList
            ? '<span style="font-family:var(--font-mono);font-size:0.72rem;color:var(--green);letter-spacing:0.04em">\u2713 On shopping list</span>'
            : '<button class="card-btn" style="font-size:0.72rem;color:var(--amber);border-color:var(--amber);padding:4px 10px" onclick="addToShoppingList(\'' + shopKey + '\',\'' + issue.task + '\',\'' + group.name + '\',\'' + equipId + '\')">\u{1F6D2} + Shopping List</button>'
          }
        </div>
      </div>`;
    }).join('');

    html += `<div class="todo-equip-group">
      <div class="todo-equip-header" onclick="toggleTodoGroup('${equipId}')">
        <div class="todo-equip-title">
          ${getIcon(data.equipment.find(e=>e.id===equipId)?.type||'')} ${group.name}
          <span class="todo-equip-count ${allDone ? 'all-done' : ''}">${allDone ? '‚úì Done' : groupDone + '/' + groupSubtasks}</span>
        </div>
        <span class="todo-equip-collapse" id="collapse-${equipId}">‚ñº</span>
      </div>
      <div id="todo-tasks-${equipId}" class="todo-tasks">${tasksHtml}</div>
      <div class="todo-progress">
        <div class="todo-progress-bar-wrap"><div class="todo-progress-bar" style="width:${groupSubtasks > 0 ? Math.round(groupDone/groupSubtasks*100) : 0}%"></div></div>
        <span>${groupSubtasks > 0 ? Math.round(groupDone/groupSubtasks*100) : 0}% complete</span>
      </div>
    </div>`;
  });

  el.innerHTML = html;
}

function collapseAllTodo() {
  document.querySelectorAll('[id^="todo-tasks-"]').forEach(el => {
    const equipId = el.id.replace('todo-tasks-', '');
    el.style.display = 'none';
    const arrow = document.getElementById('collapse-' + equipId);
    if (arrow) arrow.style.transform = 'rotate(-90deg)';
  });
}

function toggleTodoGroup(equipId) {
  const tasks = document.getElementById('todo-tasks-' + equipId);
  const arrow = document.getElementById('collapse-' + equipId);
  const hidden = tasks.style.display === 'none';
  tasks.style.display = hidden ? '' : 'none';
  if (arrow) arrow.style.transform = hidden ? '' : 'rotate(-90deg)';
}

function toggleShopGroup(equipId) {
  const items = document.getElementById('shop-items-' + equipId);
  const arrow = document.getElementById('shop-arrow-' + equipId);
  const hidden = items.style.display === 'none';
  items.style.display = hidden ? '' : 'none';
  if (arrow) arrow.style.transform = hidden ? '' : 'rotate(-90deg)';
}

function openAmazonExport() {
  const data = load();
  const issues = getMaintenanceIssues(data);

  // Build a map of which parts need service per equipment
  function partNeedsServiceLocal(equipId, partName) {
    const pn = partName.toLowerCase();
    for (const issue of issues) {
      if (issue.equipId !== equipId) continue;
      const task = issue.task.toLowerCase();
      if (pn.includes(task) || task.includes(pn.split(' ')[0])) return true;
      if ((pn.includes('air filter') || pn.includes('pre-cleaner')) && task === 'air filter') return true;
      if (pn.includes('spark plug') && task === 'spark plug') return true;
      if (pn.includes('fuel filter') && (task === 'fuel filter' || task === 'fuel filter (pickup body)')) return true;
      if (pn.includes('oil filter') && task === 'oil filter') return true;
      if ((pn.includes('engine oil') || (pn.includes('oil') && !pn.includes('filter') && !pn.includes('hydraulic') && !pn.includes('pump'))) && task === 'oil change') return true;
      if ((pn.includes('hydraulic oil') || pn.includes('hydraulic fluid') || pn.includes('aw46')) && task === 'hydraulic oil') return true;
      if (pn.includes('hydraulic') && pn.includes('filter') && task === 'hydraulic filter') return true;
      if ((pn.includes('blade') || pn.includes('sharpen')) && task === 'blade sharpen') return true;
      if ((pn.includes('pump oil') || pn.includes('non-detergent')) && task === 'grease / lube') return true;
    }
    return false;
  }

  let lines = [];
  lines.push("SHIVELY'S GEARLOG ‚Äî SHOPPING LIST");
  lines.push('Generated: ' + new Date().toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'}));
  lines.push('‚ïê'.repeat(48));

  let totalItems = 0;

  // Include custom To-Do items that are checked
  const checkedCustom = customShopItems.filter(i => i.checked);
  if (checkedCustom.length) {
    lines.push('');
    lines.push('FROM TO-DO LIST');
    lines.push('‚îÄ'.repeat(36));
    checkedCustom.forEach(i => {
      lines.push('‚Ä¢ ' + i.taskName + '  (' + i.equipName + ')');
      totalItems++;
    });
  }

  // Include parts reference items that are checked
  data.equipment.forEach(eq => {
    const needed = eq.parts.filter(p => {
      const key = eq.id + '_' + p.id;
      return !!checkedParts[key];
    });
    if (!needed.length) return;

    lines.push('');
    lines.push(eq.name.toUpperCase());
    lines.push('‚îÄ'.repeat(36));

    needed.forEach(p => {
      const oemMatch = (p.notes || '').match(/OEM[^‚Äî#]*#([\w\-]+)/i);
      const oemNum = oemMatch ? oemMatch[1] : null;
      lines.push('‚Ä¢ ' + p.part + (oemNum ? '  [#' + oemNum + ']' : ''));
      if (p.where) lines.push('  Where to buy: ' + p.where);
      totalItems++;
    });
  });

  if (totalItems === 0) {
    lines = ["Nothing checked off yet ‚Äî tick the checkboxes next to what you need to buy, then export."];
  } else {
    lines.push('');
    lines.push('‚ïê'.repeat(48));
    lines.push('TOTAL ITEMS: ' + totalItems);
  }

  document.getElementById('amazonExportText').value = lines.join('\n');
  document.getElementById('copyExportBtn').textContent = 'üìã Copy to Clipboard';
  document.getElementById('modalAmazonExport').classList.add('visible');
}

function copyAmazonExport() {
  const text = document.getElementById('amazonExportText');
  text.select();
  text.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(text.value).then(() => {
    const btn = document.getElementById('copyExportBtn');
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = 'üìã Copy to Clipboard', 2000);
  }).catch(() => {
    document.execCommand('copy');
    const btn = document.getElementById('copyExportBtn');
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = 'üìã Copy to Clipboard', 2000);
  });
}

function collapseAllShop() {
  document.querySelectorAll('[id^="shop-items-"]').forEach(el => {
    const equipId = el.id.replace('shop-items-', '');
    el.style.display = 'none';
    const arrow = document.getElementById('shop-arrow-' + equipId);
    if (arrow) arrow.style.transform = 'rotate(-90deg)';
  });
}

// ---- Shopping List ----
function setShopFilter(f, btn) {
  shopFilter = f;
  document.querySelectorAll('.shop-filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderShopping();
}

// Kit -> component relationships: kitPartId -> [componentPartIds]
const KIT_COMPONENTS = {
  'e1_p1d': ['e1_p1a', 'e1_p1b', 'e1_p1c'],   // MS171 Service Kit -> air filter, fuel filter, spark plug
  'e3_p3d': ['e3_p3a', 'e3_p3b', 'e3_p3c'],   // MS271 Service Kit -> air filter, fuel filter, spark plug
  'e4_p4d': ['e4_p4a', 'e4_p4b', 'e4_p4c'],   // Echo Tune-Up Kit -> air filter, fuel filter, spark plug
  'e6_p6c': ['e6_p6a', 'e6_p6b'],              // Push Mower Kit -> air filter, spark plug
  'e10_p10d': ['e10_p10a', 'e10_p10b', 'e10_p10c'], // Leaf Vac Kit -> air filter, spark plug, oil
};

// Reverse map: component -> kit (so checking all components can check the kit)
const COMPONENT_TO_KIT = {};
Object.entries(KIT_COMPONENTS).forEach(([kit, components]) => {
  components.forEach(c => { COMPONENT_TO_KIT[c] = kit; });
});

function toggleCheck(key) {
  const newState = !checkedParts[key];
  checkedParts[key] = newState;

  // If this is a kit, sync all its components
  if (KIT_COMPONENTS[key]) {
    KIT_COMPONENTS[key].forEach(compKey => {
      checkedParts[compKey] = newState;
    });
  }

  // If this is a component, check if all siblings are now checked -> auto-check kit
  if (COMPONENT_TO_KIT[key]) {
    const kitKey = COMPONENT_TO_KIT[key];
    const allChecked = KIT_COMPONENTS[kitKey].every(k => checkedParts[k]);
    const noneChecked = KIT_COMPONENTS[kitKey].every(k => !checkedParts[k]);
    if (allChecked) checkedParts[kitKey] = true;
    if (noneChecked) checkedParts[kitKey] = false;
  }

  localStorage.setItem('gearlog_checked', JSON.stringify(checkedParts));
  renderShopping();
}

function clearChecked() {
  checkedParts = {};
  localStorage.setItem('gearlog_checked', JSON.stringify(checkedParts));
  renderShopping();
}

function partMatchesFilter(partName, notes) {
  const haystack = (partName + ' ' + notes).toLowerCase();
  if (shopFilter === 'all') return true;
  if (shopFilter === 'filter') return haystack.includes('filter') && !haystack.includes('oil filter') && !haystack.includes('hydraulic');
  if (shopFilter === 'plug') return haystack.includes('spark plug') || haystack.includes('cmr6h') || haystack.includes('bpmr7a') || haystack.includes('bpm8y') || haystack.includes('bpr6es');
  if (shopFilter === 'oil') return haystack.includes('oil') || haystack.includes('fluid') || haystack.includes('hydraulic') || haystack.includes('pump oil');
  if (shopFilter === 'belt') return haystack.includes('belt') || haystack.includes('blade') || haystack.includes('chain');
  return true;
}

function renderShopping() {
  const data = load();
  const el = document.getElementById('shoppingContent');
  if (!data.equipment.length) {
    el.innerHTML = '<p style="color:var(--text-muted)">No equipment added yet.</p>';
    return;
  }

  // Get all current issues to cross-reference "needs service" state
  const issues = getMaintenanceIssues(data);
  const issueSet = new Set(issues.map(i => i.equipId + '|' + i.task.toLowerCase()));

  // Map part names to maintenance task names for matching
  function partNeedsService(equipId, partName) {
    const pn = partName.toLowerCase();
    // Direct task name matches
    for (const issue of issues) {
      if (issue.equipId !== equipId) continue;
      const task = issue.task.toLowerCase();
      if (pn.includes(task) || task.includes(pn.split(' ')[0])) return issue.status;
      // Specific mappings
      if ((pn.includes('air filter') || pn.includes('pre-cleaner')) && task === 'air filter') return issue.status;
      if (pn.includes('spark plug') && task === 'spark plug') return issue.status;
      if (pn.includes('fuel filter') && (task === 'fuel filter' || task === 'fuel filter (pickup body)')) return issue.status;
      if (pn.includes('oil filter') && task === 'oil filter') return issue.status;
      if ((pn.includes('engine oil') || (pn.includes('oil') && !pn.includes('filter') && !pn.includes('hydraulic') && !pn.includes('pump'))) && task === 'oil change') return issue.status;
      if ((pn.includes('hydraulic oil') || pn.includes('hydraulic fluid') || pn.includes('aw46')) && task === 'hydraulic oil') return issue.status;
      if (pn.includes('hydraulic') && pn.includes('filter') && task === 'hydraulic filter') return issue.status;
      if ((pn.includes('blade') || pn.includes('sharpen')) && task === 'blade sharpen') return issue.status;
      if ((pn.includes('pump oil') || pn.includes('non-detergent')) && task === 'grease / lube') return issue.status;
    }
    return null;
  }

  let html = '';

  // ---- Helper: find the matching part in eq.parts for a given task name ----
  function findPartForTask(equipId, taskName) {
    const eq = data.equipment.find(e => e.id === equipId);
    if (!eq) return null;
    const tn = taskName.toLowerCase();
    return eq.parts.find(p => {
      const pn = p.part.toLowerCase();
      if (pn.includes(tn) || tn.includes(pn.split(' ')[0])) return true;
      if ((pn.includes('air filter') || pn.includes('pre-cleaner')) && tn === 'air filter') return true;
      if (pn.includes('spark plug') && tn === 'spark plug') return true;
      if (pn.includes('fuel filter') && (tn === 'fuel filter' || tn.includes('fuel filter'))) return true;
      if (pn.includes('oil filter') && tn === 'oil filter') return true;
      if ((pn.includes('engine oil') || (pn.includes('oil') && !pn.includes('filter') && !pn.includes('hydraulic') && !pn.includes('pump'))) && tn === 'oil change') return true;
      if ((pn.includes('hydraulic oil') || pn.includes('hydraulic fluid') || pn.includes('aw46')) && tn === 'hydraulic oil') return true;
      if (pn.includes('hydraulic') && pn.includes('filter') && tn === 'hydraulic filter') return true;
      if ((pn.includes('blade') || pn.includes('sharpen')) && tn === 'blade sharpen') return true;
      if ((pn.includes('pump oil') || pn.includes('non-detergent')) && tn === 'grease / lube') return true;
      return false;
    }) || null;
  }

  // ---- Custom "From To-Do" items section ----
  if (customShopItems.length) {
    html += `<div style="background:var(--surface);border:1.5px solid var(--amber);border-radius:var(--radius);margin-bottom:22px;overflow:hidden;box-shadow:var(--shadow-sm)">
      <div style="padding:12px 20px;background:var(--amber-pale);border-bottom:1px solid var(--amber);display:flex;align-items:center;gap:10px">
        <span style="font-size:1rem">üõí</span>
        <span style="font-family:var(--font-head);font-weight:700;font-size:0.85rem;letter-spacing:0.06em;text-transform:uppercase;color:var(--amber)">From To-Do List</span>
        <span style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);margin-left:auto">${customShopItems.length} item${customShopItems.length !== 1 ? 's' : ''}</span>
      </div>
      <div style="padding:8px 20px 12px">`;
    customShopItems.forEach(item => {
      // Try to find a matching part in the reference list and share its checkedParts key
      const matchedPart = findPartForTask(item.equipId, item.taskName);
      const sharedKey = matchedPart ? item.equipId + '_' + matchedPart.id : null;
      const isChecked = sharedKey ? !!checkedParts[sharedKey] : item.checked;
      const onClickFn = sharedKey
        ? `toggleCheck('${sharedKey}')`          // syncs with parts reference
        : `toggleCustomShopCheck('${item.key}')`; // standalone fallback
      const matchNote = matchedPart
        ? `<span style="font-family:var(--font-mono);font-size:0.65rem;color:var(--green);margin-left:6px;opacity:0.8">‚Üî synced with parts ref</span>`
        : '';
      const customAmazonQuery = encodeURIComponent(item.taskName);
      const customAmazonBtn = isChecked
        ? `<a href="https://www.amazon.com/s?k=${customAmazonQuery}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;margin-top:6px;padding:4px 10px;background:var(--amber-pale);border:1px solid var(--amber);border-radius:4px;font-family:var(--font-mono);font-size:0.7rem;color:var(--amber);text-decoration:none;letter-spacing:0.04em" onmouseover="this.style.background='rgba(251,191,36,0.18)'" onmouseout="this.style.background='var(--amber-pale)'">üîç Search Amazon</a>`
        : '';
      html += `<div style="display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);${isChecked ? 'opacity:0.8' : ''}">
        <div class="shop-check ${isChecked ? 'checked' : ''}" onclick="${onClickFn}" style="flex-shrink:0;margin-top:2px">${isChecked ? '‚úì' : ''}</div>
        <div style="flex:1;min-width:0">
          <div style="font-family:var(--font-head);font-weight:600;font-size:0.88rem;${isChecked ? 'text-decoration:line-through;color:var(--text-muted)' : ''}">${item.taskName}${matchNote}</div>
          <div style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);margin-top:2px">${item.equipName}</div>
          ${customAmazonBtn}
        </div>
        <button onclick="removeCustomShopItem('${item.key}')" style="background:none;border:none;cursor:pointer;color:var(--text-light);font-size:1rem;padding:2px 6px;border-radius:4px;transition:color 0.15s" title="Remove" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--text-light)'">‚úï</button>
      </div>`;
    });
    html += `</div></div>`;
  }

  data.equipment.forEach(eq => {
    const filtered = eq.parts.filter(p => partMatchesFilter(p.part, p.notes || ''));
    if (!filtered.length) return;

    // Split into needs-service and reference-only
    const needsService = filtered.filter(p => partNeedsService(eq.id, p.part));
    const refOnly = filtered.filter(p => !partNeedsService(eq.id, p.part));

    const shopSectionId = 'shop-items-' + eq.id;
    const serviceCount = needsService.length;
    const countBadge = serviceCount > 0
      ? `<span style="font-size:0.72rem;font-weight:700;background:var(--red);color:white;border-radius:10px;padding:2px 8px;margin-left:8px">${serviceCount} needed</span>`
      : '';

    html += `<div class="shop-section" style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);margin-bottom:18px;overflow:hidden;box-shadow:var(--shadow-sm);padding:0">
      <div class="shop-section-title" style="cursor:pointer;padding:14px 20px;background:var(--surface2);margin:0;border-bottom:1.5px solid var(--border)" onclick="toggleShopGroup('${eq.id}')">
        <span style="font-weight:700;font-size:1rem">${getIcon(eq.type)} ${eq.name}${countBadge} <span style="color:var(--text-light);font-weight:400;font-size:0.68rem;margin-left:6px">${eq.engine||''}</span></span>
        <span style="display:flex;align-items:center;gap:12px">
          <span style="color:var(--text-light);font-weight:400;font-size:0.82rem">${filtered.length} part${filtered.length>1?'s':''}</span>
          <span id="shop-arrow-${eq.id}" style="color:var(--text-muted);font-size:0.85rem;transition:transform 0.2s">‚ñº</span>
        </span>
      </div>
      <div id="${shopSectionId}" style="padding:0 20px">`;

    function renderPart(p, serviceStatus) {
      const key = eq.id + '_' + p.id;
      const checked = checkedParts[key];
      const oemMatch = (p.notes || '').match(/OEM[^‚Äî#]*#([\w\-]+)/i);
      const oemNum = oemMatch ? oemMatch[1] : null;
      const urgencyBar = serviceStatus === 'due'
        ? `<span style="font-size:0.7rem;font-weight:700;background:var(--red);color:white;border-radius:4px;padding:1px 7px;margin-left:6px">OVERDUE</span>`
        : serviceStatus === 'soon'
        ? `<span style="font-size:0.7rem;font-weight:700;background:var(--amber);color:white;border-radius:4px;padding:1px 7px;margin-left:6px">DUE SOON</span>`
        : '';
      const amazonQuery = encodeURIComponent((oemNum ? oemNum + ' ' : '') + p.part);
      const amazonBtn = checked
        ? `<a href="https://www.amazon.com/s?k=${amazonQuery}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;margin-top:8px;padding:5px 10px;background:var(--amber-pale);border:1px solid var(--amber);border-radius:4px;font-family:var(--font-mono);font-size:0.7rem;color:var(--amber);text-decoration:none;letter-spacing:0.04em;transition:background 0.15s" onmouseover="this.style.background='rgba(251,191,36,0.18)'" onmouseout="this.style.background='var(--amber-pale)'">üîç Search Amazon</a>`
        : '';
      return `<div class="shop-item" style="${checked ? 'opacity:0.8' : ''}${serviceStatus === 'due' ? ';border-left:3px solid var(--red);padding-left:12px' : serviceStatus === 'soon' ? ';border-left:3px solid var(--amber);padding-left:12px' : ''}">
        <div class="shop-check ${checked ? 'checked' : ''}" onclick="toggleCheck('${key}')">${checked ? '‚úì' : ''}</div>
        <div class="shop-item-body">
          <div class="shop-item-name" style="${checked ? 'text-decoration:line-through' : ''}">${p.part}${urgencyBar}</div>
          ${oemNum ? `<div class="shop-item-oem">#${oemNum}</div>` : ''}
          <div class="shop-item-meta" style="margin-top:4px">${p.notes || ''}</div>
          ${p.where ? `<div class="shop-item-where">üõí ${p.where}</div>` : ''}
          ${amazonBtn}
        </div>
      </div>`;
    }

    if (needsService.length) {
      html += `<div style="font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--red);padding:10px 0 6px">‚ö†Ô∏è Needs Service</div>`;
      needsService.forEach(p => { html += renderPart(p, partNeedsService(eq.id, p.part)); });
    }
    if (refOnly.length) {
      if (needsService.length) html += `<div style="font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--text-light);padding:10px 0 6px">Parts Reference</div>`;
      refOnly.forEach(p => { html += renderPart(p, null); });
    }

    html += `</div></div>`;
  });

  el.innerHTML = html || `<div style="text-align:center;padding:40px;color:var(--text-muted)">No parts match this filter.</div>`;
}



function getHoursSinceLastOilChange(eq) {
  const oils = eq.maintenance.filter(m => m.type === 'Oil Change').sort((a,b)=>b.date.localeCompare(a.date));
  if (!oils.length) return null;
  // Find total hours at time of last oil change - approximation: use current total - hours logged after that date
  const lastOilDate = oils[0].date;
  const hoursAfter = eq.hours.filter(h => h.date > lastOilDate).reduce((s,h)=>s+parseFloat(h.hours||0),0);
  return hoursAfter;
}

function closeDetailPanel() {
  document.getElementById('detailPanel').classList.remove('visible');
  currentEquipId = null;
  renderEquipmentGrid(load());
}

function selectEquipment(id) {
  currentEquipId = id;
  if (currentPage !== 'garage') switchPage('garage');
  renderAll();
  renderDetail();
  document.getElementById('detailPanel').classList.add('visible');
  document.getElementById('detailPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderDetail() {
  const data = load();
  const eq = data.equipment.find(e => e.id === currentEquipId);
  if (!eq) return;

  document.getElementById('detailIcon').textContent = getIcon(eq.type);
  document.getElementById('detailName').textContent = eq.name;
  document.getElementById('detailSub').textContent = [eq.year, eq.engine, eq.serial].filter(Boolean).join(' ¬∑ ');

  // Show/hide Hours tab and button based on trackHours flag
  const hoursTab = document.querySelector('.tab[onclick*="hours"]');
  const hoursContent = document.getElementById('tab-hours');
  const hoursBtn = document.querySelector('.detail-actions .btn[onclick*="openLogHours"]');
  const showHours = eq.trackHours === true;
  if (hoursTab) hoursTab.style.display = showHours ? '' : 'none';
  if (hoursContent) hoursContent.style.display = showHours ? '' : 'none';
  if (hoursBtn) hoursBtn.style.display = showHours ? '' : 'none';
  // If hours tab is active but hidden, switch to overview
  if (!showHours && currentTab === 'hours') switchTab('overview');

  // Notes / part numbers
  const notesEl = document.getElementById('equipNotes');
  const notesText = document.getElementById('equipNotesText');
  if (eq.notes) {
    notesEl.style.display = 'block';
    notesText.textContent = eq.notes;
  } else {
    notesEl.style.display = 'none';
  }

  // Overview stats
  const totalCost = eq.parts.reduce((s,p)=>s+(parseFloat(p.cost)||0),0);
  const totalMaint = eq.maintenance.length;
  document.getElementById('overviewStats').innerHTML = `
    ${eq.trackHours ? `<div class="stat-card"><div class="val">${eq.totalHours||0}</div><div class="lbl">Total Hours</div></div>` : ''}
    <div class="stat-card"><div class="val">${totalMaint}</div><div class="lbl">Services Logged</div></div>
    <div class="stat-card"><div class="val">$${totalCost.toFixed(2)}</div><div class="lbl">Total Parts Cost</div></div>
    <div class="stat-card"><div class="val">${eq.parts.length}</div><div class="lbl">Parts Logged</div></div>
  `;

  // Recent activity (all combined, sorted by date)
  const all = [
    ...eq.maintenance.map(m=>({date:m.date,type:'maintenance',label:m.type,desc:m.notes,cost:null})),
    ...eq.parts.map(p=>({date:p.date,type:'parts',label:p.part,desc:p.where,cost:p.cost})),
    ...eq.hours.map(h=>({date:h.date,type:'hours',label:`${h.hours} hrs`,desc:h.notes,cost:null})),
  ].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,10);

  const rBody = document.querySelector('#recentActivity tbody');
  rBody.innerHTML = all.length ? all.map(a=>`<tr>
    <td>${fmtDate(a.date)}</td>
    <td><span class="badge badge-${a.type}">${a.type}</span></td>
    <td>${a.label}${a.desc?` <span style="color:var(--text-light);font-size:0.8em">‚Äî ${a.desc}</span>`:''}</td>
    <td>${a.cost!=null?'$'+parseFloat(a.cost).toFixed(2):'‚Äî'}</td>
  </tr>`).join('') : '<tr><td colspan="4" class="no-logs"><div class="icon">üìã</div>No activity yet.</td></tr>';

  // Maintenance tab
  const mBody = document.querySelector('#maintenanceTable tbody');
  const mSorted = [...eq.maintenance].sort((a,b)=>b.date.localeCompare(a.date));
  mBody.innerHTML = mSorted.length ? mSorted.map(m=>`<tr>
    <td>${fmtDate(m.date)}</td>
    <td><span class="badge badge-maintenance">${m.type}</span></td>
    <td>${m.notes||'‚Äî'}</td>
    <td>${m.nextDue||'‚Äî'}</td>
  </tr>`).join('') : '<tr><td colspan="4" class="no-logs"><div class="icon">üîß</div>No maintenance logged yet.</td></tr>';

  // Hours tab
  const hBody = document.querySelector('#hoursTable tbody');
  const hSorted = [...eq.hours].sort((a,b)=>b.date.localeCompare(a.date));
  let runTotal = eq.totalHours || 0;
  hBody.innerHTML = hSorted.length ? hSorted.map(h=>`<tr>
    <td>${fmtDate(h.date)}</td>
    <td>${h.hours}</td>
    <td>${h.total}</td>
    <td>${h.notes||'‚Äî'}</td>
  </tr>`).join('') : '<tr><td colspan="4" class="no-logs"><div class="icon">‚è±</div>No hours logged yet.</td></tr>';

  // Parts tab ‚Äî OEM reference parts (from parts array, $0 cost = reference entries)
  const pContainer = document.getElementById('partsContent');
  if (!pContainer) return;

  if (!eq.parts.length) {
    pContainer.innerHTML = '<div class="no-logs"><div class="icon">üî©</div>No parts logged yet.</div>';
    return;
  }

  // Separate reference parts (cost=0, have OEM notes) from purchased parts (cost>0)
  const refParts = eq.parts.filter(p => (parseFloat(p.cost)||0) === 0);
  const purchasedParts = eq.parts.filter(p => (parseFloat(p.cost)||0) > 0);

  let pHtml = '';

  // OEM Reference section
  if (refParts.length) {
    pHtml += `<div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-light);margin-bottom:12px">üìã OEM Parts Reference</div>`;
    pHtml += refParts.map(p => {
      // Try to extract OEM number from notes (pattern: #XXXXXXXX)
      const oemMatch = p.notes ? p.notes.match(/OEM[^#]*#([\w\-]+)/) : null;
      const oemNum = oemMatch ? oemMatch[1] : null;
      return `<div style="background:var(--surface);border:1.5px solid var(--border);border-radius:9px;padding:13px 16px;margin-bottom:10px;display:flex;gap:14px;align-items:flex-start">
        <div style="font-size:1.3rem;flex-shrink:0;margin-top:1px">üî©</div>
        <div style="flex:1">
          <div style="font-weight:700;font-size:0.95rem;margin-bottom:3px">${p.part}</div>
          ${oemNum ? `<div style="font-family:'DM Mono',monospace;font-size:0.76rem;color:var(--amber);background:var(--amber-pale);border-radius:4px;padding:1px 7px;display:inline-block;margin-bottom:5px">#${oemNum}</div>` : ''}
          <div style="font-size:0.8rem;color:var(--text-muted);line-height:1.5">${p.notes||''}</div>
          ${p.where ? `<div style="font-size:0.76rem;color:var(--text-light);margin-top:4px">üõí ${p.where}</div>` : ''}
        </div>
      </div>`;
    }).join('');
  }

  // Purchased parts section
  if (purchasedParts.length) {
    const totalSpent = purchasedParts.reduce((s,p)=>s+(parseFloat(p.cost)||0),0);
    pHtml += `<div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-light);margin:20px 0 12px">üßæ Purchase History ‚Äî Total: $${totalSpent.toFixed(2)}</div>`;
    pHtml += `<table class="log-table"><thead><tr><th>Date</th><th>Part</th><th>Notes</th><th>Cost</th></tr></thead><tbody>`;
    pHtml += [...purchasedParts].sort((a,b)=>b.date.localeCompare(a.date)).map(p=>`<tr>
      <td>${fmtDate(p.date)}</td>
      <td>${p.part}</td>
      <td>${p.notes||p.where||'‚Äî'}</td>
      <td>$${parseFloat(p.cost||0).toFixed(2)}</td>
    </tr>`).join('');
    pHtml += '</tbody></table>';
  }

  pContainer.innerHTML = pHtml;
}

function fmtDate(d) {
  if (!d) return '‚Äî';
  const [y,m,day] = d.split('-');
  return `${m}/${day}/${y}`;
}

// ---------- Tabs ----------
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach((t,i) => {
    const tabs = ['overview','maintenance','hours','parts'];
    t.classList.toggle('active', tabs[i] === tab);
  });
  document.querySelectorAll('.tab-content').forEach(tc => {
    tc.classList.toggle('active', tc.id === 'tab-'+tab);
  });
}

// ---------- Modals ----------
function openModal(id) { document.getElementById(id).classList.add('visible'); }
function closeModal(id) { document.getElementById(id).classList.remove('visible'); }

function openAddEquipment() { openModal('modalAddEquipment'); }
function openLogMaintenance() { if (!currentEquipId) return; document.getElementById('mDate').value = today(); openModal('modalMaintenance'); }
function openLogHours() { if (!currentEquipId) return; document.getElementById('hDate').value = today(); openModal('modalHours'); }
function openLogPart() { if (!currentEquipId) return; document.getElementById('pDate').value = today(); openModal('modalPart'); }

function today() { return new Date().toISOString().slice(0,10); }
function uid() { return Math.random().toString(36).slice(2,8); }

// ---------- Save Actions ----------
function saveEquipment() {
  const name = document.getElementById('newEquipName').value.trim();
  if (!name) { alert('Please enter a name.'); return; }
  const data = load();
  const eq = {
    id: uid(),
    name,
    type: document.getElementById('newEquipType').value,
    year: document.getElementById('newEquipYear').value,
    engine: document.getElementById('newEquipEngine').value,
    serial: document.getElementById('newEquipSerial').value,
    purchaseDate: document.getElementById('newEquipDate').value,
    oilInterval: parseInt(document.getElementById('newEquipOilInterval').value)||50,
    notes: '',
    maintenance: [], hours: [], parts: [], totalHours: 0
  };
  data.equipment.push(eq);
  save(data);
  closeModal('modalAddEquipment');
  ['newEquipName','newEquipYear','newEquipEngine','newEquipSerial','newEquipDate'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('newEquipOilInterval').value='50';
  selectEquipment(eq.id);
}

function saveMaintenance() {
  const data = load();
  const eq = data.equipment.find(e=>e.id===currentEquipId);
  if (!eq) return;
  eq.maintenance.push({
    id: uid(),
    date: document.getElementById('mDate').value || today(),
    type: document.getElementById('mType').value,
    notes: document.getElementById('mNotes').value,
    nextDue: document.getElementById('mNextDue').value,
  });
  save(data);
  closeModal('modalMaintenance');
  ['mNotes','mNextDue'].forEach(id=>document.getElementById(id).value='');
  renderAll();
}

function saveHours() {
  const hrs = parseFloat(document.getElementById('hHours').value);
  if (!hrs || hrs <= 0) { alert('Enter valid hours.'); return; }
  const data = load();
  const eq = data.equipment.find(e=>e.id===currentEquipId);
  if (!eq) return;
  eq.totalHours = (eq.totalHours||0) + hrs;
  eq.hours.push({
    id: uid(),
    date: document.getElementById('hDate').value || today(),
    hours: hrs,
    notes: document.getElementById('hNotes').value,
    total: eq.totalHours,
  });
  save(data);
  closeModal('modalHours');
  ['hHours','hNotes'].forEach(id=>document.getElementById(id).value='');
  renderAll();
}

function savePart() {
  const part = document.getElementById('pPart').value.trim();
  if (!part) { alert('Enter part name.'); return; }
  const data = load();
  const eq = data.equipment.find(e=>e.id===currentEquipId);
  if (!eq) return;
  eq.parts.push({
    id: uid(),
    date: document.getElementById('pDate').value || today(),
    part,
    cost: parseFloat(document.getElementById('pCost').value)||0,
    where: document.getElementById('pWhere').value,
    notes: document.getElementById('pNotes').value,
  });
  save(data);
  closeModal('modalPart');
  ['pPart','pCost','pWhere','pNotes'].forEach(id=>document.getElementById(id).value='');
  renderAll();
}

function deleteCurrentEquipment() {
  const data = load();
  const eq = data.equipment.find(e=>e.id===currentEquipId);
  if (!eq || !confirm(`Delete "${eq.name}"? This cannot be undone.`)) return;
  data.equipment = data.equipment.filter(e=>e.id!==currentEquipId);
  save(data);
  currentEquipId = null;
  document.getElementById('detailPanel').classList.remove('visible');
  renderAll();
}

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('visible'); });
});

// ---------- PWA / Service Worker ----------
let _pwaInstallPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  _pwaInstallPrompt = e;
  const btn = document.getElementById('pwaInstallBtn');
  if (btn) btn.style.display = 'inline-block';
});

window.addEventListener('appinstalled', () => {
  const btn = document.getElementById('pwaInstallBtn');
  if (btn) btn.style.display = 'none';
  _pwaInstallPrompt = null;
});

function installPWA() {
  if (!_pwaInstallPrompt) {
    alert('To install on iOS: tap the Share button (‚ñ°‚Üë) in Safari, then "Add to Home Screen".');
    return;
  }
  _pwaInstallPrompt.prompt();
  _pwaInstallPrompt.userChoice.then(() => { _pwaInstallPrompt = null; });
}

// ---------- Inline Manifest ----------
(function() {
  const manifest = {
    name: "Shively's GearLog",
    short_name: "GearLog",
    description: "Gas-Powered Lawn Equipment Tracker",
    start_url: "./",
    display: "standalone",
    background_color: "#0a0e0a",
    theme_color: "#0a0e0a",
    orientation: "any",
    icons: [
      { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='24' fill='%230a0e0a'/%3E%3Ctext x='96' y='135' font-size='110' text-anchor='middle'%3E%E2%9A%99%EF%B8%8F%3C/text%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml", purpose: "any maskable" },
      { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='64' fill='%230a0e0a'/%3E%3Ctext x='256' y='360' font-size='300' text-anchor='middle'%3E%E2%9A%99%EF%B8%8F%3C/text%3E%3C/svg%3E", sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
  document.querySelector('link[rel="manifest"]').href = URL.createObjectURL(blob);
})();

// ---------- Inline Service Worker ----------
if ('serviceWorker' in navigator) {
  const swCode = `
const CACHE = 'gearlog-v1';
self.addEventListener('install', () => self.skipWaiting());
self.addEventListener('activate', e => {
  e.waitUntil(caches.keys().then(keys =>
    Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
  ).then(() => self.clients.claim()));
});
self.addEventListener('fetch', e => {
  if (e.request.url.startsWith(self.location.origin)) {
    e.respondWith(
      caches.open(CACHE).then(cache =>
        fetch(e.request)
          .then(res => { cache.put(e.request, res.clone()); return res; })
          .catch(() => cache.match(e.request))
      )
    );
  }
});
  `;
  const swBlob = new Blob([swCode], {type: 'application/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  window.addEventListener('load', () => {
    navigator.serviceWorker.register(swUrl)
      .then(() => console.log('[GearLog] SW registered'))
      .catch(err => console.warn('[GearLog] SW failed:', err));
  });
}

// ---------- Init ----------
renderAll();
</script>
</body>
</html>
