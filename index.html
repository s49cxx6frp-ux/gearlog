<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Shively's GearLog</title>

<!-- PWA Manifest (inline via data URI so this stays a single deployable HTML file) -->
<link rel="manifest" href="#">

<!-- iOS PWA support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GearLog">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%230a0e0a'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle'%3E‚öôÔ∏è%3C/text%3E%3C/svg%3E">

<!-- Android / theme -->
<meta name="theme-color" content="#F5821F">
<meta name="mobile-web-app-capable" content="yes">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;500;600;700;800;900&family=Barlow:wght@400;500;600&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #111111;
    --surface: #1a1a1a;
    --surface2: #222222;
    --surface3: #2a2a2a;
    --border: #333333;
    --border-bright: #444444;
    --orange: #F5821F;
    --orange-dim: #d96d10;
    --orange-dark: #b85c0d;
    --orange-pale: rgba(245,130,31,0.1);
    --orange-glow: rgba(245,130,31,0.15);
    --amber: #F5821F;
    --amber-pale: rgba(245,130,31,0.1);
    --red: #e05252;
    --red-pale: rgba(224,82,82,0.1);
    --green: #4ade80;
    --green-dark: #16a34a;
    --green-pale: rgba(74,222,128,0.08);
    --text: #f0f0f0;
    --text-muted: #999999;
    --text-light: #666666;
    --shadow: 0 4px 24px rgba(0,0,0,0.7);
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.5);
    --radius: 3px;
    --font-head: 'Barlow Condensed', sans-serif;
    --font-mono: 'Roboto Mono', monospace;
    --font-body: 'Barlow', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 0;
  }

  /* Header */
  header {
    background: #F5821F;
    border-bottom: 4px solid #b85c0d;
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
    position: relative;
  }
  .brand h1 {
    font-family: var(--font-head);
    font-size: 2.2rem;
    font-weight: 900;
    letter-spacing: 0.04em;
    color: #ffffff;
    text-transform: uppercase;
    line-height: 1;
  }
  .brand p {
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: rgba(255,255,255,0.75);
    margin-top: 4px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  /* PWA install button */
  #pwaInstallBtn {
    display: none;
    background: #ffffff;
    color: var(--orange);
    border: 2px solid #ffffff;
    border-radius: var(--radius);
    padding: 8px 16px;
    font-family: var(--font-head);
    font-weight: 700;
    font-size: 0.95rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }
  #pwaInstallBtn:hover { background: rgba(255,255,255,0.85); }

  .btn-add-equipment {
    background: #111111;
    color: #ffffff;
    border: 2px solid #111111;
    border-radius: var(--radius);
    padding: 8px 16px;
    font-family: var(--font-head);
    font-weight: 700;
    font-size: 0.95rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-add-equipment:hover { background: #2a2a2a; border-color: #2a2a2a; }

  /* Nav */
  .top-nav {
    background: var(--surface2);
    border-bottom: 3px solid var(--border);
    display: flex;
    padding: 0 16px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .top-nav::-webkit-scrollbar { display: none; }
  .top-nav-btn {
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    margin-bottom: -3px;
    padding: 14px 18px;
    flex-shrink: 0;
    font-family: var(--font-head);
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--text-muted);
    cursor: pointer;
    transition: color 0.15s, border-color 0.15s;
    white-space: nowrap;
  }
  .top-nav-btn.active { color: var(--orange); border-bottom-color: var(--orange); }
  .top-nav-btn:hover:not(.active) { color: var(--text); }

  /* Main layout */
  main { max-width: 1200px; margin: 0 auto; padding: 28px 24px; }

  /* Page views */
  .page-view { display: none; }
  .page-view.active { display: block; }

  /* Tables */
  .summary-table, .garage-table, .log-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
  }
  .summary-table th, .garage-table th, .log-table th {
    text-align: left;
    padding: 11px 16px;
    font-family: var(--font-head);
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    background: var(--surface2);
    border-bottom: 2px solid var(--border-bright);
    white-space: nowrap;
  }
  .summary-table td, .garage-table td, .log-table td {
    padding: 13px 16px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
    color: var(--text);
    font-size: 0.95rem;
  }
  .summary-table tr:last-child td,
  .garage-table tr:last-child td,
  .log-table tr:last-child td { border-bottom: none; }
  .summary-table tbody tr, .garage-table tbody tr {
    cursor: pointer;
    transition: background 0.1s;
  }
  .summary-table tbody tr:hover td,
  .garage-table tbody tr:hover td { background: rgba(245,130,31,0.05); }
  .summary-table tr.active-row td,
  .garage-table tr.active td {
    background: rgba(245,130,31,0.06);
    border-left: 3px solid var(--orange);
  }

  .equip-icon {
    font-size: 1.3rem;
    width: 34px; height: 34px;
    display: flex; align-items: center; justify-content: center;
    background: var(--surface3);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    flex-shrink: 0;
  }
  .card-name { font-family: var(--font-head); font-size: 1.1rem; font-weight: 700; letter-spacing: 0.03em; color: var(--text); text-transform: uppercase; }
  .card-sub { font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
  .stat-value { font-family: var(--font-head); font-size: 1.1rem; font-weight: 700; color: var(--orange); }
  .stat-label { font-family: var(--font-head); font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; }

  .card-btn {
    padding: 5px 10px;
    background: transparent;
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    cursor: pointer;
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--text-muted);
    transition: all 0.15s;
    white-space: nowrap;
    letter-spacing: 0.05em;
  }
  .card-btn:hover { background: var(--green-glow); color: var(--green); border-color: var(--green-dim); }

  /* Buttons */
  .btn {
    border: 1px solid transparent;
    border-radius: var(--radius);
    padding: 8px 16px;
    font-family: var(--font-head);
    font-weight: 600;
    font-size: 0.78rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s;
  }
  .btn:hover { transform: translateY(-1px); }
  .btn-primary { background: var(--green-dark); color: #fff; border-color: var(--green-dim); }
  .btn-primary:hover { background: var(--green-dim); box-shadow: 0 0 16px rgba(74,222,128,0.25); }
  .btn-secondary { background: transparent; color: var(--text-muted); border: 1px solid var(--border-bright); }
  .btn-secondary:hover { color: var(--text); border-color: var(--text-muted); }
  .btn-danger { background: transparent; color: var(--red); border: 1px solid rgba(248,113,113,0.3); }
  .btn-danger:hover { background: var(--red-pale); }

  /* Detail panel */
  .detail-panel {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 28px;
    display: none;
    position: relative;
  }
  .detail-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--green-dim), transparent);
  }
  .detail-panel.visible { display: block; animation: slideIn 0.2s ease; }
  @keyframes slideIn { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }

  .detail-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 24px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 12px;
  }
  .detail-title { display: flex; align-items: center; gap: 14px; }
  .detail-title h2 {
    font-family: var(--font-head);
    font-size: 1.4rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--green);
  }
  .detail-title .sub { font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-muted); }
  .detail-actions { display: flex; gap: 8px; flex-wrap: wrap; }

  .modal-close {
    background: transparent;
    border: 1px solid var(--border-bright);
    color: var(--text-muted);
    width: 30px; height: 30px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.9rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .modal-close:hover { color: var(--red); border-color: var(--red); }

  /* Tabs */
  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    background: var(--surface2);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab {
    padding: 12px 18px;
    font-family: var(--font-mono);
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-light);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: color 0.15s, border-color 0.15s;
    white-space: nowrap;
  }
  .tab.active { color: var(--orange); border-bottom-color: var(--orange); }
  .tab:hover { color: var(--text-muted); }
  .tab-content { padding: 24px; display: none; }
  .tab-content.active { display: block; }

  /* Stats row */
  .stats-row { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; }
  .stat-card {
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    padding: 14px 20px;
    min-width: 100px;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: var(--green-dim);
    opacity: 0.4;
  }
  .stat-card .val { font-family: var(--font-mono); font-size: 1.4rem; color: var(--green); }
  .stat-card .lbl { font-family: var(--font-mono); font-size: 0.62rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.1em; margin-top: 3px; }

  /* Badges */
  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 2px;
    font-family: var(--font-mono);
    font-size: 0.68rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  .badge-maintenance { background: rgba(74,222,128,0.1); color: var(--green-dim); border: 1px solid rgba(74,222,128,0.2); }
  .badge-parts { background: rgba(251,191,36,0.1); color: var(--amber); border: 1px solid rgba(251,191,36,0.2); }
  .badge-hours { background: rgba(148,163,184,0.1); color: #94a3b8; border: 1px solid rgba(148,163,184,0.2); }

  .section-label {
    font-family: var(--font-mono);
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-light);
    margin-bottom: 12px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }

  /* Service flags */
  .service-flag {
    display: inline-block;
    font-family: var(--font-mono);
    font-size: 0.68rem;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 2px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
  .flag-due { background: var(--red-pale); color: var(--red); border: 1px solid rgba(248,113,113,0.3); }
  .flag-soon { background: var(--amber-pale); color: var(--amber); border: 1px solid rgba(251,191,36,0.3); }

  /* Status dots */
  .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }
  .dot-ok { background: var(--green); box-shadow: 0 0 6px rgba(74,222,128,0.6); }
  .dot-warn { background: var(--amber); box-shadow: 0 0 6px rgba(251,191,36,0.5); }
  .dot-due { background: var(--red); box-shadow: 0 0 6px rgba(248,113,113,0.5); }

  /* Modals */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.visible { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow), 0 0 40px rgba(74,222,128,0.08);
    position: relative;
  }
  .modal::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--green-dim), transparent);
  }
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }
  .modal-header h3 {
    font-family: var(--font-head);
    font-size: 0.95rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--green);
  }
  .modal-body { padding: 20px; }
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 16px 20px;
    border-top: 1px solid var(--border);
  }

  .form-group { margin-bottom: 16px; }
  .form-group label {
    display: block;
    font-family: var(--font-mono);
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: 6px;
  }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    padding: 9px 12px;
    font-family: var(--font-body);
    font-size: 0.88rem;
    color: var(--text);
    transition: border-color 0.15s, box-shadow 0.15s;
    outline: none;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    border-color: var(--orange);
    box-shadow: 0 0 0 2px rgba(245,130,31,0.15);
  }
  .form-group select option { background: var(--surface2); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

  /* Log table */
  .log-table tbody tr:hover td { background: var(--green-pale); }
  .no-logs {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-light);
    font-family: var(--font-mono);
    font-size: 0.8rem;
    letter-spacing: 0.05em;
  }
  .no-logs .icon { font-size: 2rem; margin-bottom: 8px; opacity: 0.4; }

  /* Shopping list */
  .shop-filters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 20px;
    align-items: center;
  }
  .shop-filter-btn {
    background: transparent;
    border: 1px solid var(--border-bright);
    border-radius: 2px;
    padding: 5px 12px;
    font-family: var(--font-mono);
    font-size: 0.7rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s;
    color: var(--text-muted);
  }
  .shop-filter-btn.active { background: var(--orange); border-color: var(--orange-dim); color: #fff; }
  .shop-filter-btn:hover:not(.active) { border-color: var(--orange-dim); color: var(--orange); }

  .shop-section { margin-bottom: 20px; }
  .shop-section-title {
    font-family: var(--font-mono);
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-light);
    padding: 0 0 8px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .shop-item {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .shop-item:last-child { border-bottom: none; }
  .shop-check {
    width: 18px; height: 18px;
    border: 1px solid var(--border-bright);
    border-radius: 2px;
    flex-shrink: 0;
    margin-top: 2px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem;
    color: var(--bg);
  }
  .shop-check.checked { background: var(--orange); border-color: var(--orange-dim); color: #fff; }
  .shop-item-body { flex: 1; }
  .shop-item-name { font-family: var(--font-head); font-weight: 700; font-size: 1.05rem; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.02em; }
  .shop-item-meta { font-size: 0.82rem; color: var(--text-muted); }
  .shop-item-oem { font-family: var(--font-mono); font-size: 0.72rem; color: var(--amber); background: rgba(251,191,36,0.08); border: 1px solid rgba(251,191,36,0.2); border-radius: 2px; padding: 1px 6px; display: inline-block; margin-top: 4px; }
  .shop-item-where { font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-light); margin-top: 3px; }

  /* To-Do */
  .todo-equip-group {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    margin-bottom: 14px;
    overflow: hidden;
  }
  .todo-equip-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 18px;
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
    transition: background 0.1s;
  }
  .todo-equip-header:hover { background: var(--surface3); }
  .todo-equip-title { font-family: var(--font-head); font-weight: 800; font-size: 1.05rem; letter-spacing: 0.05em; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
  .todo-equip-count { font-family: var(--font-mono); font-size: 0.65rem; background: var(--red); color: white; border-radius: 2px; padding: 2px 7px; letter-spacing: 0.05em; }
  .todo-equip-count.all-done { background: var(--orange); color: #fff; }
  .todo-equip-collapse { color: var(--text-light); font-size: 0.8rem; transition: transform 0.2s; }
  .todo-tasks { padding: 0 18px; }
  .todo-task { padding: 12px 0; border-bottom: 1px solid var(--border); }
  .todo-task:last-child { border-bottom: none; }
  .todo-task-header { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
  .todo-task-icon { font-size: 1rem; flex-shrink: 0; }
  .todo-task-name { font-family: var(--font-head); font-weight: 700; font-size: 1.05rem; letter-spacing: 0.03em; flex: 1; }
  .todo-task-badge { font-family: var(--font-mono); font-size: 0.62rem; padding: 2px 7px; border-radius: 2px; text-transform: uppercase; letter-spacing: 0.06em; }
  .badge-due { background: var(--red-pale); color: var(--red); border: 1px solid rgba(248,113,113,0.3); }
  .badge-soon { background: var(--amber-pale); color: var(--amber); border: 1px solid rgba(251,191,36,0.3); }
  .todo-task-detail { font-family: var(--font-mono); font-size: 0.72rem; color: var(--text-muted); margin-bottom: 8px; padding-left: 30px; }
  .todo-subtasks { display: flex; flex-direction: column; gap: 6px; padding-left: 30px; }
  .todo-subtask {
    display: flex; align-items: center; gap: 10px; cursor: pointer;
    padding: 6px 10px; border-radius: var(--radius); border: 1px solid var(--border);
    background: var(--surface2); transition: all 0.12s; user-select: none;
  }
  .todo-subtask:hover { border-color: var(--orange-dim); background: var(--orange-pale); }
  .todo-subtask.done { background: rgba(245,130,31,0.06); border-color: rgba(245,130,31,0.2); }
  .todo-subtask.done .todo-subtask-label { text-decoration: line-through; color: var(--text-light); }
  .todo-subtask-check {
    width: 16px; height: 16px; border: 1px solid var(--border-bright); border-radius: 2px;
    flex-shrink: 0; display: flex; align-items: center; justify-content: center;
    font-size: 0.65rem; transition: all 0.12s;
  }
  .todo-subtask.done .todo-subtask-check { background: var(--orange); border-color: var(--orange-dim); color: #fff; }
  .todo-subtask-label { font-family: var(--font-mono); font-size: 0.78rem; letter-spacing: 0.04em; }
  .todo-progress {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 18px; background: rgba(74,222,128,0.03); border-top: 1px solid var(--border);
    font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted); letter-spacing: 0.06em;
  }
  .todo-progress-bar-wrap { flex: 1; height: 3px; background: var(--border-bright); border-radius: 0; overflow: hidden; }
  .todo-progress-bar { height: 100%; background: var(--orange); transition: width 0.3s; }

  /* Page headers */
  .section-heading {
    font-family: var(--font-head);
    font-size: 1.5rem;
    font-weight: 800;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--orange);
    margin-bottom: 4px;
  }
  .section-sub {
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--text-muted);
    letter-spacing: 0.05em;
    margin-bottom: 20px;
  }
  .page-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 20px;
  }

  /* Empty state */
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
  .empty-state .big-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.3; }
  .empty-state h3 { font-family: var(--font-head); font-size: 1.2rem; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
  .empty-state p { font-family: var(--font-mono); font-size: 0.78rem; color: var(--text-light); margin-bottom: 20px; }

  /* Reminder cards */
  .reminders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .reminder-card {
    background: var(--surface);
    border: 1px solid var(--border-bright);
    border-radius: var(--radius);
    padding: 14px 16px;
    display: flex;
    gap: 12px;
    align-items: flex-start;
  }
  .reminder-card.status-due { border-color: rgba(248,113,113,0.4); background: var(--red-pale); }
  .reminder-card.status-soon { border-color: rgba(251,191,36,0.3); background: var(--amber-pale); }
  .reminder-card.status-ok { border-color: rgba(74,222,128,0.2); background: var(--green-pale); }
  .reminder-icon { font-size: 1.2rem; flex-shrink: 0; margin-top: 2px; }
  .reminder-equip { font-family: var(--font-mono); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-light); margin-bottom: 3px; }
  .reminder-task { font-family: var(--font-head); font-weight: 600; font-size: 0.88rem; letter-spacing: 0.03em; margin-bottom: 3px; }
  .reminder-detail { font-family: var(--font-mono); font-size: 0.72rem; color: var(--text-muted); }
  .reminder-status { display: inline-block; margin-top: 5px; font-family: var(--font-mono); font-size: 0.62rem; font-weight: 700; padding: 2px 7px; border-radius: 2px; text-transform: uppercase; letter-spacing: 0.06em; }
  .status-due .reminder-status { background: var(--red); color: #fff; }
  .status-soon .reminder-status { background: var(--amber); color: var(--bg); }
  .status-ok .reminder-status { background: #2a7a2a; color: #fff; }

  @media (max-width: 600px) {
    header { padding: 14px 16px; }
    .brand h1 { font-size: 1.7rem; }
    main { padding: 16px; }
    .form-row { grid-template-columns: 1fr; }
    .detail-header { padding: 14px 16px; }
    .tab-content { padding: 16px; }
    .tabs { padding: 0 4px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .tab { flex-shrink: 0; }
    .top-nav { padding: 0 4px; }
    .top-nav-btn { padding: 10px 14px; font-size: 0.72rem; flex-shrink: 0; white-space: nowrap; }
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <h1>‚õΩ Shively's GearLog</h1>
    <p>Gas-Powered Lawn Equipment Tracker</p>
  </div>
  <div style="display:flex;gap:10px;align-items:center">
    <button id="pwaInstallBtn" onclick="installPWA()">‚¨á Install App</button>
    <button class="btn-add-equipment" onclick="openAddEquipment()">+ Add Equipment</button>
    <button onclick="resetAppData()" style="background:transparent;border:1px solid #555;color:#888;border-radius:4px;padding:9px 14px;font-family:var(--font-head);font-size:0.75rem;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;cursor:pointer" title="Reset all app data to defaults">‚Ü∫ Reset</button>
  </div>
</header>

<nav class="top-nav">
  <button class="top-nav-btn active" id="nav-garage" onclick="switchPage('garage')">üè† Garage</button>
  <button class="top-nav-btn" id="nav-reminders" onclick="switchPage('reminders')">‚úÖ To-Do <span id="reminderBadge" style="display:none;background:#e04e4e;color:white;border-radius:10px;padding:1px 7px;font-size:0.72rem;margin-left:4px;"></span></button>
  <button class="top-nav-btn" id="nav-shopping" onclick="switchPage('shopping')">üõí Shopping List</button>
  <button class="top-nav-btn" id="nav-history" onclick="switchPage('history')">üìÖ History</button>
</nav>

<main>

  <!-- ===== GARAGE PAGE ===== -->
  <div class="page-view active" id="page-garage">
    <div style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-sm);margin-bottom:24px">
      <table class="summary-table" id="equipmentGrid">
        <thead><tr>
          <th>Equipment</th>
          <th>Status</th>
          <th>Hours</th>
          <th>Last Service</th>
          <th>Actions</th>
        </tr></thead>
        <tbody id="equipmentGridBody"></tbody>
      </table>
    </div>

    <!-- Detail Panel -->
    <div class="detail-panel" id="detailPanel">
      <div class="detail-header">
        <div class="detail-title">
          <span id="detailIcon" style="font-size:2rem"></span>
          <div>
            <h2 id="detailName"></h2>
            <div class="sub" id="detailSub"></div>
          </div>
        </div>
        <div class="detail-actions">
          <button class="btn btn-primary" onclick="openLogMaintenance()">+ Maintenance</button>
          <button class="btn btn-primary" onclick="openLogHours()">+ Hours</button>
          <button class="btn btn-primary" onclick="openLogPart()">+ Parts/Cost</button>
          <button class="btn btn-danger" onclick="deleteCurrentEquipment()">Delete</button>
          <button class="modal-close" onclick="closeDetailPanel()" title="Close" style="margin-left:8px">‚úï</button>
        </div>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="switchTab('overview')">Overview</div>
        <div class="tab" onclick="switchTab('maintenance')">Maintenance</div>
        <div class="tab" onclick="switchTab('hours')">Runtime Hours</div>
        <div class="tab" onclick="switchTab('parts')">Parts & Costs</div>
        <div class="tab" onclick="switchTab('qr')">üì± QR Label</div>
      </div>

      <!-- Overview -->
      <div class="tab-content active" id="tab-overview">
        <div class="stats-row" id="overviewStats"></div>
        <div id="equipNotes" style="display:none; background:var(--amber-pale); border:1.5px solid var(--border); border-radius:10px; padding:14px 18px; margin-bottom:20px; font-size:0.86rem; line-height:1.6; color:var(--text-muted);">
          <div style="font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.07em; color:var(--amber); margin-bottom:6px;">üìã Part Numbers &amp; Notes</div>
          <span id="equipNotesText"></span>
        </div>
        <div class="section-label">Recent Activity</div>
        <table class="log-table" id="recentActivity">
          <thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Cost</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Maintenance -->
      <div class="tab-content" id="tab-maintenance">
        <table class="log-table" id="maintenanceTable">
          <thead><tr><th>Date</th><th>Type</th><th>Notes</th><th>Next Due</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Hours -->
      <div class="tab-content" id="tab-hours">
        <table class="log-table" id="hoursTable">
          <thead><tr><th>Date</th><th>Hours Added</th><th>Total Hours</th><th>Notes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Parts -->
      <div class="tab-content" id="tab-parts">
        <div id="partsContent"></div>
      </div>

      <!-- QR Label -->
      <div class="tab-content" id="tab-qr">
        <div id="qrContent" style="display:flex;flex-direction:column;align-items:center;padding:24px 20px;gap:20px">
          <p style="color:var(--text-muted);font-size:0.88rem;text-align:center;max-width:320px;margin:0">
            Scan this code to jump directly to this equipment's page in GearLog.
          </p>
          <div id="qrCanvas" style="background:white;padding:16px;border-radius:12px;border:1.5px solid var(--border)"></div>
          <div id="qrLabel" style="text-align:center"></div>
          <button class="btn btn-primary" onclick="printQrLabel()">üñ® Print Label</button>
        </div>
      </div>
    </div>
  </div><!-- /page-garage -->



  <!-- ===== REMINDERS PAGE ===== -->
  <div class="page-view" id="page-reminders">
    <div class="page-header">
      <div>
        <div class="section-heading">Maintenance To-Do</div>
        <div class="section-sub">Everything that needs attention ‚Äî check off sub-tasks as you order and install each part.</div>
      </div>
      <div style="display:flex;gap:8px;flex-shrink:0">
        <button class="btn btn-secondary" onclick="collapseAllTodo()">Collapse All</button>
        <button class="btn btn-secondary" onclick="clearTodo()">Clear Completed</button>
      </div>
    </div>
    <div id="remindersContent"></div>
  </div><!-- /page-reminders -->

  <!-- ===== SHOPPING LIST PAGE ===== -->
  <div class="page-view" id="page-shopping">
    <div class="page-header">
      <div>
        <div class="section-heading">Shopping List</div>
        <div class="section-sub">OEM parts reference for all your equipment. Check items off as you buy them.</div>
      </div>
      <div style="display:flex;gap:8px;flex-shrink:0;flex-wrap:wrap">
        <button class="btn btn-secondary" onclick="collapseAllShop()">Collapse All</button>
        <button class="btn btn-secondary" onclick="clearChecked()">Clear Checked</button>
        <button class="btn btn-primary" onclick="openAmazonExport()">üì¶ Export Shopping List</button>
      </div>
    </div>
    <div class="shop-filters">
      <span style="font-size:0.8rem;color:var(--text-muted);font-weight:600;">Filter:</span>
      <button class="shop-filter-btn active" onclick="setShopFilter('all', this)">All Equipment</button>
      <button class="shop-filter-btn" onclick="setShopFilter('filter', this)">üî¥ Filters</button>
      <button class="shop-filter-btn" onclick="setShopFilter('plug', this)">‚ö° Spark Plugs</button>
      <button class="shop-filter-btn" onclick="setShopFilter('oil', this)">üõ¢ Oil &amp; Fluids</button>
      <button class="shop-filter-btn" onclick="setShopFilter('belt', this)">‚öôÔ∏è Belts &amp; Blades</button>
    </div>
    <div id="shoppingContent"></div>
  </div><!-- /page-shopping -->

  <!-- ===== HISTORY PAGE ===== -->
  <div class="page-view" id="page-history">
    <div class="page-header">
      <div>
        <div class="section-heading">Service History</div>
        <div class="section-sub">All maintenance, hours, and parts across your fleet ‚Äî most recent first.</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px;align-items:center">
      <select id="historyEquipFilter" onchange="renderHistory()" style="font-family:var(--font-mono);font-size:0.8rem;padding:6px 10px;background:var(--surface2);border:1.5px solid var(--border);border-radius:6px;color:var(--text)">
        <option value="">All Equipment</option>
      </select>
      <select id="historyTypeFilter" onchange="renderHistory()" style="font-family:var(--font-mono);font-size:0.8rem;padding:6px 10px;background:var(--surface2);border:1.5px solid var(--border);border-radius:6px;color:var(--text)">
        <option value="">All Event Types</option>
        <option value="maintenance">Maintenance</option>
        <option value="hours">Hours Logged</option>
        <option value="part">Part Purchase</option>
      </select>
      <span id="historyCount" style="font-family:var(--font-mono);font-size:0.75rem;color:var(--text-muted);margin-left:4px"></span>
    </div>
    <div id="historyContent"></div>
  </div><!-- /page-history -->

</main>

<!-- Add Equipment Modal -->
<div class="modal-overlay" id="modalAddEquipment">
  <div class="modal">
    <div class="modal-header">
      <h3>Add Equipment</h3>
      <button class="modal-close" onclick="closeModal('modalAddEquipment')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Equipment Name</label>
        <input type="text" id="newEquipName" placeholder="e.g. Honda Mower, Husqvarna 450X">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Type</label>
          <select id="newEquipType">
            <option value="üåø Lawn Mower">üåø Lawn Mower</option>
            <option value="‚úÇÔ∏è String Trimmer">‚úÇÔ∏è String Trimmer</option>
            <option value="üçÇ Leaf Blower">üçÇ Leaf Blower</option>
            <option value="ü™ö Chainsaw">ü™ö Chainsaw</option>
            <option value="üå± Tiller">üå± Tiller</option>
            <option value="üöú Riding Mower">üöú Riding Mower</option>
            <option value="‚öôÔ∏è Generator">‚öôÔ∏è Generator</option>
            <option value="üîß Other">üîß Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Year</label>
          <input type="number" id="newEquipYear" placeholder="2022" min="1970" max="2030">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Engine (cc or HP)</label>
          <input type="text" id="newEquipEngine" placeholder="e.g. 160cc, 6HP">
        </div>
        <div class="form-group">
          <label>Serial / Model #</label>
          <input type="text" id="newEquipSerial" placeholder="Optional">
        </div>
      </div>
      <div class="form-group">
        <label>Purchase Date</label>
        <input type="date" id="newEquipDate">
      </div>
      <div class="form-group">
        <label>Oil Change Interval (hours)</label>
        <input type="number" id="newEquipOilInterval" placeholder="50" value="50">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalAddEquipment')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEquipment()">Add Equipment</button>
    </div>
  </div>
</div>

<!-- Edit Equipment Modal -->
<div class="modal-overlay" id="modalEditEquipment">
  <div class="modal">
    <div class="modal-header">
      <h3>Edit Equipment</h3>
      <button class="modal-close" onclick="closeModal('modalEditEquipment')">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editEquipId">
      <div class="form-group">
        <label>Equipment Name</label>
        <input type="text" id="editEquipName" placeholder="e.g. Honda Mower, Husqvarna 450X">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Type</label>
          <select id="editEquipType">
            <option value="üåø Lawn Mower">üåø Lawn Mower</option>
            <option value="‚úÇÔ∏è String Trimmer">‚úÇÔ∏è String Trimmer</option>
            <option value="üçÇ Leaf Blower">üçÇ Leaf Blower</option>
            <option value="ü™ö Chainsaw">ü™ö Chainsaw</option>
            <option value="üå± Tiller">üå± Tiller</option>
            <option value="üöú Riding Mower">üöú Riding Mower</option>
            <option value="‚öôÔ∏è Generator">‚öôÔ∏è Generator</option>
            <option value="üîß Other">üîß Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Year</label>
          <input type="number" id="editEquipYear" placeholder="2022" min="1970" max="2030">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Engine (cc or HP)</label>
          <input type="text" id="editEquipEngine" placeholder="e.g. 160cc, 6HP">
        </div>
        <div class="form-group">
          <label>Serial / Model #</label>
          <input type="text" id="editEquipSerial" placeholder="Optional">
        </div>
      </div>
      <div class="form-group">
        <label>Purchase Date</label>
        <input type="date" id="editEquipDate">
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="editEquipNotes" rows="3" placeholder="Engine specs, fuel mix, part numbers..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalEditEquipment')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditEquipment()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Log Maintenance Modal -->
<div class="modal-overlay" id="modalMaintenance">
  <div class="modal">
    <div class="modal-header">
      <h3>Log Maintenance</h3>
      <button class="modal-close" onclick="closeModal('modalMaintenance')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="mDate">
      </div>
      <div class="form-group">
        <label>Maintenance Type</label>
        <select id="mType">
          <option>Oil Change</option>
          <option>Air Filter</option>
          <option>Spark Plug</option>
          <option>Blade Sharpen</option>
          <option>Blade Replace</option>
          <option>Carburetor Clean</option>
          <option>Fuel Filter</option>
          <option>Tune-Up</option>
          <option>Belt Replace</option>
          <option>Cable Adjust</option>
          <option>Chain Sharpen</option>
          <option>Chain Lubrication</option>
          <option>Storage Prep</option>
          <option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="mNotes" rows="2" placeholder="Any details..."></textarea>
      </div>
      <div class="form-group">
        <label>Next Service Due (date or hours)</label>
        <input type="text" id="mNextDue" placeholder="e.g. 2025-09-01 or 100hrs">
      </div>
      <div class="form-group">
        <label>Photo <span style="color:var(--text-muted);font-weight:400;font-size:0.8rem">(optional)</span></label>
        <input type="file" id="mPhoto" accept="image/*" capture="environment" style="display:none" onchange="previewMaintPhoto(this)">
        <div style="display:flex;align-items:center;gap:10px">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('mPhoto').click()" style="font-size:0.82rem;padding:6px 14px">üì∑ Add Photo</button>
          <span id="mPhotoName" style="font-size:0.8rem;color:var(--text-muted)">No photo</span>
        </div>
        <div id="mPhotoPreview" style="margin-top:10px;display:none">
          <img id="mPhotoImg" style="max-width:100%;max-height:180px;border-radius:8px;border:1.5px solid var(--border)" />
          <button type="button" onclick="clearMaintPhoto()" style="display:block;margin-top:6px;background:none;border:none;color:var(--text-muted);font-size:0.78rem;cursor:pointer">‚úï Remove photo</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalMaintenance')">Cancel</button>
      <button class="btn btn-primary" onclick="saveMaintenance()">Save</button>
    </div>
  </div>
</div>

<!-- Log Hours Modal -->
<div class="modal-overlay" id="modalHours">
  <div class="modal">
    <div class="modal-header">
      <h3>Log Runtime Hours</h3>
      <button class="modal-close" onclick="closeModal('modalHours')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="hDate">
        </div>
        <div class="form-group">
          <label>Hours Added</label>
          <input type="number" id="hHours" step="0.5" min="0" placeholder="2.5">
        </div>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="hNotes" rows="2" placeholder="What did you do?"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalHours')">Cancel</button>
      <button class="btn btn-primary" onclick="saveHours()">Save</button>
    </div>
  </div>
</div>

<!-- Log Part Modal -->
<div class="modal-overlay" id="modalPart">
  <div class="modal">
    <div class="modal-header">
      <h3>Log Part / Cost</h3>
      <button class="modal-close" onclick="closeModal('modalPart')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="pDate">
      </div>
      <div class="form-group">
        <label>Part / Item</label>
        <input type="text" id="pPart" placeholder="e.g. Air filter, Oregon blade, oil...">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Cost ($)</label>
          <input type="number" id="pCost" step="0.01" min="0" placeholder="12.99">
        </div>
        <div class="form-group">
          <label>Where Purchased</label>
          <input type="text" id="pWhere" placeholder="Home Depot, Amazon...">
        </div>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="pNotes" rows="2" placeholder="Part numbers, details..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalPart')">Cancel</button>
      <button class="btn btn-primary" onclick="savePart()">Save</button>
    </div>
  </div>
</div>

<!-- Amazon Export Modal -->
<div class="modal-overlay" id="modalAmazonExport">
  <div class="modal" style="max-width:560px;width:100%">
    <div class="modal-header">
      <h3>üì¶ Shopping List Export</h3>
      <button class="modal-close" onclick="closeModal('modalAmazonExport')">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="font-size:0.84rem;color:var(--text-muted);margin-bottom:16px">Your checked items ‚Äî ready to shop. Use the Amazon buttons in the list to search directly, or copy this list as a reference.</p>
      <textarea id="amazonExportText" readonly style="width:100%;height:320px;font-family:'DM Mono',monospace;font-size:0.78rem;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:12px;resize:none;line-height:1.7;color:var(--text)"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modalAmazonExport')">Close</button>
      <button class="btn btn-primary" id="copyExportBtn" onclick="copyAmazonExport()">üìã Copy to Clipboard</button>
    </div>
  </div>
</div>

<script>
// ---------- Data ----------
function load() {
  return JSON.parse(localStorage.getItem('gearlog') || '{"equipment":[]}');
}
function save(data) {
  localStorage.setItem('gearlog', JSON.stringify(data));
}

let currentEquipId = null;
let currentTab = 'overview';

// ---------- Seed demo data if empty ----------
function seedDemo() {
  const data = load();
  // Re-seed if data exists but has no maintenance records (stale data from earlier version)
  const hasMaintenance = data.equipment && data.equipment.some(e => e.maintenance && e.maintenance.length > 0);
  if (data.equipment.length > 0 && hasMaintenance) return;
  // Clear stale data and re-seed
  localStorage.removeItem('gearlog');
  const demo = {
    equipment: [
      {
        id: 'e1',
        name: 'Stihl MS 171 Chainsaw',
        type: 'ü™ö Chainsaw',
        year: '',
        engine: '31.8cc 2-stroke',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        notes: 'Fuel: 50:1 mix. Parts: Air Filter #1139-120-1602, Fuel Filter #0000-350-3503, Spark Plug CMR6H #0000-400-7015. Gap: 0.020". Service Kit available. Chain: sharpen every fill-up on dirty wood.',
        maintenance: [
          { id: 'm1a', date: '2024-02-10', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm1b', date: '2024-02-10', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm1c', date: '2024-02-10', type: 'Fuel Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm1d', date: '2023-10-01', type: 'Spark Plug', notes: 'From prior log', nextDue: '' },
          { id: 'm1e', date: '2023-10-01', type: 'Air Filter', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h1a', date: '2024-02-10', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h1b', date: '2024-06-20', hours: 8, notes: 'Spring brush clearing', total: 13 },
          { id: 'h1c', date: '2024-10-18', hours: 7, notes: 'Fall firewood', total: 20 },
        ],
        parts: [
          { id: 'p1a', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #1139-120-1602 ‚Äî fleece type, fits MS171/MS181/MS211' },
          { id: 'p1b', date: '2025-01-01', part: 'Fuel Filter (Pickup Body)', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #0000-350-3503 ‚Äî replace annually or if rough running' },
          { id: 'p1c', date: '2025-01-01', part: 'Spark Plug NGK CMR6H', cost: 0, where: 'Stihl Dealer / Amazon / AutoZone', notes: 'OEM #0000-400-7015 ‚Äî NGK CMR6H (part# 3365). Gap: 0.020". Replace annually.' },
          { id: 'p1d', date: '2025-01-01', part: 'Service Kit (all 3 parts)', cost: 0, where: 'Stihl Dealer', notes: 'OEM Kit #1139-007-1800 ‚Äî bundles air filter, fuel filter, spark plug' }
        ],
        totalHours: 20
      },
      {
        id: 'e2',
        name: 'Stihl MS 251 Wood Boss Chainsaw',
        type: 'ü™ö Chainsaw',
        year: '',
        engine: '45.6cc 2-stroke',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        notes: 'Fuel: 50:1 mix. Parts: Air Filter #1141-120-1600, Fuel Filter #0000-350-3518, Spark Plug NGK BPMR7A #0000-400-7000. Same filter family as MS271 ‚Äî buy in bulk.',
        maintenance: [
          { id: 'm2a', date: '2024-02-10', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm2b', date: '2024-02-10', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm2c', date: '2024-02-10', type: 'Fuel Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm2d', date: '2023-10-01', type: 'Spark Plug', notes: 'From prior log', nextDue: '' },
          { id: 'm2e', date: '2023-10-01', type: 'Air Filter', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h2a', date: '2024-02-10', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h2b', date: '2024-07-10', hours: 10, notes: 'Summer storm cleanup', total: 15 },
          { id: 'h2c', date: '2024-11-05', hours: 8, notes: 'Firewood season', total: 23 },
        ],
        parts: [
          { id: 'p2a', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #1141-120-1600 ‚Äî same as MS271. Fits MS231/251/261/271/291/311/391.' },
          { id: 'p2b', date: '2025-01-01', part: 'Fuel Filter (Pickup Body)', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #0000-350-3518 ‚Äî orange/red filter body. Same as MS271.' },
          { id: 'p2c', date: '2025-01-01', part: 'Spark Plug NGK BPMR7A', cost: 0, where: 'Stihl Dealer / NGK / Amazon', notes: 'OEM #0000-400-7000 ‚Äî NGK BPMR7A. Same as MS271. Replace annually.' }
        ],
        totalHours: 23
      },
      {
        id: 'e3',
        name: 'Stihl MS 271 Farm Boss Chainsaw',
        type: 'ü™ö Chainsaw',
        year: '',
        engine: '50.2cc 2-stroke',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        notes: 'Fuel: 50:1 mix. Parts: Air Filter #1141-120-1600, Fuel Filter #0000-350-3518, Spark Plug NGK BPMR7A #0000-400-7000. Same filter family as MS251 ‚Äî buy in bulk.',
        maintenance: [
          { id: 'm3a', date: '2024-02-10', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm3b', date: '2024-02-10', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm3c', date: '2024-02-10', type: 'Fuel Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm3d', date: '2023-09-01', type: 'Spark Plug', notes: 'New ‚Äî from prior log', nextDue: '' },
          { id: 'm3e', date: '2023-09-01', type: 'Air Filter', notes: 'New ‚Äî from prior log', nextDue: '' },
          { id: 'm3f', date: '2023-10-01', type: 'Fuel Filter', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h3a', date: '2024-02-10', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h3b', date: '2024-07-15', hours: 12, notes: 'Tree work', total: 17 },
          { id: 'h3c', date: '2024-11-20', hours: 9, notes: 'Winter wood prep', total: 26 },
        ],
        parts: [
          { id: 'p3a', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #1141-120-1600 ‚Äî same as MS251. Fits MS231/251/261/271/291/311/391.' },
          { id: 'p3b', date: '2025-01-01', part: 'Fuel Filter (Pickup Body)', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #0000-350-3518 ‚Äî orange/red filter body. Same as MS251.' },
          { id: 'p3c', date: '2025-01-01', part: 'Spark Plug NGK BPMR7A', cost: 0, where: 'Stihl Dealer / NGK / Amazon', notes: 'OEM #0000-400-7000 ‚Äî NGK BPMR7A. Same as MS251. Replace annually.' },
          { id: 'p3d', date: '2025-01-01', part: 'Service Kit (all 3 parts)', cost: 0, where: 'Stihl Dealer', notes: 'OEM Kit #1141-007-1800 ‚Äî bundles air filter, fuel filter, spark plug for MS261/271/291/311/391.' }
        ],
        totalHours: 26
      },
      {
        id: 'e10',
        name: 'Cyclone Tow-Behind Leaf Vac',
        type: 'üçÇ Leaf Blower',
        year: '2015',
        engine: 'Vanguard 6.5HP 205cc OHV',
        serial: '15 0406 88 06338',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: true,
        notes: 'Engine: B&S Vanguard 200 Series, 205cc single-cylinder OHV (mfg April 2015). Oil: Vanguard 15W-50 Full Synthetic (~18-20oz). Spark Plug: B&S #597383. Air Filter: #596760. Official Maintenance Kit #84006008 includes all parts + Sta-Bil. Change oil at first 5hrs break-in, then every 50hrs or annually.',
        serviceIntervals: [
          { task: 'Oil Change',  hours: 50,  icon: 'üõ¢', note: 'Vanguard 15W-50 Full Synthetic, ~18-20oz. Change every 50hrs or annually, whichever comes first. First change at 5hrs break-in.' },
          { task: 'Air Filter',  hours: 25,  icon: 'üí®', note: '#596760 cartridge ‚Äî clean every 25hrs, replace annually. More frequently in dusty conditions.' },
          { task: 'Spark Plug',  hours: 100, icon: 'üî©', note: '#597383 ‚Äî gap 0.030". Replace annually or every 100hrs.' },
        ],
        maintenance: [
          { id: 'm10a', date: '2024-03-15', type: 'Oil Change', notes: 'Break-in oil change ‚Äî Vanguard 15W-50 Full Synthetic', nextDue: '2025-03-15' },
          { id: 'm10b', date: '2024-03-15', type: 'Air Filter', notes: 'Break-in service', nextDue: '2025-03-15' },
          { id: 'm10c', date: '2024-03-15', type: 'Spark Plug', notes: 'Break-in service', nextDue: '2025-03-15' },
          { id: 'm10d', date: '2023-03-10', type: 'Oil Change', notes: 'From prior log (Cyclone)', nextDue: '' },
          { id: 'm10e', date: '2023-03-10', type: 'Spark Plug', notes: 'From prior log (Cyclone)', nextDue: '' },
          { id: 'm10f', date: '2023-03-10', type: 'Air Filter', notes: 'From prior log (Cyclone)', nextDue: '' },
        ],
        hours: [
          { id: 'h10a', date: '2024-03-15', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h10b', date: '2024-10-25', hours: 8, notes: 'Fall leaf cleanup', total: 13 },
          { id: 'h10c', date: '2024-11-10', hours: 7, notes: 'Late fall cleanup', total: 22.5 },
        ],
        parts: [
          { id: 'p10a', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Briggs & Stratton / Amazon', notes: 'OEM #596760 ‚Äî cartridge-style, fits all Vanguard 200 Series single-cylinder engines (12V332/336/337/352/367).' },
          { id: 'p10b', date: '2025-01-01', part: 'Spark Plug', cost: 0, where: 'Briggs & Stratton / Amazon', notes: 'OEM #597383 ‚Äî fits Vanguard 200 Series (10V/12V/19V/25V series). Replace annually.' },
          { id: 'p10c', date: '2025-01-01', part: 'Engine Oil ‚Äî Vanguard 15W-50 Full Synthetic', cost: 0, where: 'Briggs & Stratton / Amazon', notes: 'OEM #100169 ‚Äî 1 qt bottle. MUST use Vanguard 15W-50, NOT standard SAE 30. ~18-20oz capacity.' },
          { id: 'p10d', date: '2025-01-01', part: 'Maintenance Kit (air filter + plug + oil + Sta-Bil)', cost: 0, where: 'Briggs & Stratton / Amazon', notes: 'OEM Kit #84006008 ‚Äî Vanguard 200 Series single-cylinder. Includes #596760 air filter, #597383 spark plug, 15W-50 oil, Sta-Bil.' }
        ],
        totalHours: 22.5
      },
      {
        id: 'e4',
        name: 'Echo ES-250 Shred-N-Vac',
        type: 'üçÇ Leaf Blower',
        year: '',
        engine: '25.4cc 2-stroke',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        notes: 'Fuel: 50:1 mix. Parts: Air Filter #A226-001410, Fuel Filter #A369-000480, Spark Plug NGK BPM8Y #15901019830. Echo Tune-Up Kit #90152Y includes all three. Replace spark plug & filters annually.',
        maintenance: [
          { id: 'm4a', date: '2024-02-10', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm4b', date: '2024-02-10', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm4c', date: '2024-02-10', type: 'Fuel Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm4d', date: '2023-10-01', type: 'Spark Plug', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h4a', date: '2024-02-10', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h4b', date: '2024-10-22', hours: 6, notes: 'Fall leaf cleanup', total: 11 },
          { id: 'h4c', date: '2024-11-08', hours: 5, notes: 'Late fall cleanup', total: 16 },
        ],
        parts: [
          { id: 'p4a', date: '2025-01-01', part: 'Air Filter (Double Layer)', cost: 0, where: 'Echo Dealer / Amazon / Home Depot', notes: 'OEM #A226001410 ‚Äî double-layer filter. Fits ES-250/ES-252, PB-250/PB-250LN, SRM-225, GT-225 and similar.' },
          { id: 'p4b', date: '2025-01-01', part: 'Fuel Filter', cost: 0, where: 'Echo Dealer / Amazon', notes: 'OEM #A369000480 ‚Äî fits inside fuel tank. Replace annually.' },
          { id: 'p4c', date: '2025-01-01', part: 'Spark Plug NGK BPM8Y', cost: 0, where: 'Echo Dealer / NGK / Amazon', notes: 'OEM #15901019830 ‚Äî NGK BPM8Y. Replace annually. Do not substitute with BPM7E (wrong heat range for ES-250).' },
          { id: 'p4d', date: '2025-01-01', part: 'Tune-Up Kit (all 3 parts)', cost: 0, where: 'Echo Dealer / Home Depot', notes: 'OEM Kit #90152Y ‚Äî includes air filter, fuel filter, spark plug. Fits ES-250, PB-250LN, SRM-225 and compatible models.' }
        ],
        totalHours: 16
      },
      {
        id: 'e5',
        name: 'Pressure Washer 2800 PSI',
        type: '‚öôÔ∏è Generator',
        year: '',
        engine: 'B&S 190cc OHV 8.5HP',
        serial: '',
        purchaseDate: '',
        oilInterval: 'annual',
        trackHours: false,
        notes: 'Engine oil: SAE 30 or 10W-30, ~20oz capacity. Spark Plug: NGK BPR6ES #796112, gap 0.030". Air Filter #591334. ALSO: Check pump oil (non-detergent SAE 30, 4-6oz) seasonally. Flush pump with clean water after every use. Winterize: drain ALL water from pump to prevent freeze damage.',
        maintenance: [
          { id: 'm5a', date: '2024-03-01', type: 'Oil Change', notes: 'Break-in oil change ‚Äî SAE 30', nextDue: '' },
          { id: 'm5b', date: '2024-03-01', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm5c', date: '2024-03-01', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm5d', date: '2023-05-27', type: 'Oil Change', notes: 'From prior log', nextDue: '' },
          { id: 'm5e', date: '2023-05-27', type: 'Air Filter', notes: 'From prior log', nextDue: '' },
          { id: 'm5f', date: '2023-06-02', type: 'Grease / Lube', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h5a', date: '2024-03-01', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h5b', date: '2024-05-12', hours: 4, notes: 'Deck and driveway wash', total: 9 },
          { id: 'h5c', date: '2024-08-20', hours: 6, notes: 'House exterior wash', total: 15 },
        ],
        parts: [
          { id: 'p5a', date: '2025-01-01', part: 'Spark Plug NGK BPR6ES', cost: 0, where: 'Briggs & Stratton / NGK / Amazon', notes: 'OEM #796112 (B&S) ‚Äî NGK BPR6ES. Gap: 0.030". Fits B&S 190cc pressure washer engines.' },
          { id: 'p5b', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Briggs & Stratton / Amazon', notes: 'OEM #591334 ‚Äî fits B&S 190cc OHV pressure washer engine. Replace annually.' },
          { id: 'p5c', date: '2025-01-01', part: 'Pump Oil (non-detergent SAE 30)', cost: 0, where: 'Hardware store / Amazon', notes: 'Non-detergent SAE 30 pump oil, ~4-6oz capacity. Check seasonally. Do NOT use motor oil with detergents.' }
        ],
        totalHours: 15
      },
      {
        id: 'e6',
        name: 'Push Mower (B&S EXi625)',
        type: 'üåø Lawn Mower',
        year: '',
        engine: 'B&S EXi625 150cc OHV',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        annualService: true,
        notes: 'NO OIL CHANGES NEEDED ‚Äî EXi series is check & add only. Use SAE 30 or 5W-30 synthetic. Parts: Spark Plug #692051 / 496018S (NGK BKR5E), Air Filter #593260. Maintenance Kit #84002441 includes both plus oil. Replace air filter & spark plug annually.',
        maintenance: [
          { id: 'm6a', date: '2024-04-01', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm6c', date: '2022-05-01', type: 'Spark Plug', notes: 'New ‚Äî from prior log', nextDue: '' },
          { id: 'm6b', date: '2024-04-01', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
        ],
        hours: [
          { id: 'h6a', date: '2024-04-01', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h6b', date: '2024-05-10', hours: 4, notes: 'Spring mowing', total: 9 },
          { id: 'h6c', date: '2024-07-14', hours: 4, notes: 'Summer mowing', total: 13 },
          { id: 'h6d', date: '2024-09-22', hours: 4, notes: 'Fall mowing', total: 17 },
        ],
        parts: [
          { id: 'p6a', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Briggs & Stratton / Home Depot / Amazon', notes: 'OEM #593260 ‚Äî fits B&S EX/EXi 500E/550E/625EX/675EX/725EXi series. Replace annually.' },
          { id: 'p6b', date: '2025-01-01', part: 'Spark Plug', cost: 0, where: 'Briggs & Stratton / Home Depot / Amazon', notes: 'OEM #692051 (also sold as #496018S) ‚Äî NGK BKR5E equivalent. Replace annually. NOTE: EXi625 does NOT require oil changes ‚Äî check & add only.' },
          { id: 'p6c', date: '2025-01-01', part: 'Maintenance Kit (filter + plug + oil)', cost: 0, where: 'Briggs & Stratton / Tractor Supply', notes: 'OEM Kit #84002441 ‚Äî for EX/EXi Series engines. Includes #593260 air filter, #496018S spark plug, 18oz SAE 30 oil.' }
        ],
        totalHours: 17
      },
      {
        id: 'e7',
        name: 'Champion 27-Ton Log Splitter',
        type: '‚öôÔ∏è Generator',
        year: '',
        engine: 'Champion 224cc OHV',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: true,
        notes: 'Engine oil: 10W-30, ~0.6qt. Spark Plug: F6RTC #100009378, gap 0.028-0.031". Air Filter: foam/washable ‚Äî clean with soap & water, re-oil. HYDRAULIC SYSTEM: AW46 fluid, ~4.5 gal tank. Change hydraulic filter at first 50hrs then annually. Retract ram fully before storage to protect rod.',
        serviceIntervals: [
          { task: 'Oil Change',        hours: 25,  icon: 'üõ¢', note: 'Engine oil ‚Äî 10W-30, ~0.6qt. Change every 25hrs or annually.' },
          { task: 'Spark Plug',        hours: 100, icon: 'üî©', note: 'F6RTC #100009378 ‚Äî gap 0.028-0.031". Replace every 100hrs or annually.' },
          { task: 'Air Filter',        hours: 100, icon: 'üí®', note: 'Foam/washable filter ‚Äî clean every 25hrs, replace every 100hrs.' },
          { task: 'Hydraulic Filter',  hours: 50,  icon: 'üîß', note: 'Change at first 50hrs, then every 100hrs or annually. Fram PH9342 / Wix 51361.' },
          { task: 'Hydraulic Oil',     hours: 100, icon: 'üõ¢', note: 'AW46 hydraulic fluid ‚Äî 4.5 gal tank. Change every 100hrs or if discolored/contaminated.' },
          { task: 'Grease / Lube',     hours: 25,  icon: '‚öôÔ∏è', note: 'Lubricate wedge, beam, and all moving parts every 25hrs.' },
        ],
        maintenance: [
          { id: 'm7a', date: '2024-01-20', type: 'Oil Change', notes: 'Break-in oil change ‚Äî 10W-30', nextDue: '2025-01-20' },
          { id: 'm7b', date: '2024-01-20', type: 'Air Filter', notes: 'Break-in service ‚Äî foam cleaned', nextDue: '2025-01-20' },
          { id: 'm7c', date: '2024-01-20', type: 'Spark Plug', notes: 'Break-in service', nextDue: '2025-01-20' },
          { id: 'm7d', date: '2021-11-22', type: 'Oil Change', notes: 'From prior log', nextDue: '' },
          { id: 'm7e', date: '2021-11-22', type: 'Spark Plug', notes: 'From prior log', nextDue: '' },
          { id: 'm7f', date: '2021-11-22', type: 'Air Filter', notes: 'From prior log', nextDue: '' },
          { id: 'm7g', date: '2022-09-02', type: 'Hydraulic Oil', notes: 'From prior log', nextDue: '2023-09-02' },
          { id: 'm7h', date: '2022-09-03', type: 'Hydraulic Filter', notes: 'From prior log', nextDue: '2023-09-03' },
        ],
        hours: [
          { id: 'h7a', date: '2024-01-20', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h7b', date: '2024-02-15', hours: 8, notes: 'Firewood splitting', total: 13 },
          { id: 'h7c', date: '2024-11-10', hours: 10, notes: 'Winter wood prep', total: 23 },
          { id: 'h7d', date: '2025-01-05', hours: 8, notes: 'Winter splitting run', total: 59.6 },
        ],
        parts: [
          { id: 'p7a', date: '2025-01-01', part: 'Spark Plug F6RTC', cost: 0, where: 'Champion Power Equipment / Amazon', notes: 'OEM #100009378 ‚Äî F6RTC (NHSP). Alt: NGK BPR6ES. Gap: 0.028-0.031". Replace annually.' },
          { id: 'p7b', date: '2025-01-01', part: 'Air Filter (foam)', cost: 0, where: 'Champion Power Equipment / Amazon', notes: 'Foam/pre-cleaner style ‚Äî washable. Clean with soap & water, re-oil lightly, let dry before reinstalling. Do not use compressed air.' },
          { id: 'p7c', date: '2025-01-01', part: 'Hydraulic Oil Filter', cost: 0, where: 'Auto parts store / Amazon', notes: 'OEM cross-refs: Fram PH9342, Wix 51361, K&N HP-2008. All 3/4"-16 thread. Change at first 50hrs, then annually.' },
          { id: 'p7d', date: '2025-01-01', part: 'Hydraulic Fluid AW46', cost: 0, where: 'Tractor Supply / Amazon / Fleet Farm', notes: 'AW46 (ISO 46) hydraulic oil ‚Äî 4.5 gallon tank capacity. Change when contaminated or discolored.' },
          { id: 'p7e', date: '2025-01-01', part: 'Engine Oil 10W-30', cost: 0, where: 'Any auto/hardware store', notes: 'SAE 10W-30 motor oil ‚Äî ~0.6qt / 0.5L capacity. Change every 25hrs or annually.' }
        ],
        totalHours: 59.6
      },
      {
        id: 'e9',
        name: 'Stihl FS 70R Trimmer',
        type: '‚úÇÔ∏è String Trimmer',
        year: '',
        engine: '27.2cc 2-stroke',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: false,
        notes: 'Fuel: 50:1 mix. Parts: Air Filter #4144-124-2800, Fuel Filter (replace annually), Spark Plug CMR6H (same as MS171). Replace spark plug every 100hrs or annually. Replace fuel pickup body every year. Clean air filter every 5hrs of use. Trimmer line: round .095" line recommended.',
        maintenance: [
          { id: 'm9a', date: '2024-04-01', type: 'Air Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm9b', date: '2024-04-01', type: 'Spark Plug', notes: 'Break-in service', nextDue: '' },
          { id: 'm9c', date: '2024-04-01', type: 'Fuel Filter', notes: 'Break-in service', nextDue: '' },
          { id: 'm9d', date: '2023-10-01', type: 'Spark Plug', notes: 'From prior log', nextDue: '' },
          { id: 'm9e', date: '2023-10-01', type: 'Air Filter', notes: 'From prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h9a', date: '2024-04-01', hours: 5, notes: 'Break-in period', total: 5 },
          { id: 'h9b', date: '2024-05-18', hours: 4, notes: 'Trimming season start', total: 9 },
          { id: 'h9c', date: '2024-07-20', hours: 5, notes: 'Summer trimming', total: 14 },
          { id: 'h9d', date: '2024-09-15', hours: 4, notes: 'Fall edging', total: 18 },
        ],
        parts: [
          { id: 'p9a', date: '2025-01-01', part: 'Air Filter', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'OEM #4144-124-2800 ‚Äî fits FS40/50/56/70, FC56/70, KM56, HT56C. Clean every 5hrs, replace annually.' },
          { id: 'p9b', date: '2025-01-01', part: 'Fuel Filter / Pickup Body', cost: 0, where: 'Stihl Dealer / Amazon', notes: 'Fuel pickup body inside tank ‚Äî replace annually. Same small-bore filter style as other Stihl trimmers.' },
          { id: 'p9c', date: '2025-01-01', part: 'Spark Plug NGK CMR6H', cost: 0, where: 'Stihl Dealer / NGK / Amazon', notes: 'OEM #0000-400-7015 ‚Äî NGK CMR6H (same as Stihl MS171). Replace every 100hrs or annually.' }
        ],
        totalHours: 18
      },
      {
        id: 'e8',
        name: 'Husqvarna YTH2348',
        type: 'üöú Riding Mower',
        year: '',
        engine: 'B&S Intek 23HP 724cc V-Twin',
        serial: '',
        purchaseDate: '',
        oilInterval: 999,
        trackHours: true,
        notes: 'Oil: SAE 30 or 10W-30 synthetic, ~48oz with filter. TWO spark plugs needed: #491055S (Champion RC12YC). Air Filter #273658S + Pre-Cleaner #272403S (do NOT oil pre-cleaner). Oil Filter: B&S #492056 / Wix 51056. Deck Belt #532144959, Drive Belt #532139776, Blades #532138971. Change oil BEFORE storage (not after season).',
        serviceIntervals: [
          { task: 'Oil Change',        hours: 25,  icon: 'üõ¢', note: 'SAE 30 or 10W-30 synthetic, ~48oz with filter. Change every 25hrs. Always change before storage.' },
          { task: 'Oil Filter',        hours: 50,  icon: 'üîß', note: 'B&S #492056 / Wix 51056. Replace every 50hrs or every other oil change.' },
          { task: 'Spark Plug',        hours: 100, icon: 'üî©', note: 'TWO plugs ‚Äî #491055S (Champion RC12YC). Replace annually or every 100hrs.' },
          { task: 'Air Filter',        hours: 100, icon: 'üí®', note: '#273658S cartridge + #272403S pre-cleaner. Replace annually or every 100hrs. Do NOT oil pre-cleaner.' },
          { task: 'Blade Sharpen',     hours: 25,  icon: 'üî™', note: 'Inspect and sharpen every 25hrs or each season. Replace #532138971 blades when worn.' },
          { task: 'Grease / Lube',     hours: 25,  icon: '‚öôÔ∏è', note: 'Grease spindle zerks, front wheel bearing zerks every 25hrs with general-purpose grease.' },
          { task: 'Belt Inspection',   hours: 100, icon: 'üîó', note: 'Check deck belt #532144959 and drive belt #532139776 for wear/cracking every 100hrs.' },
        ],
        maintenance: [
          { id: 'm8a', date: '2024-04-05', type: 'Oil Change', notes: 'Break-in oil change ‚Äî 10W-30 synthetic, oil filter replaced', nextDue: '' },
          { id: 'm8b', date: '2024-04-05', type: 'Air Filter', notes: 'Break-in service ‚Äî primary and pre-cleaner', nextDue: '' },
          { id: 'm8c', date: '2024-04-05', type: 'Spark Plug', notes: 'Break-in service ‚Äî both plugs replaced', nextDue: '' },
          { id: 'm8d', date: '2024-04-05', type: 'Blade Sharpen', notes: 'Start of season sharpening', nextDue: '' },
          { id: 'm8i', date: '2021-11-21', type: 'Oil Change', notes: '610 hrs ‚Äî from prior log', nextDue: '' },
          { id: 'm8e', date: '2023-03-05', type: 'Oil Change', notes: '678 hrs ‚Äî from prior log', nextDue: '' },
          { id: 'm8f', date: '2023-03-05', type: 'Oil Filter', notes: '678 hrs ‚Äî from prior log', nextDue: '' },
          { id: 'm8g', date: '2023-03-05', type: 'Spark Plug', notes: '678 hrs ‚Äî from prior log', nextDue: '' },
          { id: 'm8h', date: '2023-03-05', type: 'Air Filter', notes: '678 hrs ‚Äî from prior log', nextDue: '' },
        ],
        hours: [
          { id: 'h8z', date: '2023-03-05', hours: 993.2, notes: 'Actual hours on meter as of latest reading', total: 993.2 },

        ],
        parts: [
          { id: 'p8a', date: '2025-01-01', part: 'Spark Plug (x2 needed)', cost: 0, where: 'Briggs & Stratton / AutoZone / Amazon', notes: 'OEM #491055S ‚Äî Champion RC12YC equivalent. V-Twin engine needs TWO plugs. Pre-gapped. Replace annually.' },
          { id: 'p8b', date: '2025-01-01', part: 'Air Filter (primary cartridge)', cost: 0, where: 'Husqvarna / Briggs & Stratton / Amazon', notes: 'OEM #273658S ‚Äî pleated paper cartridge for B&S Intek V-Twin. Replace annually or when dirty.' },
          { id: 'p8c', date: '2025-01-01', part: 'Pre-Cleaner (foam wrap)', cost: 0, where: 'Husqvarna / Briggs & Stratton / Amazon', notes: 'OEM #272403S ‚Äî foam pre-cleaner. Do NOT oil it (causes air restriction). Clean/replace separately from main filter.' },
          { id: 'p8d', date: '2025-01-01', part: 'Oil Filter', cost: 0, where: 'Briggs & Stratton / AutoZone / Amazon', notes: 'OEM B&S #492056 ‚Äî also Wix 51056. Change every 25hrs with oil. ~48oz total oil capacity with filter.' },
          { id: 'p8e', date: '2025-01-01', part: 'Deck Belt', cost: 0, where: 'Husqvarna / Amazon / Jack\'s Small Engines', notes: 'OEM Husqvarna #532144959 ‚Äî 48" deck drive belt. Inspect annually for cracking/fraying.' },
          { id: 'p8f', date: '2025-01-01', part: 'Drive Belt (ground drive)', cost: 0, where: 'Husqvarna / Amazon / Jack\'s Small Engines', notes: 'OEM Husqvarna #532139776 ‚Äî ground drive / transmission belt. Inspect annually.' },
          { id: 'p8g', date: '2025-01-01', part: 'Mower Blades (set)', cost: 0, where: 'Husqvarna / Amazon / Oregon', notes: 'OEM Husqvarna #532138971 ‚Äî 48" deck blades. Sharpen each season, replace when worn/bent.' }
        ],
        totalHours: 993.2
      }
    ]
  };
  // Save a snapshot of just the static seed fields for use by resetAppData later
  const seedSnapshot = demo.equipment.map(e => ({
    id: e.id, name: e.name, type: e.type, year: e.year, engine: e.engine,
    serial: e.serial, purchaseDate: e.purchaseDate, oilInterval: e.oilInterval,
    trackHours: e.trackHours, notes: e.notes,
    parts: e.parts.filter(p => (parseFloat(p.cost)||0) === 0),
    maintenance: [], hours: [], totalHours: 0
  }));
  localStorage.setItem('gearlog_seed_snapshot', JSON.stringify(seedSnapshot));
  localStorage.setItem('gearlog_seed_version', '2026-02-19');
  save(demo);
}

function _buildSeedEquipment() {
  // Returns static seed fields from the hardcoded demo object.
  // We store a snapshot of the seed equipment (no logs) when seedDemo first runs,
  // so resetAppData always has the canonical names/parts to restore to.
  const snap = localStorage.getItem('gearlog_seed_snapshot');
  if (snap) return JSON.parse(snap);
  // Fallback: extract static fields from current data (best effort)
  const data = load();
  return data.equipment.map(e => ({
    id: e.id, name: e.name, type: e.type, year: e.year, engine: e.engine,
    serial: e.serial, purchaseDate: e.purchaseDate, oilInterval: e.oilInterval,
    trackHours: e.trackHours, notes: e.notes,
    parts: e.parts.filter(p => (parseFloat(p.cost)||0) === 0),
    maintenance: [], hours: [], totalHours: 0
  }));
}

// ---------- Data hygiene ----------
function deduplicateRefParts() {
  // One-time cleanup: remove duplicate cost=0 parts (same name) from each equipment
  const data = load();
  let changed = false;
  data.equipment.forEach(eq => {
    const seen = new Map();
    const cleaned = [];
    eq.parts.forEach(p => {
      const cost = parseFloat(p.cost) || 0;
      if (cost > 0) { cleaned.push(p); return; } // always keep purchased entries
      const key = p.part.trim().toLowerCase();
      if (!seen.has(key)) { seen.set(key, true); cleaned.push(p); }
      else { changed = true; } // duplicate found ‚Äî skip it
    });
    eq.parts = cleaned;
  });
  if (changed) save(data);
}

// ---------- Render ----------
function renderAll() {
  seedDemo();
  deduplicateRefParts();
  rebuildKitMaps();
  const data = load();
  renderEquipmentGrid(data);
  if (currentEquipId) renderDetail();
}

function getIcon(type) {
  return type ? type.split(' ')[0] : 'üîß';
}

function renderEquipmentGrid(data) {
  const tbody = document.getElementById('equipmentGridBody');
  if (!data.equipment.length) {
    if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="no-logs"><div class="icon">üåø</div>No equipment yet ‚Äî add your first piece of gear above.</td></tr>`;
    return;
  }
  const allIssues = getMaintenanceIssues(data);
  if (!tbody) return;

  tbody.innerHTML = data.equipment.map(eq => {
    const isActive = eq.id === currentEquipId;
    const equipIssues = allIssues.filter(i => i.equipId === eq.id);
    const hasDue = equipIssues.some(i => i.status === 'due');
    const hasSoon = equipIssues.some(i => i.status === 'soon');
    const serviceFlag = hasDue
      ? `<span class="service-flag flag-due">‚ö†Ô∏è Service Needed</span>`
      : hasSoon
      ? `<span class="service-flag flag-soon">üîî Service Soon</span>`
      : `<span style="font-size:0.75rem;color:var(--green-light)">‚úì Good</span>`;

    const maintSorted = [...eq.maintenance].sort((a,b) => b.date.localeCompare(a.date));
    const lastMaint = maintSorted[0];
    const lastOil = eq.maintenance.filter(m => m.type === 'Oil Change').sort((a,b) => b.date.localeCompare(a.date))[0];
    const totalCost = eq.parts.reduce((s,p) => s + (parseFloat(p.cost)||0), 0);

    const intervalText = eq.oilInterval === 'annual'
      ? '<span style="font-size:0.75rem;color:var(--text-muted);font-style:italic">Annual</span>'
      : eq.oilInterval >= 999
      ? '<span style="font-size:0.75rem;color:var(--text-muted);font-style:italic">Two-Stroke</span>'
      : eq.oilInterval + ' hrs';

    return `<tr class="${isActive ? 'active-row' : ''}" onclick="selectEquipment('${eq.id}')" style="cursor:pointer">
      <td>
        <div style="display:flex;align-items:center;gap:10px">
          <span style="font-size:1.4rem">${getIcon(eq.type)}</span>
          <div>
            <div style="font-weight:600;font-size:0.95rem">${eq.name}</div>
            <div style="font-size:0.74rem;color:var(--text-muted)">${eq.engine || ''}</div>
          </div>
        </div>
      </td>
      <td>${serviceFlag}</td>
      <td style="font-family:'DM Mono',monospace;font-size:0.88rem">${eq.trackHours ? (eq.totalHours || 0) : '<span style="color:var(--text-light)">‚Äî</span>'}</td>
      <td style="font-size:0.82rem">${lastMaint ? fmtDate(lastMaint.date) + '<br><span style="font-size:0.73rem;color:var(--text-muted)">' + lastMaint.type + '</span>' : '‚Äî'}</td>
      <td onclick="event.stopPropagation()">
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="card-btn" onclick="selectEquipment('${eq.id}'); openLogMaintenance()">+ Maint.</button>
          ${eq.trackHours ? `<button class="card-btn" onclick="selectEquipment('${eq.id}'); openLogHours()">+ Hrs</button>` : ''}
          <button class="card-btn" onclick="selectEquipment('${eq.id}'); openLogPart()">+ Parts</button>
          <button class="card-btn" style="color:var(--text-muted)" onclick="openEditEquipment('${eq.id}')">‚úèÔ∏è Edit</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

// ---------- Page navigation ----------
let currentPage = 'garage';
let shopFilter = 'all';
let checkedParts = JSON.parse(localStorage.getItem('gearlog_checked') || '{}');
let shopExpandedState = {}; // persists across renderShopping calls
let replacedByKit = JSON.parse(localStorage.getItem('gearlog_replaced_by_kit') || '{}');

function switchPage(page) {
  currentPage = page;
  document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.top-nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.getElementById('nav-' + page).classList.add('active');
  if (page === 'reminders') renderReminders();
  if (page === 'shopping') renderShopping();
  if (page === 'history') renderHistory();
}

function renderAlerts(data) {
  const issues = getMaintenanceIssues(data);
  const dueCount = issues.filter(i => i.status === 'due').length;

  // Badge on reminders nav
  const badge = document.getElementById('reminderBadge');
  if (dueCount > 0) {
    badge.textContent = dueCount;
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }

  // Compact alert banners in garage view (only overdue)
  const overdue = issues.filter(i => i.status === 'due');
  const area = document.getElementById('alertsArea');
  area.innerHTML = overdue.map(a =>
    `<div class="alert-banner">‚ö†Ô∏è <span><strong>${a.equip}</strong>: ${a.task} ‚Äî ${a.detail}</span></div>`
  ).join('');
}

// ---- Maintenance issue detection ----
function getHoursSinceLastService(eq, taskType) {
  // Returns hours elapsed since last log entry of a given type
  const matches = eq.maintenance.filter(m => m.type === taskType).sort((a,b) => b.date.localeCompare(a.date));
  if (!matches.length) return null;
  const lastDate = matches[0].date;
  const hoursAfter = eq.hours.filter(h => h.date > lastDate).reduce((s,h) => s + parseFloat(h.hours||0), 0);
  return hoursAfter;
}

function getMaintenanceIssues(data) {
  const issues = [];
  const today = new Date();
  // Track which tasks have already been flagged (avoid double-reporting via nextDue AND interval)
  const flagged = new Set();

  data.equipment.forEach(eq => {

    // 1. Per-task hour-based intervals ‚Äî only for machines with actual hour meters
    if (eq.trackHours && eq.serviceIntervals && eq.serviceIntervals.length) {
      eq.serviceIntervals.forEach(si => {
        const key = eq.id + '|' + si.task;
        const hoursSince = getHoursSinceLastService(eq, si.task);
        const hasEverDone = eq.maintenance.some(m => m.type === si.task);
        if (hoursSince !== null) {
          const pct = hoursSince / si.hours;
          if (pct >= 1) {
            issues.push({ equip: eq.name, equipId: eq.id, task: si.task, icon: si.icon || 'üîß',
              detail: `${Math.round(hoursSince)}hrs since last service ‚Äî interval: every ${si.hours}hrs`,
              status: 'due' });
            flagged.add(key);
          } else if (pct >= 0.8) {
            issues.push({ equip: eq.name, equipId: eq.id, task: si.task, icon: si.icon || 'üîß',
              detail: `${Math.round(hoursSince)}hrs since last ‚Äî due at ${si.hours}hrs`,
              status: 'soon' });
            flagged.add(key);
          }
        } else if (eq.totalHours > si.hours && !hasEverDone) {
          issues.push({ equip: eq.name, equipId: eq.id, task: si.task, icon: si.icon || 'üîß',
            detail: `Never logged ‚Äî ${si.hours}hr interval exceeded (${eq.totalHours}hrs on machine)`,
            status: 'due' });
          flagged.add(key);
        }
      });
    }

    // 2. Legacy oil change detection (for equipment without hour-based serviceIntervals)
    if (!eq.trackHours || !eq.serviceIntervals || !eq.serviceIntervals.some(si => si.task === 'Oil Change')) {
      if (eq.oilInterval === 'annual') {
        const oilChanges = eq.maintenance.filter(m => m.type === 'Oil Change').sort((a,b)=>b.date.localeCompare(a.date));
        if (oilChanges.length) {
          const daysSince = Math.round((new Date() - new Date(oilChanges[0].date)) / 86400000);
          if (daysSince >= 365) {
            issues.push({ equip: eq.name, equipId: eq.id, task: 'Oil Change', icon: 'üõ¢',
              detail: `Last changed ${daysSince} days ago ‚Äî annual change due`, status: 'due' });
          } else if (daysSince >= 300) {
            issues.push({ equip: eq.name, equipId: eq.id, task: 'Oil Change', icon: 'üõ¢',
              detail: `Last changed ${daysSince} days ago ‚Äî annual change coming up`, status: 'soon' });
          }
        } else {
          issues.push({ equip: eq.name, equipId: eq.id, task: 'Oil Change', icon: 'üõ¢',
            detail: 'No oil change logged ‚Äî annual change required', status: 'due' });
        }
      } else if (eq.oilInterval && eq.oilInterval < 999) {
        const hoursSince = getHoursSinceLastOilChange(eq);
        if (hoursSince !== null) {
          const pct = hoursSince / eq.oilInterval;
          if (pct >= 1) {
            issues.push({ equip: eq.name, equipId: eq.id, task: 'Oil Change', icon: 'üõ¢',
              detail: `${Math.round(hoursSince)}hrs since last change (interval: ${eq.oilInterval}hrs)`, status: 'due' });
          } else if (pct >= 0.8) {
            issues.push({ equip: eq.name, equipId: eq.id, task: 'Oil Change', icon: 'üõ¢',
              detail: `${Math.round(hoursSince)}hrs since last change (interval: ${eq.oilInterval}hrs)`, status: 'soon' });
          }
        } else if (eq.totalHours > 0) {
          issues.push({ equip: eq.name, equipId: eq.id, task: 'Oil Change', icon: 'üõ¢',
            detail: `No oil change logged yet (${eq.totalHours}hrs on equipment)`, status: 'due' });
        }
      }
    }

    // 3. nextDue date reminders from maintenance log entries
    eq.maintenance.forEach(m => {
      if (!m.nextDue) return;
      const d = new Date(m.nextDue);
      if (!isNaN(d)) {
        const diffDays = Math.round((d - today) / 86400000);
        if (diffDays < 0) {
          issues.push({ equip: eq.name, equipId: eq.id, task: m.type, icon: 'üîß',
            detail: `Was due ${Math.abs(diffDays)} days ago (${fmtDate(m.nextDue)})`, status: 'due' });
        } else if (diffDays <= 14) {
          issues.push({ equip: eq.name, equipId: eq.id, task: m.type, icon: 'üîß',
            detail: `Due in ${diffDays} day${diffDays === 1 ? '' : 's'} (${fmtDate(m.nextDue)})`, status: 'soon' });
        }
      }
    });

    // 4. Annual checks ‚Äî only for equipment without per-task hour intervals for that task
    const annualChecks = ['Air Filter', 'Spark Plug', 'Fuel Filter', 'Fuel Filter (Pickup Body)',
      'Tune-Up', 'Oil Filter', 'Hydraulic Oil', 'Hydraulic Filter', 'Blade Sharpen', 'Grease / Lube'];
    annualChecks.forEach(checkType => {
      // Skip if this task is already handled by hour-based serviceIntervals on a metered machine
      if (eq.trackHours && eq.serviceIntervals && eq.serviceIntervals.some(si => si.task === checkType)) return;
      const matches = eq.maintenance.filter(m => m.type === checkType);
      if (!matches.length) return;
      const lastDone = matches.sort((a, b) => b.date.localeCompare(a.date))[0];
      const daysSince = Math.round((today - new Date(lastDone.date)) / 86400000);
      if (daysSince >= 365) {
        issues.push({ equip: eq.name, equipId: eq.id, task: checkType, icon: 'üìÖ',
          detail: `Last done ${daysSince} days ago ‚Äî annual replacement recommended`,
          status: daysSince >= 400 ? 'due' : 'soon' });
      }
    });
  });

  // Deduplicate: if same task on same equipment appears multiple times, keep highest severity
  const seen = new Map();
  issues.forEach(i => {
    const k = i.equipId + '|' + i.task;
    if (!seen.has(k) || (i.status === 'due' && seen.get(k).status !== 'due')) seen.set(k, i);
  });
  return [...seen.values()];
}

// ---- Summary View ----
// ---- To-Do List View ----
let todoChecked = JSON.parse(localStorage.getItem('gearlog_todo') || '{}');
let customShopItems = JSON.parse(localStorage.getItem('gearlog_custom_shop') || '[]');
// Ensure items without a checked property default to true
customShopItems.forEach(i => { if (i.checked === undefined) i.checked = true; });

function saveCustomShop() {
  localStorage.setItem('gearlog_custom_shop', JSON.stringify(customShopItems));
}

function addToShoppingList(key, taskName, equipName, equipId) {
  if (customShopItems.some(i => i.key === key)) return;
  customShopItems.push({ key, taskName, equipName, equipId, checked: true, addedAt: new Date().toISOString() });
  saveCustomShop();
  // Also pre-check the matching part key in checkedParts so it renders checked immediately
  const data = load();
  const matchedPart = findPartForTask(equipId, taskName);
  if (matchedPart) {
    const partKey = equipId + '_' + matchedPart.id;
    checkedParts[partKey] = true;
    localStorage.setItem('gearlog_checked', JSON.stringify(checkedParts));
  }
  renderReminders();
  renderShopping();
  // Flash feedback
  const btn = event.target;
  btn.textContent = '‚úì Added!';
  btn.style.color = 'var(--green)';
  btn.style.borderColor = 'var(--green)';
}

function toggleCustomShopCheck(key) {
  // This is now just a fallback for items with no matched part.
  // Most amber-box items have a matched part and use toggleCheckAndItem instead.
  const item = customShopItems.find(i => i.key === key);
  if (!item) return;
  item.checked = !item.checked;
  saveCustomShop();
  checkKitOpportunity(item.equipId);
  renderShopping();
}

// Toggles a parts-reference checkbox AND its linked customShopItem together.
// Used by amber-box items that have a matched part in the equipment reference list.
function toggleCheckAndItem(partKey, itemKey) {
  const item = customShopItems.find(i => i.key === itemKey);
  const newState = item ? !item.checked : !checkedParts[partKey];
  checkedParts[partKey] = newState;
  localStorage.setItem('gearlog_checked', JSON.stringify(checkedParts));
  if (item) { item.checked = newState; saveCustomShop(); }
  if (newState && item) checkKitOpportunity(item.equipId);
  renderShopping();
}

function removeCustomShopItem(key) {
  customShopItems = customShopItems.filter(i => i.key !== key);
  saveCustomShop();
  renderShopping();
  renderReminders(); // flip button back
}

function saveTodo() {
  localStorage.setItem('gearlog_todo', JSON.stringify(todoChecked));
}

function toggleTodo(key) {
  const wasChecked = !!todoChecked[key];
  todoChecked[key] = !wasChecked;
  saveTodo();

  // When checking an _install key, auto-log it to the maintenance record
  if (!wasChecked && key.endsWith('_install')) {
    // Key format: equipId_taskName_install
    // equipId is always 2-3 chars like 'e1', task can have spaces/slashes
    const withoutSuffix = key.slice(0, key.lastIndexOf('_install'));
    // equipId is everything up to the first underscore
    const firstUnderscore = withoutSuffix.indexOf('_');
    const equipId = withoutSuffix.slice(0, firstUnderscore);
    const taskName = withoutSuffix.slice(firstUnderscore + 1);

    const data = load();
    const eq = data.equipment.find(e => e.id === equipId);
    if (eq) {
      // Don't duplicate ‚Äî check if same task was already logged today
      const todayStr = today();
      const alreadyLogged = eq.maintenance.some(m =>
        m.date === todayStr && m.type.toLowerCase() === taskName.toLowerCase() && m.auto
      );
      if (!alreadyLogged) {
        const autoNextDue = shouldAutoNextDue(eq, taskName) ? oneYearOut(todayStr) : '';
        eq.maintenance.push({
          id: uid(),
          date: todayStr,
          type: taskName,
          notes: 'Auto-logged from To-Do',
          nextDue: autoNextDue,
          auto: true
        });
        save(data);
      }
    }
  }

  renderReminders();
}

function clearTodo() {
  todoChecked = {};
  saveTodo();
  renderReminders();
}

function renderReminders() {
  const data = load();
  const issues = getMaintenanceIssues(data);
  const el = document.getElementById('remindersContent');

  if (!issues.length) {
    el.innerHTML = `<div class="reminder-card status-ok" style="max-width:480px">
      <div class="reminder-icon">‚úÖ</div>
      <div class="reminder-body">
        <div class="reminder-task">All Clear!</div>
        <div class="reminder-detail">No overdue or upcoming maintenance detected. Keep logging your hours and service records to get accurate reminders.</div>
      </div>
    </div>`;
    return;
  }

  // Group issues by equipment
  const byEquip = {};
  issues.forEach(issue => {
    if (!byEquip[issue.equipId]) byEquip[issue.equipId] = { name: issue.equip, issues: [] };
    byEquip[issue.equipId].issues.push(issue);
  });
  // Also include equipment that has resolved installs but no remaining active issues
  // so their progress bar still renders (showing 100% or partial progress)
  resolvedInstallKeys.forEach(k => {
    const firstUnderscore = k.indexOf('_');
    const equipId = k.slice(0, firstUnderscore);
    if (!byEquip[equipId]) {
      const eq = data.equipment.find(e => e.id === equipId);
      if (eq) byEquip[equipId] = { name: eq.name, issues: [] };
    }
  });

  // Total subtask progress ‚Äî include resolved installs (they disappear from issues once logged)
  const currentInstallKeys = new Set(issues.map(i => i.equipId + '_' + i.task + '_install'));
  const resolvedInstallKeys = Object.keys(todoChecked).filter(k => k.endsWith('_install') && todoChecked[k] && !currentInstallKeys.has(k));
  const totalSubtasks = issues.length + resolvedInstallKeys.length;
  const doneSubtasks = resolvedInstallKeys.length + [...currentInstallKeys].filter(k => todoChecked[k]).length;
  const pct = totalSubtasks > 0 ? Math.min(100, Math.round((doneSubtasks / totalSubtasks) * 100)) : 0;

  let html = '';

  // Overall progress bar
  html += `<div style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:16px 20px;margin-bottom:22px;display:flex;align-items:center;gap:16px;box-shadow:var(--shadow-sm)">
    <div style="font-size:1.4rem">üõ†</div>
    <div style="flex:1">
      <div style="font-weight:700;font-size:0.92rem;margin-bottom:6px">${doneSubtasks} of ${totalSubtasks} sub-tasks complete</div>
      <div style="height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;border:1px solid var(--border)">
        <div style="width:${pct}%;height:100%;background:${pct===100?'var(--green-light)':'var(--amber)'};border-radius:4px;transition:width 0.3s"></div>
      </div>
    </div>
    <div style="font-family:'DM Mono',monospace;font-size:1.1rem;font-weight:700;color:${pct===100?'var(--green)':'var(--amber)'}">${pct}%</div>
  </div>`;

  Object.entries(byEquip).forEach(([equipId, group]) => {
    const groupResolvedKeys = resolvedInstallKeys.filter(k => k.startsWith(equipId + '_'));
    const groupSubtasks = group.issues.length + groupResolvedKeys.length;
    const groupDone = groupResolvedKeys.length + group.issues.reduce((sum, issue) => {
      const k2 = equipId + '_' + issue.task + '_install';
      return sum + (todoChecked[k2] ? 1 : 0);
    }, 0);
    const allDone = groupSubtasks > 0 && groupDone === groupSubtasks;

    const tasksHtml = group.issues.map(issue => {
      const orderKey = equipId + '_' + issue.task + '_order';
      const installKey = equipId + '_' + issue.task + '_install';
      const orderDone = !!todoChecked[orderKey];
      const installDone = !!todoChecked[installKey];
      const shopKey = equipId + '|' + issue.task;
      const alreadyOnList = customShopItems.some(i => i.key === shopKey);
      return `<div class="todo-task">
        <div class="todo-task-header">
          <span class="todo-task-icon">${issue.icon}</span>
          <span class="todo-task-name">${issue.task}</span>
          <span class="todo-task-badge badge-${issue.status}">${issue.status === 'due' ? 'Overdue' : 'Due Soon'}</span>
        </div>
        <div class="todo-task-detail">${issue.detail}</div>
        <div class="todo-subtasks">
          <div class="todo-subtask ${installDone ? 'done' : ''}" onclick="toggleTodo('${installKey}')">
            <div class="todo-subtask-check">${installDone ? '‚úì' : ''}</div>
            <span class="todo-subtask-label">\u{1F527} Install part</span>
          </div>
        </div>
        <div style="padding-left:30px;margin-top:8px">
          ${alreadyOnList
            ? '<button class="card-btn" style="font-size:0.72rem;color:var(--green);border-color:var(--green);padding:4px 10px" onclick="removeCustomShopItem(\'' + shopKey + '\')" title="Click to remove from shopping list">\u2713 On list \u2013 remove?</button>'
            : '<button class="card-btn" style="font-size:0.72rem;color:var(--amber);border-color:var(--amber);padding:4px 10px" onclick="addToShoppingList(\'' + shopKey + '\',\'' + issue.task + '\',\'' + group.name + '\',\'' + equipId + '\')">\u{1F6D2} + Shopping List</button>'
          }
        </div>
      </div>`;
    }).join('');

    html += `<div class="todo-equip-group">
      <div class="todo-equip-header" onclick="toggleTodoGroup('${equipId}')">
        <div class="todo-equip-title">
          ${getIcon(data.equipment.find(e=>e.id===equipId)?.type||'')} ${group.name}
          <span class="todo-equip-count ${allDone ? 'all-done' : ''}">${allDone ? '‚úì Done' : groupDone + '/' + groupSubtasks}</span>
        </div>
        <span class="todo-equip-collapse" id="collapse-${equipId}" style="transform:rotate(-90deg)">‚ñº</span>
      </div>
      <div id="todo-tasks-${equipId}" class="todo-tasks" style="display:none">${tasksHtml}</div>
      <div class="todo-progress">
        <div class="todo-progress-bar-wrap"><div class="todo-progress-bar" style="width:${groupSubtasks > 0 ? Math.round(groupDone/groupSubtasks*100) : 0}%"></div></div>
        <span>${groupSubtasks > 0 ? Math.round(groupDone/groupSubtasks*100) : 0}% complete</span>
      </div>
    </div>`;
  });

  // Snapshot which groups are currently expanded before replacing HTML
  const expanded = new Set();
  document.querySelectorAll('[id^="todo-tasks-"]').forEach(node => {
    if (node.style.display !== 'none') expanded.add(node.id);
  });

  el.innerHTML = html;

  // Restore expanded state
  expanded.forEach(id => {
    const node = document.getElementById(id);
    if (node) {
      node.style.display = '';
      const equipId = id.replace('todo-tasks-', '');
      const arrow = document.getElementById('collapse-' + equipId);
      if (arrow) arrow.style.transform = '';
    }
  });
}

function collapseAllTodo() {
  document.querySelectorAll('[id^="todo-tasks-"]').forEach(el => {
    const equipId = el.id.replace('todo-tasks-', '');
    el.style.display = 'none';
    const arrow = document.getElementById('collapse-' + equipId);
    if (arrow) arrow.style.transform = 'rotate(-90deg)';
  });
}

function toggleTodoGroup(equipId) {
  const tasks = document.getElementById('todo-tasks-' + equipId);
  const arrow = document.getElementById('collapse-' + equipId);
  const hidden = tasks.style.display === 'none';
  tasks.style.display = hidden ? '' : 'none';
  if (arrow) arrow.style.transform = hidden ? '' : 'rotate(-90deg)';
}

function toggleShopGroup(equipId) {
  const items = document.getElementById('shop-items-' + equipId);
  const arrow = document.getElementById('shop-arrow-' + equipId);
  const hidden = items.style.display === 'none';
  items.style.display = hidden ? 'block' : 'none';
  if (arrow) arrow.style.transform = hidden ? 'rotate(0deg)' : 'rotate(-90deg)';
  shopExpandedState['shop-items-' + equipId] = hidden; // true = now expanded
}

function openAmazonExport() {
  const data = load();
  const issues = getMaintenanceIssues(data);

  // Build a map of which parts need service per equipment
  function partNeedsServiceLocal(equipId, partName) {
    const pn = partName.toLowerCase();
    for (const issue of issues) {
      if (issue.equipId !== equipId) continue;
      const task = issue.task.toLowerCase();
      if (pn.includes(task) || task.includes(pn.split(' ')[0])) return true;
      if ((pn.includes('air filter') || pn.includes('pre-cleaner')) && task === 'air filter') return true;
      if (pn.includes('spark plug') && task === 'spark plug') return true;
      if (pn.includes('fuel filter') && (task === 'fuel filter' || task === 'fuel filter (pickup body)')) return true;
      if (pn.includes('oil filter') && task === 'oil filter') return true;
      if ((pn.includes('engine oil') || (pn.includes('oil') && !pn.includes('filter') && !pn.includes('hydraulic') && !pn.includes('pump'))) && task === 'oil change') return true;
      if ((pn.includes('hydraulic oil') || pn.includes('hydraulic fluid') || pn.includes('aw46')) && task === 'hydraulic oil') return true;
      if (pn.includes('hydraulic') && pn.includes('filter') && task === 'hydraulic filter') return true;
      if ((pn.includes('blade') || pn.includes('sharpen')) && task === 'blade sharpen') return true;
      if ((pn.includes('pump oil') || pn.includes('non-detergent')) && task === 'grease / lube') return true;
    }
    return false;
  }

  let lines = [];
  lines.push("SHIVELY'S GEARLOG ‚Äî SHOPPING LIST");
  lines.push('Generated: ' + new Date().toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'}));
  lines.push('‚ïê'.repeat(48));

  let totalItems = 0;

  // Include custom To-Do items that are checked
  const checkedCustom = customShopItems.filter(i => i.checked);
  if (checkedCustom.length) {
    lines.push('');
    lines.push('FROM TO-DO LIST');
    lines.push('‚îÄ'.repeat(36));
    checkedCustom.forEach(i => {
      lines.push('‚Ä¢ ' + i.taskName + '  (' + i.equipName + ')');
      totalItems++;
    });
  }

  // Include parts reference items that are checked
  data.equipment.forEach(eq => {
    const needed = eq.parts.filter(p => {
      const key = eq.id + '_' + p.id;
      return !!checkedParts[key];
    });
    if (!needed.length) return;

    lines.push('');
    lines.push(eq.name.toUpperCase());
    lines.push('‚îÄ'.repeat(36));

    needed.forEach(p => {
      const oemMatch = (p.notes || '').match(/OEM[^‚Äî#]*#([\w\-]+)/i);
      const oemNum = oemMatch ? oemMatch[1] : null;
      lines.push('‚Ä¢ ' + p.part + (oemNum ? '  [#' + oemNum + ']' : ''));
      if (p.where) lines.push('  Where to buy: ' + p.where);
      totalItems++;
    });
  });

  if (totalItems === 0) {
    lines = ["Nothing checked off yet ‚Äî tick the checkboxes next to what you need to buy, then export."];
  } else {
    lines.push('');
    lines.push('‚ïê'.repeat(48));
    lines.push('TOTAL ITEMS: ' + totalItems);
  }

  document.getElementById('amazonExportText').value = lines.join('\n');
  document.getElementById('copyExportBtn').textContent = 'üìã Copy to Clipboard';
  document.getElementById('modalAmazonExport').classList.add('visible');
}

function copyAmazonExport() {
  const text = document.getElementById('amazonExportText');
  text.select();
  text.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(text.value).then(() => {
    const btn = document.getElementById('copyExportBtn');
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = 'üìã Copy to Clipboard', 2000);
  }).catch(() => {
    document.execCommand('copy');
    const btn = document.getElementById('copyExportBtn');
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = 'üìã Copy to Clipboard', 2000);
  });
}

function collapseAllShop() {
  document.querySelectorAll('[id^="shop-items-"]').forEach(el => {
    const equipId = el.id.replace('shop-items-', '');
    el.style.display = 'none';
    const arrow = document.getElementById('shop-arrow-' + equipId);
    if (arrow) arrow.style.transform = 'rotate(-90deg)';
  });
}

// ---- Shopping List ----
function setShopFilter(f, btn) {
  shopFilter = f;
  document.querySelectorAll('.shop-filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderShopping();
}

// Kit relationships: defined by part name patterns, built dynamically from actual loaded data.
// A "kit" part is one whose name contains 'kit' or 'tune-up kit'.
// Its components are the non-kit parts for the same equipment whose names are substrings of the kit's notes.
let KIT_COMPONENTS = {};   // kitKey -> [compKeys]
let COMPONENT_TO_KIT = {}; // compKey -> kitKey


// Check whether all customShopItems for an equipment map to components of a known kit.
// If so, prompt the user to switch to the kit.
function checkKitOpportunity(equipId) {
  rebuildKitMaps(); // ensure maps are current
  const items = customShopItems.filter(i => i.equipId === equipId && !i.isKit && i.checked);
  if (items.length < 2) return;
  const compKeys = items.map(i => {
    const m = findPartForTask(i.equipId, i.taskName);
    return m ? equipId + '_' + m.id : null;
  }).filter(Boolean);
  if (compKeys.length < 2) return;
  const kitKey = Object.keys(KIT_COMPONENTS).find(k =>
    k.startsWith(equipId + '_') &&
    compKeys.every(ck => KIT_COMPONENTS[k].includes(ck))
  );
  if (kitKey) setTimeout(() => showKitPrompt(kitKey, compKeys), 150);
}

function rebuildKitMaps() {
  KIT_COMPONENTS = {};
  COMPONENT_TO_KIT = {};
  const data = load();
  data.equipment.forEach(eq => {
    const refParts = eq.parts.filter(p => (parseFloat(p.cost) || 0) === 0);
    const kits = refParts.filter(p => /kit/i.test(p.part));
    const nonKits = refParts.filter(p => !/kit/i.test(p.part));
    kits.forEach(kit => {
      const kitKey = eq.id + '_' + kit.id;
      const kitNotes = (kit.notes || '').toLowerCase();
      const kitPart = kit.part.toLowerCase();
      // Find components: non-kit parts whose name appears in the kit's notes or part name
      const compKeys = nonKits
        .filter(p => {
          const pn = p.part.toLowerCase();
          // Check if this part's name is mentioned in the kit notes or kit part name
          return kitNotes.includes(pn) || kitPart.includes(pn) ||
            // Common keyword matches
            (pn.includes('air filter') && (kitNotes.includes('air filter') || kitPart.includes('all'))) ||
            (pn.includes('spark plug') && (kitNotes.includes('spark plug') || kitPart.includes('all'))) ||
            (pn.includes('fuel filter') && (kitNotes.includes('fuel filter') || kitPart.includes('all'))) ||
            (pn.includes('oil') && !pn.includes('filter') && kitNotes.includes('oil') && !pn.includes('hydraulic')) ;
        })
        .map(p => eq.id + '_' + p.id);
      if (compKeys.length >= 2) {
        KIT_COMPONENTS[kitKey] = compKeys;
        compKeys.forEach(ck => { COMPONENT_TO_KIT[ck] = kitKey; });
      }
    });
  });
}

let pendingKitSwitch = null; // { kitKey, compKeys, equipName, kitPartName, kitOemNum }

function showKitPrompt(kitKey, compKeys) {
  const firstUnderscore = kitKey.indexOf('_');
  const equipId = kitKey.slice(0, firstUnderscore);
  const kitPartId = kitKey.slice(firstUnderscore + 1);
  const data = load();
  const eq = data.equipment.find(e => e.id === equipId);
  if (!eq) return;
  const kitPart = eq.parts.find(p => p.id === kitPartId);
  if (!kitPart) return;

  const oemMatch = (kitPart.notes || '').match(/OEM[^‚Äî#]*#([\w\-]+)/i);
  const oemNum = oemMatch ? oemMatch[1] : null;
  const compNames = compKeys.map(ck => {
    const cPartId = ck.slice(equipId.length + 1);
    const cp = eq.parts.find(p => p.id === cPartId);
    return cp ? cp.part : ck;
  });

  pendingKitSwitch = { kitKey, compKeys, equipId };

  const body = document.getElementById('kitPromptBody');
  body.innerHTML = `
    <p style="margin:0 0 12px;font-size:0.95rem">You've checked all ${compKeys.length} individual parts for <strong>${eq.name}</strong>. A kit is available that includes everything:</p>
    <div style="background:var(--surface2);border-radius:8px;padding:12px 16px;margin-bottom:14px">
      <div style="font-family:var(--font-head);font-weight:700;font-size:1rem;margin-bottom:6px">${kitPart.part}</div>
      ${oemNum ? `<div style="font-family:var(--font-mono);font-size:0.78rem;color:var(--amber);margin-bottom:6px">#${oemNum}</div>` : ''}
      <div style="font-size:0.8rem;color:var(--text-muted)">${kitPart.where || ''}</div>
    </div>
    <p style="margin:0;font-size:0.82rem;color:var(--text-muted)">Includes: ${compNames.join(', ')}</p>
  `;
  document.getElementById('modalKitPrompt').classList.add('visible');
}

function dismissKitPrompt() {
  pendingKitSwitch = null;
  document.getElementById('modalKitPrompt').classList.remove('visible');
}

function switchToKit() {
  if (!pendingKitSwitch) return;
  const { kitKey, compKeys, equipId } = pendingKitSwitch;
  const data = load();
  const eq = data.equipment.find(e => e.id === equipId);
  const kitPartId = kitKey.slice(equipId.length + 1);
  const kitPart = eq ? eq.parts.find(p => p.id === kitPartId) : null;

  // Mark individual components as replaced (strikethrough in parts list)
  compKeys.forEach(ck => {
    checkedParts[ck] = true;
    replacedByKit[ck] = kitKey;
  });
  localStorage.setItem('gearlog_replaced_by_kit', JSON.stringify(replacedByKit));

  // Check the kit in checkedParts
  checkedParts[kitKey] = true;
  localStorage.setItem('gearlog_checked', JSON.stringify(checkedParts));

  // Add the kit as a pre-checked item in the "From To-Do" shopping box
  if (kitPart && eq) {
    const shopKey = kitKey; // use kitKey as the unique identifier
    if (!customShopItems.some(i => i.key === shopKey)) {
      customShopItems.push({
        key: shopKey,
        taskName: kitPart.part,
        equipName: eq.name,
        equipId,
        checked: true,
        isKit: true,
        addedAt: new Date().toISOString()
      });
      saveCustomShop();
    }
  }

  dismissKitPrompt();
  renderShopping();
}

function toggleCheck(key) {
  const newState = !checkedParts[key];
  checkedParts[key] = newState;

  // Parse equipId from key (format: equipId_partId)
  const firstUnderscore = key.indexOf('_');
  const equipId = firstUnderscore > 0 ? key.slice(0, firstUnderscore) : null;
  const partId  = firstUnderscore > 0 ? key.slice(firstUnderscore + 1) : null;

  // Sync the matching amber-box item (if any) using findPartForTask for reliable matching
  if (equipId) {
    const syncItem = customShopItems.find(i => {
      if (i.equipId !== equipId) return false;
      const m = findPartForTask(i.equipId, i.taskName);
      return m && m.id === partId;
    });
    if (syncItem) { syncItem.checked = newState; saveCustomShop(); }
  }

  // Kit: if this IS a kit row, sync all its components
  if (KIT_COMPONENTS[key]) {
    KIT_COMPONENTS[key].forEach(compKey => {
      checkedParts[compKey] = newState;
      if (!newState) delete replacedByKit[compKey];
    });
    if (!newState) localStorage.setItem('gearlog_replaced_by_kit', JSON.stringify(replacedByKit));
  }

  // Kit: if this is a component and we just checked it, see if all siblings are now checked
  if (COMPONENT_TO_KIT[key] && newState) {
    const kitKey = COMPONENT_TO_KIT[key];
    if (KIT_COMPONENTS[kitKey].every(k => checkedParts[k])) {
      setTimeout(() => showKitPrompt(kitKey, KIT_COMPONENTS[kitKey]), 150);
    }
  }
  // Kit: unchecking a component also unchecks the kit
  if (COMPONENT_TO_KIT[key] && !newState) {
    checkedParts[COMPONENT_TO_KIT[key]] = false;
  }

  localStorage.setItem('gearlog_checked', JSON.stringify(checkedParts));

  // Kit opportunity: check if amber-box items for this equipment all have matching parts checked
  if (equipId && newState) checkKitOpportunity(equipId);

  renderShopping();
}

function openLogPartPrefilled_byKey(key) {
  const firstUnderscore = key.indexOf('_');
  const equipId = key.slice(0, firstUnderscore);
  const partId = key.slice(firstUnderscore + 1);
  const data = load();
  const eq = data.equipment.find(e => e.id === equipId);
  const part = eq ? eq.parts.find(p => p.id === partId) : null;
  if (eq && part) openLogPartPrefilled(eq, part);
}

function openLogPartPrefilled(eq, part) {
  // Set the current equipment context
  currentEquipId = eq.id;
  // Pre-fill the modal fields
  document.getElementById('pDate').value = today();
  document.getElementById('pPart').value = part.part;
  document.getElementById('pCost').value = '';
  document.getElementById('pWhere').value = part.where || '';
  // Pull OEM number into notes if present
  const oemMatch = (part.notes || '').match(/OEM[^#]*#([\w\-]+)/i);
  const oemRef = oemMatch ? 'OEM #' + oemMatch[1] + '. ' : '';
  document.getElementById('pNotes').value = oemRef + (part.notes || '');
  // Open with a banner indicating it came from shopping list
  openModal('modalPart');
  // Add a hint inside the modal header temporarily
  const header = document.querySelector('#modalPart .modal-header h3');
  if (header) {
    header.textContent = 'üõí Log Purchase ‚Äî ' + eq.name;
    setTimeout(() => { header.textContent = 'Log Part / Cost'; }, 8000);
  }
}

function resetAppData() {
  if (!confirm('Reset equipment names, parts lists, and service intervals to defaults?\n\nYour maintenance logs, hours, and purchase history will be preserved.')) return;

  // Hardcoded canonical equipment names and static fields
  // These are the source of truth regardless of what's in localStorage
  const canonicalNames = {
    e1: { name: 'Stihl MS 171 Chainsaw', type: 'ü™ö Chainsaw', engine: '31.8cc 2-stroke', oilInterval: 999, trackHours: false },
    e2: { name: 'Stihl MS 251 Wood Boss Chainsaw', type: 'ü™ö Chainsaw', engine: '45.6cc 2-stroke', oilInterval: 999, trackHours: false },
    e3: { name: 'Stihl MS 271 Farm Boss Chainsaw', type: 'ü™ö Chainsaw', engine: '50.2cc 2-stroke', oilInterval: 999, trackHours: false },
    e4: { name: 'Stihl FS 70R Trimmer', type: 'üåø Trimmer', engine: '27.2cc 2-stroke', oilInterval: 999, trackHours: false },
    e5: { name: 'Echo SRM-225 Trimmer', type: 'üåø Trimmer', engine: '21.2cc 2-stroke', oilInterval: 999, trackHours: false },
    e6: { name: 'Echo ES-250 Shred-N-Vac', type: 'üçÇ Blower/Vac', engine: '25.4cc 2-stroke', oilInterval: 999, trackHours: false },
    e7: { name: 'Push Mower (B&S EXi625)', type: 'üåø Mower', engine: 'B&S EXi 163cc 4-stroke', oilInterval: 'annual', trackHours: false },
    e8: { name: 'Husqvarna YTH2348 Riding Mower', type: 'üöú Riding Mower', engine: 'Briggs & Stratton 23HP', oilInterval: 100, trackHours: true },
    e9: { name: 'Cyclone Tow-Behind Leaf Vac', type: 'üçÇ Blower/Vac', engine: 'Vanguard 6.5HP 205cc 4-stroke', oilInterval: 'annual', trackHours: false },
    e10: { name: 'Champion 27-Ton Log Splitter', type: 'ü™µ Log Splitter', engine: 'Briggs & Stratton 208cc 4-stroke', oilInterval: 'annual', trackHours: false },
  };

  const data = load();
  let changed = false;

  data.equipment.forEach(eq => {
    const canonical = canonicalNames[eq.id];
    if (!canonical) return;
    eq.name = canonical.name;
    eq.type = canonical.type;
    eq.engine = canonical.engine;
    eq.oilInterval = canonical.oilInterval;
    eq.trackHours = canonical.trackHours;
    changed = true;
  });

  if (changed) {
    save(data);
    alert('Equipment names and settings restored. Your logs are intact.');
    location.reload();
  }
}

function clearChecked() {
  checkedParts = {};
  localStorage.setItem('gearlog_checked', JSON.stringify(checkedParts));
  renderShopping();
}

function partMatchesFilter(partName, notes) {
  const haystack = (partName + ' ' + notes).toLowerCase();
  if (shopFilter === 'all') return true;
  if (shopFilter === 'filter') return haystack.includes('filter') && !haystack.includes('oil filter') && !haystack.includes('hydraulic');
  if (shopFilter === 'plug') return haystack.includes('spark plug') || haystack.includes('cmr6h') || haystack.includes('bpmr7a') || haystack.includes('bpm8y') || haystack.includes('bpr6es');
  if (shopFilter === 'oil') return haystack.includes('oil') || haystack.includes('fluid') || haystack.includes('hydraulic') || haystack.includes('pump oil');
  if (shopFilter === 'belt') return haystack.includes('belt') || haystack.includes('blade') || haystack.includes('chain');
  return true;
}

// Global helper ‚Äî find the reference part object for a given task name + equipId
function findPartForTask(equipId, taskName) {
  const data = load();
  const eq = data.equipment.find(e => e.id === equipId);
  if (!eq) return null;
  const tn = taskName.toLowerCase();
  const refParts = eq.parts.filter(p => (parseFloat(p.cost) || 0) === 0);
  return refParts.find(p => {
    const pn = p.part.toLowerCase();
    if (pn.includes(tn) || tn.includes(pn.split(' ')[0])) return true;
    if ((pn.includes('air filter') || pn.includes('pre-cleaner')) && tn === 'air filter') return true;
    if (pn.includes('spark plug') && tn === 'spark plug') return true;
    if (pn.includes('fuel filter') && (tn === 'fuel filter' || tn.includes('fuel filter'))) return true;
    if (pn.includes('oil filter') && tn === 'oil filter') return true;
    if ((pn.includes('engine oil') || (pn.includes('oil') && !pn.includes('filter') && !pn.includes('hydraulic') && !pn.includes('pump'))) && tn === 'oil change') return true;
    if ((pn.includes('hydraulic oil') || pn.includes('hydraulic fluid') || pn.includes('aw46')) && tn === 'hydraulic oil') return true;
    if (pn.includes('hydraulic') && pn.includes('filter') && tn === 'hydraulic filter') return true;
    if ((pn.includes('blade') || pn.includes('sharpen')) && tn === 'blade sharpen') return true;
    if ((pn.includes('pump oil') || pn.includes('non-detergent')) && tn === 'grease / lube') return true;
    return false;
  }) || null;
}

function renderShopping() {
  const data = load();
  const el = document.getElementById('shoppingContent');
  if (!data.equipment.length) {
    el.innerHTML = '<p style="color:var(--text-muted)">No equipment added yet.</p>';
    return;
  }
  // Rebuild kit maps from current data (part IDs may differ from seed defaults)
  rebuildKitMaps();

  // Snapshot expanded state from DOM before rebuild (updates persistent state)
  document.querySelectorAll('[id^="shop-items-"]').forEach(div => {
    shopExpandedState[div.id] = div.style.display !== 'none';
  });

  // Get all current issues to cross-reference "needs service" state
  const issues = getMaintenanceIssues(data);
  const issueSet = new Set(issues.map(i => i.equipId + '|' + i.task.toLowerCase()));

  // Map part names to maintenance task names for matching
  function partNeedsService(equipId, partName) {
    const pn = partName.toLowerCase();
    // Direct task name matches
    for (const issue of issues) {
      if (issue.equipId !== equipId) continue;
      const task = issue.task.toLowerCase();
      if (pn.includes(task) || task.includes(pn.split(' ')[0])) return issue.status;
      // Specific mappings
      if ((pn.includes('air filter') || pn.includes('pre-cleaner')) && task === 'air filter') return issue.status;
      if (pn.includes('spark plug') && task === 'spark plug') return issue.status;
      if (pn.includes('fuel filter') && (task === 'fuel filter' || task === 'fuel filter (pickup body)')) return issue.status;
      if (pn.includes('oil filter') && task === 'oil filter') return issue.status;
      if ((pn.includes('engine oil') || (pn.includes('oil') && !pn.includes('filter') && !pn.includes('hydraulic') && !pn.includes('pump'))) && task === 'oil change') return issue.status;
      if ((pn.includes('hydraulic oil') || pn.includes('hydraulic fluid') || pn.includes('aw46')) && task === 'hydraulic oil') return issue.status;
      if (pn.includes('hydraulic') && pn.includes('filter') && task === 'hydraulic filter') return issue.status;
      if ((pn.includes('blade') || pn.includes('sharpen')) && task === 'blade sharpen') return issue.status;
      if ((pn.includes('pump oil') || pn.includes('non-detergent')) && task === 'grease / lube') return issue.status;
    }
    return null;
  }

  let html = '';

  // ---- Helper: find the matching part in eq.parts for a given task name ----
  // ---- Custom "From To-Do" items section ----
  if (customShopItems.length) {
    html += `<div style="background:var(--surface);border:1.5px solid var(--amber);border-radius:var(--radius);margin-bottom:22px;overflow:hidden;box-shadow:var(--shadow-sm)">
      <div style="padding:12px 20px;background:var(--amber-pale);border-bottom:1px solid var(--amber);display:flex;align-items:center;gap:10px">
        <span style="font-size:1rem">üõí</span>
        <span style="font-family:var(--font-head);font-weight:700;font-size:0.85rem;letter-spacing:0.06em;text-transform:uppercase;color:var(--amber)">From To-Do List</span>
        <span style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);margin-left:auto">${customShopItems.length} item${customShopItems.length !== 1 ? 's' : ''}</span>
      </div>
      <div style="padding:8px 20px 12px">`;
    customShopItems.forEach(item => {
      // Try to find a matching part in the reference list and share its checkedParts key
      const matchedPart = findPartForTask(item.equipId, item.taskName);
      const sharedKey = matchedPart ? item.equipId + '_' + matchedPart.id : null;
      // item.checked is the source of truth; sync checkedParts so the parts reference section matches
      if (sharedKey) {
        checkedParts[sharedKey] = item.checked; // always enforce, not just when different
        // (don't save to localStorage in a render loop ‚Äî caller saves as needed)
      }
      const isChecked = item.checked;
      const onClickFn = sharedKey
        ? `toggleCheckAndItem('${sharedKey}','${item.key}')`   // syncs both
        : `toggleCustomShopCheck('${item.key}')`;              // standalone fallback
      const matchNote = matchedPart
        ? `<span style="font-family:var(--font-mono);font-size:0.65rem;color:var(--green);margin-left:6px;opacity:0.8">‚Üî synced with parts ref</span>`
        : '';
      const matchedOem = matchedPart ? (matchedPart.notes || '').match(/OEM[^‚Äî#]*#([\w\-]+)/i) : null;
      const matchedOemNum = matchedOem ? matchedOem[1] : null;
      const customAmazonQuery = matchedOemNum
        ? encodeURIComponent(item.equipName + ' ' + item.taskName + ' ' + matchedOemNum)
        : encodeURIComponent(item.equipName + ' ' + item.taskName);
      const customAmazonBtn = `<a href="https://www.amazon.com/s?k=${customAmazonQuery}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;margin-top:6px;padding:4px 10px;background:var(--amber-pale);border:1px solid var(--amber);border-radius:4px;font-family:var(--font-mono);font-size:0.7rem;color:var(--amber);text-decoration:none;letter-spacing:0.04em" onmouseover="this.style.background='rgba(251,191,36,0.18)'" onmouseout="this.style.background='var(--amber-pale)'">üîç ${matchedOemNum ? '#' + matchedOemNum : 'Search Amazon'}</a>`;
      html += `<div style="display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);${isChecked ? 'opacity:0.8' : ''}">
        <div class="shop-check ${isChecked ? 'checked' : ''}" onclick="${onClickFn}" style="flex-shrink:0;margin-top:2px">${isChecked ? '‚úì' : ''}</div>
        <div style="flex:1;min-width:0">
          <div style="font-family:var(--font-head);font-weight:600;font-size:0.88rem;${isChecked ? 'text-decoration:line-through;color:var(--text-muted)' : ''}">${item.taskName}${matchNote}</div>
          <div style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);margin-top:2px">${item.equipName}</div>
          ${customAmazonBtn}
        </div>
        <button onclick="removeCustomShopItem('${item.key}')" style="background:none;border:none;cursor:pointer;color:var(--text-light);font-size:1rem;padding:2px 6px;border-radius:4px;transition:color 0.15s" title="Remove" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--text-light)'">‚úï</button>
      </div>`;
    });
    html += `</div></div>`;
  }

  // Build a set of task names already in the To-Do amber box for each equipment
  // so we can suppress duplicates in the parts reference sections below
  const todoShopKeys = new Set(customShopItems.map(i => i.equipId + '|' + i.taskName.toLowerCase()));

  data.equipment.forEach(eq => {
    // Only show reference parts (cost=0) ‚Äî purchased entries live in the Parts tab history
    // Deduplicate by part name (case-insensitive) ‚Äî keep earliest entry
    const refParts = eq.parts.filter(p => (parseFloat(p.cost) || 0) === 0);
    const seen = new Map();
    refParts.forEach(p => {
      const key = p.part.trim().toLowerCase();
      if (!seen.has(key)) seen.set(key, p);
    });
    const deduped = [...seen.values()];

    // Kit display logic:
    // - Kit is checked ‚Üí show kit, suppress its individual components
    // - Kit is NOT checked ‚Üí show components, suppress the kit row
    const dedupedIds = new Set(deduped.map(p => eq.id + '_' + p.id));
    const suppressedComponents = new Set(); // component part IDs to hide (kit selected)
    const suppressedKitIds = new Set();     // kit part IDs to hide (showing components instead)

    Object.entries(KIT_COMPONENTS).forEach(([kitKey, compKeys]) => {
      if (!kitKey.startsWith(eq.id + '_')) return;
      const kitPartId = kitKey.slice(eq.id.length + 1);
      const kitChecked = !!checkedParts[kitKey];
      const hasComponents = compKeys.some(ck => dedupedIds.has(ck));
      const anyReplaced = compKeys.some(ck => !!replacedByKit[ck]);
      if (kitChecked && anyReplaced) {
        // Kit selected via "switch to kit" ‚Äî show both kit AND struck-through components
        // (components render themselves as "replaced by kit", don't suppress them)
      } else if (kitChecked) {
        // Kit ticked manually ‚Äî hide individual components
        compKeys.forEach(ck => {
          const cPartId = ck.slice(eq.id.length + 1);
          suppressedComponents.add(cPartId);
        });
      } else if (hasComponents) {
        // Components shown individually ‚Äî hide the kit row
        suppressedKitIds.add(kitPartId);
      }
    });

    const filtered = deduped.filter(p =>
      !suppressedComponents.has(p.id) &&
      !suppressedKitIds.has(p.id) &&
      partMatchesFilter(p.part, p.notes || '')
    );
    if (!filtered.length) return;

    // A part "needs service" but is already in the To-Do amber box ‚Äî treat it as handled
    function isHandledByTodo(partName) {
      const pn = partName.toLowerCase();
      for (const issue of issues) {
        if (issue.equipId !== eq.id) continue;
        if (!todoShopKeys.has(eq.id + '|' + issue.task.toLowerCase())) continue;
        const task = issue.task.toLowerCase();
        if (pn.includes(task) || task.includes(pn.split(' ')[0])) return true;
        if ((pn.includes('air filter') || pn.includes('pre-cleaner')) && task === 'air filter') return true;
        if (pn.includes('spark plug') && task === 'spark plug') return true;
        if (pn.includes('fuel filter') && task.includes('fuel filter')) return true;
        if (pn.includes('oil filter') && task === 'oil filter') return true;
        if ((pn.includes('engine oil') || (pn.includes('oil') && !pn.includes('filter') && !pn.includes('hydraulic') && !pn.includes('pump'))) && task === 'oil change') return true;
        if ((pn.includes('hydraulic oil') || pn.includes('hydraulic fluid') || pn.includes('aw46')) && task === 'hydraulic oil') return true;
        if (pn.includes('hydraulic') && pn.includes('filter') && task === 'hydraulic filter') return true;
        if ((pn.includes('blade') || pn.includes('sharpen')) && task === 'blade sharpen') return true;
        if ((pn.includes('pump oil') || pn.includes('non-detergent')) && task === 'grease / lube') return true;
      }
      return false;
    }

    // Split into three explicitly exclusive buckets
    const needsService = filtered.filter(p => partNeedsService(eq.id, p.part) && !isHandledByTodo(p.part));
    const handledByTodo = filtered.filter(p => partNeedsService(eq.id, p.part) && isHandledByTodo(p.part));
    const refOnly = filtered.filter(p => !partNeedsService(eq.id, p.part) && !isHandledByTodo(p.part));

    const shopSectionId = 'shop-items-' + eq.id;
    const serviceCount = needsService.length;
    const countBadge = serviceCount > 0
      ? `<span style="font-size:0.72rem;font-weight:700;background:var(--red);color:white;border-radius:10px;padding:2px 8px;margin-left:8px">${serviceCount} needed</span>`
      : '';

    html += `<div class="shop-section" style="background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);margin-bottom:18px;overflow:hidden;box-shadow:var(--shadow-sm);padding:0">
      <div class="shop-section-title" style="cursor:pointer;padding:14px 20px;background:var(--surface2);margin:0;border-bottom:1.5px solid var(--border)" onclick="toggleShopGroup('${eq.id}')">
        <span style="font-weight:700;font-size:1rem">${getIcon(eq.type)} ${eq.name}${countBadge} <span style="color:var(--text-light);font-weight:400;font-size:0.68rem;margin-left:6px">${eq.engine||''}</span></span>
        <span style="display:flex;align-items:center;gap:12px">
          <span style="color:var(--text-light);font-weight:400;font-size:0.82rem">${filtered.length} part${filtered.length>1?'s':''}</span>
          <span id="shop-arrow-${eq.id}" style="color:var(--text-muted);font-size:0.85rem;transition:transform 0.2s;transform:rotate(-90deg)">‚ñº</span>
        </span>
      </div>
      <div id="${shopSectionId}" style="padding:0 20px;display:none">`;

    function renderPart(p, serviceStatus) {
      const key = eq.id + '_' + p.id;
      const checked = checkedParts[key];
      const isReplacedByKit = !!replacedByKit[key];
      const oemMatch = (p.notes || '').match(/OEM[^‚Äî#]*#([\w\-]+)/i);
      const oemNum = oemMatch ? oemMatch[1] : null;
      const urgencyBar = serviceStatus === 'due'
        ? `<span style="font-size:0.7rem;font-weight:700;background:var(--red);color:white;border-radius:4px;padding:1px 7px;margin-left:6px">OVERDUE</span>`
        : serviceStatus === 'soon'
        ? `<span style="font-size:0.7rem;font-weight:700;background:var(--amber);color:white;border-radius:4px;padding:1px 7px;margin-left:6px">DUE SOON</span>`
        : '';
      // Amazon query: model + part type + OEM# for best results
      // e.g. "Stihl MS 171 Air Filter 1139-120-1602"
      const amazonQuery = oemNum
        ? encodeURIComponent(eq.name + ' ' + p.part.replace(/\(.*?\)/g,'').trim() + ' ' + oemNum)
        : encodeURIComponent(eq.name + ' ' + p.part);
      const amazonBtn = `<a href="https://www.amazon.com/s?k=${amazonQuery}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;margin-top:8px;padding:5px 10px;background:var(--amber-pale);border:1px solid var(--amber);border-radius:4px;font-family:var(--font-mono);font-size:0.7rem;color:var(--amber);text-decoration:none;letter-spacing:0.04em;transition:background 0.15s" onmouseover="this.style.background='rgba(251,191,36,0.18)'" onmouseout="this.style.background='var(--amber-pale)'">üîç ${oemNum ? '#' + oemNum : 'Search Amazon'}</a>`;
      const logPurchaseBtn = checked
        ? `<button onclick="openLogPartPrefilled_byKey('${key}')" style="display:inline-flex;align-items:center;gap:5px;margin-top:8px;margin-left:6px;padding:5px 10px;background:none;border:1px solid var(--border-bright);border-radius:4px;font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);cursor:pointer;letter-spacing:0.04em;transition:all 0.15s" onmouseover="this.style.borderColor='var(--orange)';this.style.color='var(--orange)'" onmouseout="this.style.borderColor='var(--border-bright)';this.style.color='var(--text-muted)'">üí∞ Log Purchase</button>`
        : '';
      const isKit = !!KIT_COMPONENTS[key]; // kit rows never get struck through ‚Äî they're the replacement
      if (isReplacedByKit) {
        return `<div class="shop-item" style="opacity:0.45">
          <div class="shop-check checked" style="cursor:default">‚úì</div>
          <div class="shop-item-body">
            <div class="shop-item-name" style="text-decoration:line-through">${p.part}</div>
            <div style="font-family:var(--font-mono);font-size:0.68rem;color:var(--amber);margin-top:3px;letter-spacing:0.03em">‚Ü≥ replaced by kit</div>
          </div>
        </div>`;
      }
      return `<div class="shop-item" style="${checked && !isKit ? 'opacity:0.8' : ''}${serviceStatus === 'due' ? ';border-left:3px solid var(--red);padding-left:12px' : serviceStatus === 'soon' ? ';border-left:3px solid var(--amber);padding-left:12px' : ''}">
        <div class="shop-check ${checked ? 'checked' : ''}" onclick="toggleCheck('${key}')">${checked ? '‚úì' : ''}</div>
        <div class="shop-item-body">
          <div class="shop-item-name" style="${checked && !isKit ? 'text-decoration:line-through' : ''}">${p.part}${urgencyBar}</div>
          ${oemNum ? `<div class="shop-item-oem">#${oemNum}</div>` : ''}
          <div class="shop-item-meta" style="margin-top:4px">${p.notes || ''}</div>
          ${p.where ? `<div class="shop-item-where">üõí ${p.where}</div>` : ''}
          <div style="display:flex;flex-wrap:wrap;gap:0">${amazonBtn}${logPurchaseBtn}</div>
        </div>
      </div>`;
    }

    if (needsService.length) {
      html += `<div style="font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--red);padding:10px 0 6px">‚ö†Ô∏è Needs Service</div>`;
      needsService.forEach(p => { html += renderPart(p, partNeedsService(eq.id, p.part)); });
    }
    const refSection = [...handledByTodo, ...refOnly];
    if (refSection.length) {
      if (needsService.length) html += `<div style="font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--text-light);padding:10px 0 6px">Parts Reference</div>`;
      refSection.forEach(p => { html += renderPart(p, null); });
    }

    html += `</div></div>`;
  });

  el.innerHTML = html || `<div style="text-align:center;padding:40px;color:var(--text-muted)">No parts match this filter.</div>`;

  // Restore expanded/collapsed state after DOM rebuild
  document.querySelectorAll('[id^="shop-items-"]').forEach(div => {
    if (shopExpandedState[div.id] === true) {
      div.style.display = 'block';
      const equipId = div.id.replace('shop-items-', '');
      const arrow = document.getElementById('shop-arrow-' + equipId);
      if (arrow) arrow.style.transform = 'rotate(0deg)';
    }
  });
}

function getHoursSinceLastOilChange(eq) {
  const oils = eq.maintenance.filter(m => m.type === 'Oil Change').sort((a,b)=>b.date.localeCompare(a.date));
  if (!oils.length) return null;
  // Find total hours at time of last oil change - approximation: use current total - hours logged after that date
  const lastOilDate = oils[0].date;
  const hoursAfter = eq.hours.filter(h => h.date > lastOilDate).reduce((s,h)=>s+parseFloat(h.hours||0),0);
  return hoursAfter;
}

function closeDetailPanel() {
  document.getElementById('detailPanel').classList.remove('visible');
  currentEquipId = null;
  renderEquipmentGrid(load());
}

function selectEquipment(id) {
  currentEquipId = id;
  if (currentPage !== 'garage') switchPage('garage');
  renderAll();
  renderDetail();
  document.getElementById('detailPanel').classList.add('visible');
  document.getElementById('detailPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderDetail() {
  const data = load();
  const eq = data.equipment.find(e => e.id === currentEquipId);
  if (!eq) return;

  document.getElementById('detailIcon').textContent = getIcon(eq.type);
  document.getElementById('detailName').textContent = eq.name;
  document.getElementById('detailSub').textContent = [eq.year, eq.engine, eq.serial].filter(Boolean).join(' ¬∑ ');

  // Show/hide Hours tab and button based on trackHours flag
  const hoursTab = document.querySelector('.tab[onclick*="hours"]');
  const hoursContent = document.getElementById('tab-hours');
  const hoursBtn = document.querySelector('.detail-actions .btn[onclick*="openLogHours"]');
  const showHours = eq.trackHours === true;
  if (hoursTab) hoursTab.style.display = showHours ? '' : 'none';
  if (hoursContent) hoursContent.style.display = showHours ? '' : 'none';
  if (hoursBtn) hoursBtn.style.display = showHours ? '' : 'none';
  // If hours tab is active but hidden, switch to overview
  if (!showHours && currentTab === 'hours') switchTab('overview');

  // Notes / part numbers
  const notesEl = document.getElementById('equipNotes');
  const notesText = document.getElementById('equipNotesText');
  if (eq.notes) {
    notesEl.style.display = 'block';
    notesText.textContent = eq.notes;
  } else {
    notesEl.style.display = 'none';
  }

  // Overview stats
  const totalCost = eq.parts.reduce((s,p)=>s+(parseFloat(p.cost)||0),0);
  const totalMaint = eq.maintenance.length;
  document.getElementById('overviewStats').innerHTML = `
    ${eq.trackHours ? `<div class="stat-card"><div class="val">${eq.totalHours||0}</div><div class="lbl">Total Hours</div></div>` : ''}
    <div class="stat-card"><div class="val">${totalMaint}</div><div class="lbl">Services Logged</div></div>
    <div class="stat-card"><div class="val">$${totalCost.toFixed(2)}</div><div class="lbl">Total Parts Cost</div></div>
    <div class="stat-card"><div class="val">${eq.parts.length}</div><div class="lbl">Parts Logged</div></div>
  `;

  // Recent activity (all combined, sorted by date)
  const all = [
    ...eq.maintenance.map(m=>({date:m.date,type:'maintenance',label:m.type,desc:m.notes,cost:null})),
    ...eq.parts.map(p=>({date:p.date,type:'parts',label:p.part,desc:p.where,cost:p.cost})),
    ...eq.hours.map(h=>({date:h.date,type:'hours',label:`${h.hours} hrs`,desc:h.notes,cost:null})),
  ].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,10);

  const rBody = document.querySelector('#recentActivity tbody');
  rBody.innerHTML = all.length ? all.map(a=>`<tr>
    <td>${fmtDate(a.date)}</td>
    <td><span class="badge badge-${a.type}">${a.type}</span></td>
    <td>${a.label}${a.desc?` <span style="color:var(--text-light);font-size:0.8em">‚Äî ${a.desc}</span>`:''}</td>
    <td>${a.cost!=null?'$'+parseFloat(a.cost).toFixed(2):'‚Äî'}</td>
  </tr>`).join('') : '<tr><td colspan="4" class="no-logs"><div class="icon">üìã</div>No activity yet.</td></tr>';

  // Maintenance tab
  const mBody = document.querySelector('#maintenanceTable tbody');
  const mSorted = [...eq.maintenance].sort((a,b)=>b.date.localeCompare(a.date));
  mBody.innerHTML = mSorted.length ? mSorted.map(m=>`<tr>
    <td>${fmtDate(m.date)}</td>
    <td><span class="badge badge-maintenance">${m.type}</span></td>
    <td>${m.notes||'‚Äî'}${m.photo ? `<br><img src="${m.photo}" onclick="this.style.maxHeight=this.style.maxHeight?'':'400px'" style="max-height:60px;max-width:120px;border-radius:6px;cursor:pointer;margin-top:6px;border:1px solid var(--border);transition:max-height 0.3s" title="Click to expand">` : ''}</td>
    <td>${m.nextDue||'‚Äî'}</td>
    <td><button onclick="deleteMaintenance('${eq.id}','${m.id}')" style="background:none;border:none;cursor:pointer;color:var(--text-light);font-size:0.9rem;padding:2px 6px;border-radius:4px;transition:color 0.15s" title="Delete entry" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--text-light)'">‚úï</button></td>
  </tr>`).join('') : '<tr><td colspan="5" class="no-logs"><div class="icon">üîß</div>No maintenance logged yet.</td></tr>';

  // Hours tab
  const hBody = document.querySelector('#hoursTable tbody');
  const hSorted = [...eq.hours].sort((a,b)=>b.date.localeCompare(a.date));
  let runTotal = eq.totalHours || 0;
  hBody.innerHTML = hSorted.length ? hSorted.map(h=>`<tr>
    <td>${fmtDate(h.date)}</td>
    <td>${h.hours}</td>
    <td>${h.total}</td>
    <td>${h.notes||'‚Äî'}</td>
  </tr>`).join('') : '<tr><td colspan="4" class="no-logs"><div class="icon">‚è±</div>No hours logged yet.</td></tr>';

  // Parts tab ‚Äî OEM reference parts (from parts array, $0 cost = reference entries)
  const pContainer = document.getElementById('partsContent');
  if (!pContainer) return;

  if (!eq.parts.length) {
    pContainer.innerHTML = '<div class="no-logs"><div class="icon">üî©</div>No parts logged yet.</div>';
    return;
  }

  // Separate reference parts (cost=0, have OEM notes) from purchased parts (cost>0)
  const refParts = eq.parts.filter(p => (parseFloat(p.cost)||0) === 0);
  const purchasedParts = eq.parts.filter(p => (parseFloat(p.cost)||0) > 0);

  let pHtml = '';

  // OEM Reference section
  if (refParts.length) {
    pHtml += `<div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-light);margin-bottom:12px">üìã OEM Parts Reference</div>`;
    pHtml += refParts.map(p => {
      // Try to extract OEM number from notes (pattern: #XXXXXXXX)
      const oemMatch = p.notes ? p.notes.match(/OEM[^#]*#([\w\-]+)/) : null;
      const oemNum = oemMatch ? oemMatch[1] : null;
      return `<div style="background:var(--surface);border:1.5px solid var(--border);border-radius:9px;padding:13px 16px;margin-bottom:10px;display:flex;gap:14px;align-items:flex-start">
        <div style="font-size:1.3rem;flex-shrink:0;margin-top:1px">üî©</div>
        <div style="flex:1">
          <div style="font-weight:700;font-size:0.95rem;margin-bottom:3px">${p.part}</div>
          ${oemNum ? `<div style="font-family:'DM Mono',monospace;font-size:0.76rem;color:var(--amber);background:var(--amber-pale);border-radius:4px;padding:1px 7px;display:inline-block;margin-bottom:5px">#${oemNum}</div>` : ''}
          <div style="font-size:0.8rem;color:var(--text-muted);line-height:1.5">${p.notes||''}</div>
          ${p.where ? `<div style="font-size:0.76rem;color:var(--text-light);margin-top:4px">üõí ${p.where}</div>` : ''}
        </div>
      </div>`;
    }).join('');
  }

  // Purchased parts section
  if (purchasedParts.length) {
    const totalSpent = purchasedParts.reduce((s,p)=>s+(parseFloat(p.cost)||0),0);
    pHtml += `<div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-light);margin:20px 0 12px">üßæ Purchase History ‚Äî Total: $${totalSpent.toFixed(2)}</div>`;
    pHtml += `<table class="log-table"><thead><tr><th>Date</th><th>Part</th><th>Notes</th><th>Cost</th><th></th></tr></thead><tbody>`;
    pHtml += [...purchasedParts].sort((a,b)=>b.date.localeCompare(a.date)).map(p=>`<tr>
      <td>${fmtDate(p.date)}</td>
      <td>${p.part}</td>
      <td>${p.notes||p.where||'‚Äî'}</td>
      <td>$${parseFloat(p.cost||0).toFixed(2)}</td>
      <td><button onclick="deletePart('${eq.id}','${p.id}')" style="background:none;border:none;cursor:pointer;color:var(--text-light);font-size:0.9rem;padding:2px 6px;border-radius:4px;transition:color 0.15s" title="Delete entry" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--text-light)'">‚úï</button></td>
    </tr>`).join('');
    pHtml += '</tbody></table>';
  }

  pContainer.innerHTML = pHtml;
}

function fmtDate(d) {
  if (!d) return '‚Äî';
  const [y,m,day] = d.split('-');
  return `${m}/${day}/${y}`;
}

// ---------- Tabs ----------
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach((t,i) => {
    const tabs = ['overview','maintenance','hours','parts','qr'];
    t.classList.toggle('active', tabs[i] === tab);
  });
  document.querySelectorAll('.tab-content').forEach(tc => {
    tc.classList.toggle('active', tc.id === 'tab-'+tab);
  });
  if (tab === 'qr') renderQrTab();
}

// ---------- Modals ----------
function openModal(id) { document.getElementById(id).classList.add('visible'); }
function closeModal(id) { document.getElementById(id).classList.remove('visible'); }

function openAddEquipment() { openModal('modalAddEquipment'); }
function openLogMaintenance() {
  if (!currentEquipId) return;
  const d = today();
  document.getElementById('mDate').value = d;
  // Pre-fill nextDue with one year out if this equipment is calendar-based
  const data = load();
  const eq = data.equipment.find(e => e.id === currentEquipId);
  const isCalendar = eq && (eq.trackHours === false || eq.oilInterval === 'annual' || eq.annualService === true);
  const isHourBased = eq && eq.serviceIntervals && eq.serviceIntervals.length;
  if (isCalendar && !isHourBased) {
    document.getElementById('mNextDue').value = oneYearOut(d);
  } else {
    document.getElementById('mNextDue').value = '';
  }
  openModal('modalMaintenance');
}
function openLogHours() { if (!currentEquipId) return; document.getElementById('hDate').value = today(); openModal('modalHours'); }
function openLogPart() { if (!currentEquipId) return; document.getElementById('pDate').value = today(); openModal('modalPart'); }

function today() { return new Date().toISOString().slice(0,10); }
function uid() { return Math.random().toString(36).slice(2,8); }

// Returns a date string one year from a given date string (or today if omitted)
function oneYearOut(fromDate) {
  const d = fromDate ? new Date(fromDate) : new Date();
  d.setFullYear(d.getFullYear() + 1);
  return d.toISOString().slice(0, 10);
}

// Tasks that get annual service intervals on 2-stroke / calendar-based equipment
const ANNUAL_SERVICE_TASKS = ['Air Filter', 'Spark Plug', 'Fuel Filter', 'Fuel Filter (Pickup Body)',
  'Tune-Up', 'Oil Filter', 'Hydraulic Oil', 'Hydraulic Filter', 'Blade Sharpen', 'Grease / Lube', 'Oil Change'];

function shouldAutoNextDue(eq, taskType) {
  // Use annual next-due for: 2-stroke engines, 4-stroke no-meter engines, annual-interval machines
  // NOT for machines with hour-based serviceIntervals ‚Äî they track by hours
  if (!eq) return false;
  if (eq.serviceIntervals && eq.serviceIntervals.length) return false; // uses hour tracking
  // Calendar-based: no hour meter (trackHours=false) OR annual oil interval
  const isCalendarBased = eq.trackHours === false || eq.oilInterval === 'annual' || eq.annualService === true;
  return isCalendarBased && ANNUAL_SERVICE_TASKS.some(t => t.toLowerCase() === taskType.toLowerCase());
}

// ---------- Save Actions ----------
function openEditEquipment(equipId) {
  const data = load();
  const eq = data.equipment.find(e => e.id === equipId);
  if (!eq) return;
  document.getElementById('editEquipId').value = eq.id;
  document.getElementById('editEquipName').value = eq.name || '';
  document.getElementById('editEquipType').value = eq.type || 'üîß Other';
  document.getElementById('editEquipYear').value = eq.year || '';
  document.getElementById('editEquipEngine').value = eq.engine || '';
  document.getElementById('editEquipSerial').value = eq.serial || '';
  document.getElementById('editEquipDate').value = eq.purchaseDate || '';
  document.getElementById('editEquipNotes').value = eq.notes || '';
  openModal('modalEditEquipment');
}

function saveEditEquipment() {
  const id = document.getElementById('editEquipId').value;
  const name = document.getElementById('editEquipName').value.trim();
  if (!name) { alert('Equipment name is required.'); return; }
  const data = load();
  const eq = data.equipment.find(e => e.id === id);
  if (!eq) return;
  eq.name = name;
  eq.type = document.getElementById('editEquipType').value;
  eq.year = document.getElementById('editEquipYear').value;
  eq.engine = document.getElementById('editEquipEngine').value;
  eq.serial = document.getElementById('editEquipSerial').value;
  eq.purchaseDate = document.getElementById('editEquipDate').value;
  eq.notes = document.getElementById('editEquipNotes').value;
  save(data);
  closeModal('modalEditEquipment');
  renderAll();
}

function saveEquipment() {
  const name = document.getElementById('newEquipName').value.trim();
  if (!name) { alert('Please enter a name.'); return; }
  const data = load();
  const eq = {
    id: uid(),
    name,
    type: document.getElementById('newEquipType').value,
    year: document.getElementById('newEquipYear').value,
    engine: document.getElementById('newEquipEngine').value,
    serial: document.getElementById('newEquipSerial').value,
    purchaseDate: document.getElementById('newEquipDate').value,
    oilInterval: parseInt(document.getElementById('newEquipOilInterval').value)||50,
    notes: '',
    maintenance: [], hours: [], parts: [], totalHours: 0
  };
  data.equipment.push(eq);
  save(data);
  closeModal('modalAddEquipment');
  ['newEquipName','newEquipYear','newEquipEngine','newEquipSerial','newEquipDate'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('newEquipOilInterval').value='50';
  selectEquipment(eq.id);
}

function deleteMaintenance(equipId, maintId) {
  if (!confirm('Delete this maintenance entry?')) return;
  const data = load();
  const eq = data.equipment.find(e => e.id === equipId);
  if (!eq) return;
  eq.maintenance = eq.maintenance.filter(m => m.id !== maintId);
  save(data);
  renderAll();
}

function deleteMaintenance(equipId, maintenanceId) {
  if (!confirm('Delete this maintenance entry?')) return;
  const data = load();
  const eq = data.equipment.find(e => e.id === equipId);
  if (!eq) return;
  eq.maintenance = eq.maintenance.filter(m => m.id !== maintenanceId);
  save(data);
  renderAll();
  renderReminders();
}

function deletePart(equipId, partId) {
  if (!confirm('Delete this part entry?')) return;
  const data = load();
  const eq = data.equipment.find(e => e.id === equipId);
  if (!eq) return;
  eq.parts = eq.parts.filter(p => p.id !== partId);
  save(data);
  renderAll();
}

function saveMaintenance() {
  const data = load();
  const eq = data.equipment.find(e=>e.id===currentEquipId);
  if (!eq) return;
  const mDate = document.getElementById('mDate').value || today();
  const mType = document.getElementById('mType').value;
  const mNextDue = document.getElementById('mNextDue').value ||
    (shouldAutoNextDue(eq, mType) ? oneYearOut(mDate) : '');
  const entry = {
    id: uid(),
    date: mDate,
    type: mType,
    notes: document.getElementById('mNotes').value,
    nextDue: mNextDue,
  };
  // Attach photo if one was selected
  if (pendingMaintPhoto) {
    entry.photo = pendingMaintPhoto;
  }
  eq.maintenance.push(entry);
  save(data);
  closeModal('modalMaintenance');
  ['mNotes','mNextDue'].forEach(id=>document.getElementById(id).value='');
  clearMaintPhoto();
  renderAll();
}

function saveHours() {
  const hrs = parseFloat(document.getElementById('hHours').value);
  if (!hrs || hrs <= 0) { alert('Enter valid hours.'); return; }
  const data = load();
  const eq = data.equipment.find(e=>e.id===currentEquipId);
  if (!eq) return;
  eq.totalHours = (eq.totalHours||0) + hrs;
  eq.hours.push({
    id: uid(),
    date: document.getElementById('hDate').value || today(),
    hours: hrs,
    notes: document.getElementById('hNotes').value,
    total: eq.totalHours,
  });
  save(data);
  closeModal('modalHours');
  ['hHours','hNotes'].forEach(id=>document.getElementById(id).value='');
  renderAll();
}

function savePart() {
  const part = document.getElementById('pPart').value.trim();
  if (!part) { alert('Enter part name.'); return; }
  const cost = parseFloat(document.getElementById('pCost').value) || 0;
  if (cost <= 0) { alert('Enter a cost greater than $0 to log a purchase.'); return; }
  const data = load();
  const eq = data.equipment.find(e=>e.id===currentEquipId);
  if (!eq) return;
  eq.parts.push({
    id: uid(),
    date: document.getElementById('pDate').value || today(),
    part,
    cost,
    where: document.getElementById('pWhere').value,
    notes: document.getElementById('pNotes').value,
  });
  save(data);
  closeModal('modalPart');
  ['pPart','pCost','pWhere','pNotes'].forEach(id=>document.getElementById(id).value='');
  renderAll();
}

function deleteCurrentEquipment() {
  const data = load();
  const eq = data.equipment.find(e=>e.id===currentEquipId);
  if (!eq || !confirm(`Delete "${eq.name}"? This cannot be undone.`)) return;
  data.equipment = data.equipment.filter(e=>e.id!==currentEquipId);
  save(data);
  currentEquipId = null;
  document.getElementById('detailPanel').classList.remove('visible');
  renderAll();
}

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('visible'); });
});

// ---------- PWA / Service Worker ----------
let _pwaInstallPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  _pwaInstallPrompt = e;
  const btn = document.getElementById('pwaInstallBtn');
  if (btn) btn.style.display = 'inline-block';
});

window.addEventListener('appinstalled', () => {
  const btn = document.getElementById('pwaInstallBtn');
  if (btn) btn.style.display = 'none';
  _pwaInstallPrompt = null;
});

function installPWA() {
  if (!_pwaInstallPrompt) {
    alert('To install on iOS: tap the Share button (‚ñ°‚Üë) in Safari, then "Add to Home Screen".');
    return;
  }
  _pwaInstallPrompt.prompt();
  _pwaInstallPrompt.userChoice.then(() => { _pwaInstallPrompt = null; });
}

// ---------- Inline Manifest ----------
(function() {
  const manifest = {
    name: "Shively's GearLog",
    short_name: "GearLog",
    description: "Gas-Powered Lawn Equipment Tracker",
    start_url: "./",
    display: "standalone",
    background_color: "#0a0e0a",
    theme_color: "#0a0e0a",
    orientation: "any",
    icons: [
      { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='24' fill='%230a0e0a'/%3E%3Ctext x='96' y='135' font-size='110' text-anchor='middle'%3E%E2%9A%99%EF%B8%8F%3C/text%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml", purpose: "any maskable" },
      { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='64' fill='%230a0e0a'/%3E%3Ctext x='256' y='360' font-size='300' text-anchor='middle'%3E%E2%9A%99%EF%B8%8F%3C/text%3E%3C/svg%3E", sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
  document.querySelector('link[rel="manifest"]').href = URL.createObjectURL(blob);
})();

// ---------- Inline Service Worker ----------
if ('serviceWorker' in navigator) {
  const swCode = `
const CACHE = 'gearlog-v1';
self.addEventListener('install', () => self.skipWaiting());
self.addEventListener('activate', e => {
  e.waitUntil(caches.keys().then(keys =>
    Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
  ).then(() => self.clients.claim()));
});
self.addEventListener('fetch', e => {
  if (e.request.url.startsWith(self.location.origin)) {
    e.respondWith(
      caches.open(CACHE).then(cache =>
        fetch(e.request)
          .then(res => { cache.put(e.request, res.clone()); return res; })
          .catch(() => cache.match(e.request))
      )
    );
  }
});
  `;
  const swBlob = new Blob([swCode], {type: 'application/javascript'});
  const swUrl = URL.createObjectURL(swBlob);
  window.addEventListener('load', () => {
    navigator.serviceWorker.register(swUrl)
      .then(() => console.log('[GearLog] SW registered'))
      .catch(err => console.warn('[GearLog] SW failed:', err));
  });
}

// ---------- Init ----------
// Save a seed snapshot on first load if one doesn't exist yet (handles existing installs)
(function ensureSeedSnapshot() {
  const SEED_VERSION = '2026-02-19';
  // If snapshot exists and is current version, skip
  if (localStorage.getItem('gearlog_seed_snapshot') &&
      localStorage.getItem('gearlog_seed_version') === SEED_VERSION) return;
  // Build fresh snapshot from hardcoded seed by temporarily running seedDemo logic
  // For existing installs with data, we need the canonical names from the code not from localStorage.
  // SeedDemo won't run (data already exists), so we force-save the snapshot here using
  // the correct names that are in the current deployed code.
  // The easiest way: clear the snapshot, let seedDemo rebuild it on next fresh load.
  // For now on existing installs, we flag it needs updating and prompt on reset.
  localStorage.setItem('gearlog_seed_version', SEED_VERSION);
  if (!localStorage.getItem('gearlog_seed_snapshot')) {
    const data = load();
    if (!data.equipment.length) return;
    const snap = data.equipment.map(e => ({
      id: e.id, name: e.name, type: e.type, year: e.year, engine: e.engine,
      serial: e.serial, purchaseDate: e.purchaseDate, oilInterval: e.oilInterval,
      trackHours: e.trackHours, notes: e.notes,
      parts: e.parts.filter(p => (parseFloat(p.cost)||0) === 0),
      maintenance: [], hours: [], totalHours: 0
    }));
    localStorage.setItem('gearlog_seed_snapshot', JSON.stringify(snap));
  }
})();
renderAll();

// ============================================================
// F6 ‚Äî PHOTO ATTACHMENT
// ============================================================
let pendingMaintPhoto = null;

function previewMaintPhoto(input) {
  if (!input.files || !input.files[0]) return;
  const file = input.files[0];
  const reader = new FileReader();
  reader.onload = e => {
    pendingMaintPhoto = e.target.result;
    document.getElementById('mPhotoName').textContent = file.name;
    document.getElementById('mPhotoImg').src = e.target.result;
    document.getElementById('mPhotoPreview').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

function clearMaintPhoto() {
  pendingMaintPhoto = null;
  document.getElementById('mPhoto').value = '';
  document.getElementById('mPhotoName').textContent = 'No photo';
  document.getElementById('mPhotoPreview').style.display = 'none';
  document.getElementById('mPhotoImg').src = '';
}

// ============================================================
// F7 ‚Äî QR CODE LABELS
// Uses qrcodejs loaded inline via CDN
// ============================================================
function renderQrTab() {
  if (!currentEquipId) return;
  const data = load();
  const eq = data.equipment.find(e => e.id === currentEquipId);
  if (!eq) return;

  const baseUrl = window.location.origin + window.location.pathname;
  const url = baseUrl + '?equipment=' + encodeURIComponent(currentEquipId);

  const container = document.getElementById('qrCanvas');
  container.innerHTML = '';

  // Dynamically load qrcode.js if not already loaded
  function generateQr() {
    new QRCode(container, {
      text: url,
      width: 200,
      height: 200,
      colorDark: '#1a1a1a',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.M
    });
  }

  if (typeof QRCode === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
    script.onload = generateQr;
    document.head.appendChild(script);
  } else {
    generateQr();
  }

  document.getElementById('qrLabel').innerHTML = `
    <div style="font-family:var(--font-head);font-weight:700;font-size:1rem;margin-bottom:4px">${getIcon(eq.type)} ${eq.name}</div>
    <div style="font-family:var(--font-mono);font-size:0.72rem;color:var(--text-muted)">${eq.engine || ''}</div>
    ${eq.serial ? `<div style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted);margin-top:2px">S/N: ${eq.serial}</div>` : ''}
  `;
}

function printQrLabel() {
  if (!currentEquipId) return;
  const data = load();
  const eq = data.equipment.find(e => e.id === currentEquipId);
  const qrCanvas = document.getElementById('qrCanvas');
  const img = qrCanvas.querySelector('img') || qrCanvas.querySelector('canvas');
  if (!img) return;

  const imgSrc = img.tagName === 'CANVAS' ? img.toDataURL() : img.src;
  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html><html><head><title>GearLog Label ‚Äî ${eq.name}</title>
  <style>
    body { font-family: system-ui, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: #f5f5f5; }
    .label { background: white; border: 2px solid #333; border-radius: 12px; padding: 20px 24px; text-align: center; width: 260px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); }
    .label img { width: 180px; height: 180px; }
    .name { font-weight: 700; font-size: 1.05rem; margin: 10px 0 2px; }
    .sub { font-size: 0.78rem; color: #666; font-family: monospace; }
    .brand { font-size: 0.7rem; color: #e05c00; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; margin-top: 10px; }
  </style></head><body>
  <div class="label">
    <div class="brand">GearLog</div>
    <img src="${imgSrc}">
    <div class="name">${eq.name}</div>
    <div class="sub">${eq.engine || ''}</div>
    ${eq.serial ? `<div class="sub">S/N: ${eq.serial}</div>` : ''}
  </div>
  <script>window.onload = () => { window.print(); }<\/script>
  </body></html>`);
  win.document.close();
}

// ============================================================
// F1 ‚Äî SERVICE HISTORY TIMELINE
// ============================================================
function renderHistory() {
  const data = load();
  const el = document.getElementById('historyContent');
  if (!el) return;

  // Populate equipment filter dropdown
  const equipSelect = document.getElementById('historyEquipFilter');
  const currentEquipVal = equipSelect.value;
  equipSelect.innerHTML = '<option value="">All Equipment</option>' +
    data.equipment.map(e => `<option value="${e.id}" ${currentEquipVal === e.id ? 'selected' : ''}>${e.name}</option>`).join('');

  const equipFilter = equipSelect.value;
  const typeFilter = document.getElementById('historyTypeFilter').value;

  // Gather all events
  let events = [];
  data.equipment.forEach(eq => {
    if (equipFilter && eq.id !== equipFilter) return;
    eq.maintenance.forEach(m => {
      if (typeFilter && typeFilter !== 'maintenance') return;
      events.push({
        date: m.date,
        equipId: eq.id,
        equipName: eq.name,
        equipType: eq.type,
        kind: 'maintenance',
        icon: 'üîß',
        label: m.type,
        notes: m.notes,
        photo: m.photo || null,
        id: m.id,
      });
    });
    eq.hours.forEach(h => {
      if (typeFilter && typeFilter !== 'hours') return;
      events.push({
        date: h.date,
        equipId: eq.id,
        equipName: eq.name,
        equipType: eq.type,
        kind: 'hours',
        icon: '‚è±',
        label: `+${h.hours} hrs`,
        notes: h.notes,
        photo: null,
        id: h.id,
      });
    });
    eq.parts.forEach(p => {
      if ((parseFloat(p.cost) || 0) === 0) return; // ref parts only, skip
      if (typeFilter && typeFilter !== 'part') return;
      events.push({
        date: p.date || '',
        equipId: eq.id,
        equipName: eq.name,
        equipType: eq.type,
        kind: 'part',
        icon: 'üõí',
        label: p.part,
        notes: p.cost ? '$' + parseFloat(p.cost).toFixed(2) : '',
        photo: null,
        id: p.id,
      });
    });
  });

  // Sort newest first, filter out entries without dates
  events = events.filter(e => e.date).sort((a,b) => b.date.localeCompare(a.date));

  document.getElementById('historyCount').textContent = events.length + ' event' + (events.length !== 1 ? 's' : '');

  if (!events.length) {
    el.innerHTML = '<div style="text-align:center;padding:48px;color:var(--text-muted)">No history found.</div>';
    return;
  }

  // Group by date
  const byDate = {};
  events.forEach(e => {
    if (!byDate[e.date]) byDate[e.date] = [];
    byDate[e.date].push(e);
  });

  const kindColors = {
    maintenance: 'var(--green-dim)',
    hours: 'var(--amber)',
    part: 'var(--orange)',
  };
  const kindBg = {
    maintenance: 'rgba(74,222,128,0.08)',
    hours: 'var(--amber-pale)',
    part: 'rgba(255,107,26,0.08)',
  };

  let html = '';
  Object.entries(byDate).forEach(([date, dayEvents]) => {
    html += `<div style="margin-bottom:22px">
      <div style="font-family:var(--font-mono);font-size:0.75rem;font-weight:700;color:var(--text-muted);letter-spacing:0.06em;text-transform:uppercase;padding:4px 0 10px;border-bottom:1px solid var(--border);margin-bottom:10px">${fmtDate(date)}</div>`;
    dayEvents.forEach(ev => {
      html += `<div style="display:flex;gap:12px;align-items:flex-start;padding:10px 14px;background:${kindBg[ev.kind]};border:1px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:pointer" onclick="selectEquipment('${ev.equipId}')">
        <div style="font-size:1.3rem;flex-shrink:0;margin-top:1px">${ev.icon}</div>
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <span style="font-family:var(--font-head);font-weight:700;font-size:0.9rem">${ev.label}</span>
            <span style="font-size:0.72rem;background:${kindColors[ev.kind]};color:white;border-radius:10px;padding:1px 8px;opacity:0.85">${ev.kind}</span>
          </div>
          <div style="font-size:0.8rem;color:var(--text-muted);margin-top:2px">${getIcon(ev.equipType)} ${ev.equipName}</div>
          ${ev.notes ? `<div style="font-size:0.8rem;color:var(--text-light);margin-top:3px">${ev.notes}</div>` : ''}
          ${ev.photo ? `<img src="${ev.photo}" onclick="event.stopPropagation();this.style.maxHeight=this.style.maxHeight?'':'400px'" style="max-height:60px;max-width:160px;border-radius:6px;cursor:pointer;margin-top:8px;border:1px solid var(--border);transition:max-height 0.3s" title="Click to expand">` : ''}
        </div>
      </div>`;
    });
    html += '</div>';
  });

  el.innerHTML = html;
}

</script>

<!-- Kit Upgrade Prompt Modal -->
<div class="modal-overlay" id="modalKitPrompt" style="z-index:1100">
  <div class="modal" style="max-width:420px">
    <div class="modal-header" style="background:var(--amber-pale);border-bottom:2px solid var(--amber)">
      <h3 style="color:var(--amber)">üõí Kit Available</h3>
      <button class="modal-close" onclick="dismissKitPrompt()">‚úï</button>
    </div>
    <div class="modal-body" id="kitPromptBody" style="padding:20px 24px">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="dismissKitPrompt()">No, keep individual parts</button>
      <button class="btn btn-primary" id="kitPromptYes" onclick="switchToKit()" style="background:var(--amber);border-color:var(--amber)">Yes, switch to kit</button>
    </div>
  </div>
</div>

</body>
</html>
